<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.ChainDB.Impl.Background</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Launch background tasks</a></li><li><a href="#g:2">Copying blocks from the VolatileDB to the ImmutableDB</a></li><li><a href="#g:3">Executing garbage collection</a></li><li><a href="#g:4">Scheduling garbage collections</a></li><li><a href="#g:5">Adding blocks to the ChainDB</a></li><li><a href="#g:6">Executing scheduled chain selections</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Background tasks:</p><ul><li>Copying blocks from the VolatileDB to the ImmutableDB</li><li>Performing and scheduling garbage collections on the VolatileDB</li><li>Writing snapshots of the LedgerDB to disk and deleting old ones</li><li>Executing scheduled chain selections</li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:launchBgTasks">launchBgTasks</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; m ()</li><li class="src short"><a href="#v:copyToImmDB">copyToImmDB</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk), <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a>)</li><li class="src short"><a href="#v:copyAndSnapshotRunner">copyAndSnapshotRunner</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk)) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a> &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li><li class="src short"><a href="#v:updateLedgerSnapshots">updateLedgerSnapshots</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m ()</li><li class="src short"><a href="#v:garbageCollect">garbageCollect</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ()</li><li class="src short"><span class="keyword">data</span> <a href="#t:GcSchedule">GcSchedule</a> m</li><li class="src short"><a href="#v:newGcSchedule">newGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m)</li><li class="src short"><a href="#v:scheduleGC">scheduleGC</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceGCEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceGCEvent</a> blk) &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a> &#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; m ()</li><li class="src short"><a href="#v:gcScheduleRunner">gcScheduleRunner</a> &#8759; &#8704; m. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m &#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ()) &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li><li class="src short"><a href="#v:addBlockRunner">addBlockRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></li><li class="src short"><a href="#v:scheduledChainSelection">scheduledChainSelection</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ()</li><li class="src short"><a href="#v:scheduledChainSelectionRunner">scheduledChainSelectionRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (m ())</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Launch background tasks</h1></a><div class="top"><p class="src"><a id="v:launchBgTasks" class="def">launchBgTasks</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks" class="link">Source</a> <a href="#v:launchBgTasks" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a></td><td class="doc"><p>Number of immutable blocks replayed on ledger DB startup</p></td></tr><tr><td class="src">&#8594; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div></div><a href="#g:2" id="g:2"><h1>Copying blocks from the VolatileDB to the ImmutableDB</h1></a><div class="top"><p class="src"><a id="v:copyToImmDB" class="def">copyToImmDB</a> &#8759; &#8704; m blk. (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk), <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (<a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/Cardano-Slotting-Slot.html#t:WithOrigin" title="Cardano.Slotting.Slot">WithOrigin</a> <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a>) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmDB" class="link">Source</a> <a href="#v:copyToImmDB" class="selflink">#</a></p><div class="doc"><p>Copy the blocks older than <code>k</code> from the VolatileDB to the ImmutableDB.</p><p>These headers of these blocks can be retrieved by dropping the <code>k</code> most
 recent blocks from the fragment stored in <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbChain" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbChain</a></code>.</p><p>The copied blocks are removed from the fragment stored in <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbChain" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbChain</a></code>.</p><p>This function does not remove blocks from the VolatileDB.</p><p>The <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> of the tip of the ImmutableDB after copying the blocks is
 returned. This can be used for a garbage collection on the VolatileDB.</p><p>NOTE: this function would not be safe when called multiple times
 concurrently. To enforce thread-safety, a lock is obtained at the start of
 this function and released at the end. So in practice, this function can be
 called multiple times concurrently, but the calls will be serialised.</p><p>NOTE: this function <em>can</em> run concurrently with all other functions, just
 not with itself.</p></div></div><div class="top"><p class="src"><a id="v:copyAndSnapshotRunner" class="def">copyAndSnapshotRunner</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyAndSnapshotRunner" class="link">Source</a> <a href="#v:copyAndSnapshotRunner" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Protocol-Abstract.html#t:ConsensusProtocol" title="Ouroboros.Consensus.Protocol.Abstract">ConsensusProtocol</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:BlockProtocol" title="Ouroboros.Consensus.Block.Abstract">BlockProtocol</a> blk), <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> blk, <a href="Ouroboros-Consensus-Block-Abstract.html#t:GetHeader" title="Ouroboros.Consensus.Block.Abstract">GetHeader</a> blk, <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/ouroboros-network-0.1.0.0/noopt/doc/html/ouroboros-network/Ouroboros-Network-Block.html#t:HasHeader" title="Ouroboros.Network.Block">HasHeader</a> (<a href="Ouroboros-Consensus-Block-Abstract.html#t:Header" title="Ouroboros.Consensus.Block.Abstract">Header</a> blk))</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Word.html#t:Word64" title="Data.Word">Word64</a></td><td class="doc"><p>Number of immutable blocks replayed on ledger DB startup</p></td></tr><tr><td class="src">&#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Copy blocks from the VolDB to ImmDB and take snapshots of the LgrDB</p><p>We watch the chain for changes. Whenever the chain is longer than <code>k</code>, then
 the headers older than <code>k</code> are copied from the VolDB to the ImmDB (using
 <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:copyToImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">copyToImmDB</a></code>). Once that is complete,</p><ul><li>We periodically take a snapshot of the LgrDB (depending on its config).
   NOTE: This implies we do not take a snapshot of the LgrDB if the chain
   hasn't changed, irrespective of the LgrDB policy.</li><li>Schedule GC of the VolDB (<code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduleGC" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduleGC</a></code>) for the <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> of the most
   recent block that was copied.</li></ul><p>It is important that we only take LgrDB snapshots when are are <em>sure</em> they
 have been copied to the ImmDB, since the LgrDB assumes that all snapshots
 correspond to immutable blocks. (Of course, data corruption can occur and we
 can handle it by reverting to an older LgrDB snapshot, but we should need
 this only in exceptional circumstances.)</p><p>We do not store any state of the VolDB GC. If the node shuts down before GC
 can happen, when we restart the node and schedule the <em>next</em> GC, it will
 <em>imply</em> any previously scheduled GC, since GC is driven by slot number
 (&quot;garbage collect anything older than <code>x</code>&quot;).</p></div></div><div class="top"><p class="src"><a id="v:updateLedgerSnapshots" class="def">updateLedgerSnapshots</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots" class="link">Source</a> <a href="#v:updateLedgerSnapshots" class="selflink">#</a></p><div class="doc"><p>Write a snapshot of the LedgerDB to disk and remove old snapshots
 (typically one) so that only <code>onDiskNumSnapshots</code> snapshots are on disk.</p></div></div><a href="#g:3" id="g:3"><h1>Executing garbage collection</h1></a><div class="top"><p class="src"><a id="v:garbageCollect" class="def">garbageCollect</a> &#8759; &#8704; m blk. <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m () <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect" class="link">Source</a> <a href="#v:garbageCollect" class="selflink">#</a></p><div class="doc"><p>Trigger a garbage collection for blocks older than the given <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code> on
 the VolatileDB.</p><p>Also removes the corresponding cached &quot;previously applied points&quot; from the
 LedgerDB.</p><p>This is thread-safe as the VolatileDB locks itself while performing a GC.</p><p>TODO will a long GC be a bottleneck? It will block any other calls to
 <code>putBlock</code> and <code>getBlock</code>.</p></div></div><a href="#g:4" id="g:4"><h1>Scheduling garbage collections</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:GcSchedule" class="def">GcSchedule</a> m <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#GcSchedule" class="link">Source</a> <a href="#t:GcSchedule" class="selflink">#</a></p><div class="doc"><p>A scheduled garbage collections.</p><p>Represented as a queue.</p><p>The background thread will continuously try to pop the first element of the
 queue. Whenever it manages to pop a <code>(<code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code>, <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code>)</code> off: it first
 waits until the <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code> is passed (using <code><a href="Ouroboros-Consensus-Util-IOLike.html#v:threadDelay" title="Ouroboros.Consensus.Util.IOLike">threadDelay</a></code> with the given <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code>
 minus the current <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code>) and then performs a garbage collection with the
 given <code><a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></code>.</p><p>The <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code>s in the queue should be monotonically increasing. A fictional
 example (with hh:mm:ss):</p><pre>[(16:01:12, SlotNo 1012), (16:04:38, SlotNo 1045), ..]</pre><p>By using <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduleGC" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduleGC</a></code>, monotonicity is practically guaranteed for standard
 usage. Theoretically, multiple concurrent calls to <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduleGC" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduleGC</a></code> might
 violate it, but this won't happen in practice, as it would mean that
 multiple calls to <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:copyToImmDB" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">copyToImmDB</a></code> (which cannot run concurrent with itself)
 have finished very short after each other. Even then, the differences will
 be ignorable (&lt;1s), and actually won't matter at all, as garbage collection
 timing doesn't have to be precise. In fact, it is exactly the goal to
 introduce a delay between copying blocks from the ImmutableDB to the
 VolatileDB and garbage-collecting them from the VolatileDB.</p><p>If a <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code> <code>t</code> in the queue <em>is</em> earlier than the <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code> <code>t'</code> before it in
 the queue, then the GC scheduled for <code>t</code> will simply be executed at <code>t'</code>.</p><p>All this combined means that a garbage collection scheduled at <code><a href="Ouroboros-Consensus-Util-IOLike.html#t:Time" title="Ouroboros.Consensus.Util.IOLike">Time</a></code> <code>t</code>
 will be performed at <code>t</code> <em>or</em> later (but never earlier), with no hard
 guarantees about how much later.</p><p>How long will this queue be in practice?</p><p>If we say a block is produced every 20 seconds, then a new GC is scheduled
 every 20 seconds. Ignoring start-up, the queue will then be <code>delay / 20s</code>
 entries long. For example, if the delay is 1h, then the queue will be 180
 entries long, which is acceptable.</p><p>In Praos, the slot length decreases, but the number of blocks produced (per
 time) will remain the same as the density decreases too (more slots, but
 many of them empty), hence the queue queue length will also remain the
 same.</p></div></div><div class="top"><p class="src"><a id="v:newGcSchedule" class="def">newGcSchedule</a> &#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m &#8658; m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#newGcSchedule" class="link">Source</a> <a href="#v:newGcSchedule" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:scheduleGC" class="def">scheduleGC</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduleGC" class="link">Source</a> <a href="#v:scheduleGC" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:TraceGCEvent" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">TraceGCEvent</a> blk)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></td><td class="doc"><p>The slot to use for garbage collection</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Util-IOLike.html#t:DiffTime" title="Ouroboros.Consensus.Util.IOLike">DiffTime</a></td><td class="doc"><p>How long to wait until performing the GC</p></td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a id="v:gcScheduleRunner" class="def">gcScheduleRunner</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#gcScheduleRunner" class="link">Source</a> <a href="#v:gcScheduleRunner" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#t:GcSchedule" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">GcSchedule</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; (<a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a> &#8594; m ())</td><td class="doc"><p>GC function</p></td></tr><tr><td class="src">&#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><a href="#g:5" id="g:5"><h1>Adding blocks to the ChainDB</h1></a><div class="top"><p class="src"><a id="v:addBlockRunner" class="def">addBlockRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Void.html#t:Void" title="Data.Void">Void</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner" class="link">Source</a> <a href="#v:addBlockRunner" class="selflink">#</a></p><div class="doc"><p>Read blocks from <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbBlocksToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbBlocksToAdd</a></code> and add them synchronously to the
 ChainDB.</p></div></div><a href="#g:6" id="g:6"><h1>Executing scheduled chain selections</h1></a><div class="top"><p class="src"><a id="v:scheduledChainSelection" class="def">scheduledChainSelection</a> <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduledChainSelection" class="link">Source</a> <a href="#v:scheduledChainSelection" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">&#8594; <a href="Ouroboros-Consensus-Storage-ImmutableDB-Types.html#t:SlotNo" title="Ouroboros.Consensus.Storage.ImmutableDB.Types">SlotNo</a></td><td class="doc"><p>The current slot</p></td></tr><tr><td class="src">&#8594; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Retrieve the <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:FutureBlockToAdd" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">FutureBlockToAdd</a></code>s from <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#v:cdbFutureBlocks" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">cdbFutureBlocks</a></code> for which chain
 selection was scheduled at the current slot. Run chain selection for each
 of them.</p></div></div><div class="top"><p class="src"><a id="v:scheduledChainSelectionRunner" class="def">scheduledChainSelectionRunner</a> &#8759; (<a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="Ouroboros-Consensus-Ledger-SupportsProtocol.html#t:LedgerSupportsProtocol" title="Ouroboros.Consensus.Ledger.SupportsProtocol">LedgerSupportsProtocol</a> blk, <a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>) &#8658; <a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Types.html#t:ChainDbEnv" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Types">ChainDbEnv</a> m blk &#8594; m (m ()) <a href="src/Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#scheduledChainSelectionRunner" class="link">Source</a> <a href="#v:scheduledChainSelectionRunner" class="selflink">#</a></p><div class="doc"><p>Whenever the current slot changes, call <code><a href="Ouroboros-Consensus-Storage-ChainDB-Impl-Background.html#v:scheduledChainSelection" title="Ouroboros.Consensus.Storage.ChainDB.Impl.Background">scheduledChainSelection</a></code> for the
 (new) current slot.</p><p>This function forks of a background thread and terminates afterwards,
 returning a handle to kill the background thread.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>