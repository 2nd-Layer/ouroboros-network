<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- | This subsystem manages the discovery and selection of /upstream/ peers.</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.PeerSelection.Governor</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-comment">-- * Design overview</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- $overview</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- * Peer selection governor</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-comment">-- $peer-selection-governor</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePeerSelection"><span class="hs-identifier hs-type">TracePeerSelection</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#peerSelectionGovernor"><span class="hs-identifier hs-var">peerSelectionGovernor</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-comment">-- * Peer churn governor</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-comment">-- $peer-churn-governor</span><span>
</span><a name="line-27"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#peerChurnGovernor"><span class="hs-identifier hs-var">peerChurnGovernor</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#sanePeerSelectionTargets"><span class="hs-identifier hs-var">sanePeerSelectionTargets</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">--TODO: perhaps better to move to Types module</span><span>
</span><a name="line-30"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#nullPeerSelectionTargets"><span class="hs-identifier hs-var">nullPeerSelectionTargets</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Void</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Void</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Min</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alternative</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html"><span class="hs-identifier">Control.Monad.Class.MonadTime</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html"><span class="hs-identifier">Control.Monad.Class.MonadTimer</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html"><span class="hs-identifier">Control.Tracer</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">assert</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.PeerSelection.Types.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.Types</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.KnownPeers</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">KnownPeers</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.KnownPeers</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeers"><span class="hs-identifier hs-type">KnownPeers</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.JobPool</span></a><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">JobPool</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Network.PeerSelection.JobPool.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.JobPool</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.JobPool.html#JobPool"><span class="hs-identifier hs-type">JobPool</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">{- $overview

We have a number of requirements for constructing our connectivity graphs:

 * We must do it in a decentralised way, using only local information;
 * It should avoid and recover from accidental or deliberate partitions or
   eclipse attacks;
 * The graph should give us good performance for block diffusion. This means
   we need the combination of low hop counts, and minimising the hop lengths.
   We want one slot leader to be able to send to the next within the deadline
   in at least 95% of cases.

[\&quot;Small world&quot; graph theory](https://press.princeton.edu/books/paperback/9780691117041/small-worlds)
tells us that we can use random graph construction to make graphs with a low
characteristic path length (i.e. hop count). We can build random graphs with
random gossip techniques. This deals with our requirement for decentralisation
and our goal of low hop counts.

The remaining significant issues are:

 * the goal of short hop lengths, and
 * avoiding and recovering from partitions and eclipse attacks.

Our design is to augment random gossip with two /governors/ (control loops) to
address these two issues. The design is relatively simple, and has the virtue
that the policy for the governors can be adjusted with relatively few
compatibility impacts. This should enable the policy to be optimised based on
real-world feedback, and feedback from simulations of scale or scenarios that
are hard (or undesirable) to test in a real deployment.

Each node maintains three sets of known peer nodes:

 [cold peers]: are peers that are known of but where there is no established
               network connection;

 [warm peers]: are peers where a bearer connection is established but it is used
               only for network measurements and is not used for any application
               level consensus protocols;

 [hot peers]: are peers where the bearer connection is actively used for the
              application level consensus protocols.

Limited information is maintained for these peers, based on previous direct
interactions. For cold nodes this will often be absent as there may have been
no previous direct interactions. This information is comparable with
\&quot;reputation\&quot; in other systems, but it should be emphasised that it is purely
local and not shared with any other node. It is not shared because it is not
necessary and because establishing trust in such information is difficult and
would add additional complexity. The information about peers is kept
persistently across node restarts, but it is always safe to re-bootstrap &#8211; as
new nodes must do.

For an individual node to join the network, the bootstrapping phase starts by
contacting root nodes and requesting sets of other peers. Newly discovered
peers are added to the cold peer set. It proceeds iteratively by randomly
selecting other peers to contact to request more known peers. This gossip
process is controlled by a governor that has a target to find and maintain a
certain number of cold peers. Bootstrapping is not a special mode, rather it is
just a phase for the governor following starting with a cold peers set
consisting only of the root nodes. This gossiping aspect is closely analogous
to the first stage of Kademlia, but with random selection rather than selection
directed towards finding peers in an artificial metric space.

The root nodes used in the bootstrapping phase are the stakepool relays
published in the blockchain as part of the stakepool registration process.
See the [Shelley delegation design specification, Sections 3.4.4 and 4.2](https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/delegationDesignSpec/latest/download-by-type/doc-pdf/delegation_design_spec).
As with Bitcoin, a recent snapshot of this root set must be distributed with
the software.

The peer selection governor engages in the following activities:

 * the random gossip used to discover more cold peers;
 * promotion of cold peers to be warm peers;
 * demotion of warm peers to cold peers;
 * promotion of warm peers to hot peers; and
 * demotion of hot peers to warm peers.

The peer selection governor has these goals to establish and maintain:

 * a target number of cold peers (e.g. 1000)
 * a target number of hot peers (e.g. order of 2&#8211;20)
 * a target number of warm peers (e.g. order of 10&#8211;50)
 * a set of warm peers that are sufficiently diverse in terms of hop distance
 * a target churn frequency for hot\/warm changes
 * a target churn frequency for warm\/cold changes
 * a target churn frequency for cold\/unknown changes

The target churn values are adjusted by the /peer churn governor/, which we
will discuss below.

Local static configuration can also be used to specify that certain known nodes
should be selected as hot or warm peers. This allows for fixed relationships
between nodes controlled by a single organisation, such as a stake pool with
several relays. It also enables private peering relationships between stake
pool operators and other likely deployment scenarios.

Using 5&#8211;20 hot peers is not as expensive as it might sound. Keep in mind that
only block headers are sent for each peer. The block body is typically only
requested once. It is also worth noting that the block body will tend to follow
the shortest paths through the connectivity graph formed by the hot peer links.
This is because nodes will typically request the block body from the first node
that sends the block header.

While the purpose of cold and hot peers is clear, the purpose of warm peers
requires further explanation. The primary purpose is to address the challenge
of avoiding too many long hops in the graph. The random gossip is oblivious to
hop distance. By actually connecting to a selection of peers and measuring the
round trip delays we can start to establish which peers are near or far. The
policy for selecting which warm peers to promote to hot peers will take into
account this network hop distance. The purpose of a degree of churn between
cold and warm peers is, in part, to discover the network distance for more
peers and enable further optimisation or adjust to changing conditions. The
purpose of a degree of churn between warm and hot peers is to allow potentially
better warm peers to take over from existing hot peers.

The purpose in maintaining a diversity in hop distances is to assist in
recovery from network events that may disrupt established short paths, such as
internet routing changes, partial loss of connectivity, or accidental formation
of cliques. For example, when a physical infrastructure failure causes the
short paths to a clique of nodes to be lost, if some or all of the nodes in
that clique maintain other longer distance warm links then they can quickly
promote them to hot links and recover. The time to promote from warm to hot
need be no more than one network round trip.

Overall, this approach follows a common pattern for probabilistic search or
optimisation that uses a balance of local optimisation with some elements of
higher order disruption to avoid becoming trapped in some poor local optimum.

The local peer reputation information is also updated when peer connections
fail. The implementation classifies the exceptions that cause connections to
fail into three classes:

 * internal node exceptions e.g. local disk corruption;
 * network failures e.g. dropped TCP connections; and
 * adversarial behaviour, e.g. a protocol violation detected by the
   typed-protocols layer or by the consensus layer.

In the case of adversarial behaviour the peer can be immediately demoted out of
the hot, warm and cold sets. We choose not to maintain negative peer
information for extended periods of time; to bound resources and due to the
simplicity of Sybil attacks.

The peer churn governor deals with the problem of partition and eclipse &#8211;
whether malicious or accidental. It adjusts the behaviour of the peer
selection governor over longer time scales. The outer peer churn governor's
actions are:

 * to adjust the target churn frequencies of the peer selection governor for
   promotion\/demotion between the cold\/warm\/hot states
 * partial or total re-bootstrapping under certain circumstances

The peer churn governor monitors the chain growth quality, comparing it with
the stake distribution. The probability of being in a disconnected clique or
being eclipsed is calculated. As this rises the governor increases the target
frequencies for the churn between the hot, warm, cold, and unknown states. In
the worst case it can re-bootstrap the peer discovery entirely by resetting
the set of known peers.
-}</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-comment">{-

TODO: need to think about managing established connections with upstream/downstream peers in a more symmetric way.

Can we separate that connection management from policy of upstream/downstream selection?

Upstream peers are ones where we choose to talk to them, and we follow their
chain and submit transactions to them. There is a separate subsystem to manage
/downstream/ peers that initiate connections to us.

There is a distinction between which peer chooses to talk to which, and which
peer actually initiates the TCP connection. This is due to the fact that we
reuse TCP connections to run mini-protocols in both directions. So we can
choose to talk to another peer and find that they already initiated a TCP
connection to us, and so we reuse that. For example we can have cases like this:

 1. They initiate the connection to have our node as one of their upstream peers
 2. We decide to reuse the connection to have them as one of our upstream peers
 3. They decide to stop using us as an upstream peer

This is now more or less equivalent to our node having initiated the connection
in the first place because we chose to have them as an upstream peer.


-}</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">{- $peer-selection-governor

![A 19th century steam governor](https://upload.wikimedia.org/wikipedia/commons/c/c3/Centrifugal_governor_and_balanced_steam_valve_%28New_Catechism_of_the_Steam_Engine%2C_1904%29.jpg)

The 'peerSelectionGovernor' manages the discovery and selection of /upstream/
peers.

We classify (potential or actual) upstream peers in three nested categories:

@
                                                      &#9650;
                                               forget &#9474;
  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9535;&#9473;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
  &#9475;                                                     &#9474; discover   &#9475;
  &#9475;  Known peers: the set of all known peers.           &#9660;            &#9475;
  &#9475;  Consists of cold, warm and hot peers.                           &#9475;
  &#9475;  Expect ~1000                              demote &#9650;              &#9475;
  &#9475;                                            to cold&#9474;              &#9475;
  &#9475; &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9535;&#9473;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491; &#9475;
  &#9475; &#9475;                                                   &#9474; promote  &#9475; &#9475;
  &#9475; &#9475;  Established peers: with established bearer.      &#9660; to warm  &#9475; &#9475;
  &#9475; &#9475;  Consists of warm and hot peers.                             &#9475; &#9475;
  &#9475; &#9475;  Expect ~10-50                           demote &#9650;            &#9475; &#9475;
  &#9475; &#9475;                                          to warm&#9474;            &#9475; &#9475;
  &#9475; &#9475; &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9535;&#9473;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491; &#9475; &#9475;
  &#9475; &#9475; &#9475;                                                 &#9474; promote&#9475; &#9475; &#9475;
  &#9475; &#9475; &#9475;  Active peers: running consensus protocols.     &#9660; to hot &#9475; &#9475; &#9475;
  &#9475; &#9475; &#9475;  Consists of hot peers.                                  &#9475; &#9475; &#9475;
  &#9475; &#9475; &#9475;  Expect ~2-20                                            &#9475; &#9475; &#9475;
  &#9475; &#9475; &#9475;                                                          &#9475; &#9475; &#9475;
  &#9475; &#9475; &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499; &#9475; &#9475;
  &#9475; &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499; &#9475;
  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;
@

We define the terms /known/, /established/ and /active/ to be nested sets.
We define the terms /cold/, /warm/ and /hot/ to be disjoint sets. Both
collections of terms are useful. For example there is information wish to
track for all known peers, irrespective of whether they are cold, warm or hot.

So we have six transitions to consider:

 * discover a cold peer
 * promote a cold peer to warm
 * promote a warm peer to hot
 * demote a hot peer to warm
 * demote a warm peer to cold
 * forget a cold peer

We want a design that separates the policy from the mechanism. We must
consider what kinds of policy we might like to express and make sure that
information that the policy needs can be made available.

We will consider each case.

== Discovering cold peers

There are two main mechanisms by which we discover cold peers:

 * Externally supplied peer root set
 * Peer gossip

=== Externally supplied peer root set

There are a few potential sources for root sets:

 * Simulation environment
 * IP address lists from static or dynamic configuration
 * DNS names from static or dynamic configuration
 * IP addresses or DNS names for stake pools registered in the blockchain

Note that none of these sources are fully static except for IP addresses from
static configuration. DNS name to IP address mappings are potentially dynamic.
DNS names can refer to both IPv4 and IPv6 addresses, and to pools of addresses.

In some cases we wish to advertise these root peers to others, and sometimes
we want to keep them private. In particular the deployment for stake pools may
involve keeping the stake pool node itself private, and only advertising
relays.

For an externally supplied peer root set, we divide the problem in two with an
interface where a root set provider is responsible for managing a time-varying
set of addresses, and the peer selection governor observes the time-varying
value. This allows multiple implementations of the root set provider, which
deal with the various sources.

=== Peer gossip

We can ask peers to give us a sample of their set of known peers.

For cold peers we can establish a one-shot connection to ask. For warm peers
we can also ask. We should not ask from the same peer too often. Peers are
expected to return the same set of answers over quite long periods of time.
(This helps peers to distinguish abusive behaviour and reduce the speed with
which the whole network can be mapped.)

So factors we might wish to base our decision on:

 * if we are below the target number of known peers
 * if there are any known peers we have not asked (or attempted to ask)
 * how long since we last asked (so we do not ask too frequently)
 * the known distance of the peer from the root set

This last factor is interesting. Consider what happens if we do a bootstrap
from one root peer. We'll ask it for some more peers and it will give us a
selection. Suppose we pick one of these to get more peers from and it gives us
a similar number of replies. If we now pick the next one randomly from our
combined set we'll have a roughly 50:50 chance of picking from either set.
This approach could quickly lead us into a mostly-depth first exploration of
the graph. But we probably want a more balanced approach between breadth first
and depth first. The traditional ways to do a breadth first or depth first is
to keep a queue or a stack of nodes that have not yet been asked.

Here's another danger: suppose we ask several nodes in parallel but suppose
one gets back to us quicker than all the others. If we are too quick to choose
again then we are giving an advantage to fast peers, and adversaries could
dedicate resources to exploit this to their advantage to get nodes to pick up
more peers from the set supplied by the adversary.

So this suggests that we should not give undue advantage to peers that respond
very quickly, and we should go mostly breadth first, but with a degree of
randomisation.


== Promoting a cold peer to warm

Promoting a cold peer to warm involves establishing a bearer connection. This
is initiated asynchronously and it is either successful or fails after a
timeout.

Once established, we track the connection for the established peer. The
established connection is used later to promote to hot, or to demote back to
cold. It is also used to be notified if the connection fails for any reason.

== Promoting a warm peer to hot

Promoting a warm peer to hot involves sending messages on the established
bearer to switch mode from the network protocol used with warm peers, to the
full set of consensus protocols used for hot peers.

== Demoting a hot peer to warm

If we have more hot peers than our target number (or target range) then we
want to pick one to demote. One policy is to pick randomly. It is likely to be
better to to pick the peer that is in some sense least useful.

One plausible measure of a peer being least useful is based on the following:
for blocks we adopt into our chain, look at which peer(s) received that header
first. A peer that is never first (or very rarely) is one that is likely to be
downstream from us and hence not useful as a choice of upstream peer. A peer
that is normally behind all others, but sometimes (even rarely) is first is
still useful, since it shows it's an upstream connection to some part of the
network where there are active block producers. Consider the case of a relay
in Europe with one connection to Australia: sometimes blocks will be produced
in Australia and so that connection may be first in those cases.

Tracking the necessary information for this policy would require a separate
component that observes the current chain and the peer candidate chains. Using
this information would need access to that shared state. So we should conclude
that the policy should not be pure as it may need access to such changing state.

== Demoting a warm peer to cold


== Forgetting cold peers

We will always forget known peers when the connection is terminated due to
detected adversarial behaviour. The remaining policy decision is which peers
to forget when we have more than our target number of known peers. We will
only select from the known peers that are cold. Warm or hot known peers have
to first be demoted to cold before we consider them to be forgotten.

We want to pick the least useful cold peers to forget. Factors we may wish to
base our decision on include:

 * Number of unsuccessful connection attempts since last successful connection
 * Pseudo-random selection: some degree of randomness can help mitigate
   accidental systematic correlations or some degree of adversarial behaviour.

-}</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span class="hs-keyword">data</span><span> </span><a name="PeerSelectionPolicy"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier">PeerSelectionPolicy</span></a></a><span> </span><a name="local-6989586621679107521"><a href="#local-6989586621679107521"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107522"><a href="#local-6989586621679107522"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PeerSelectionPolicy"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier">PeerSelectionPolicy</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>       </span><a name="policyPickKnownPeersForGossip"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickKnownPeersForGossip"><span class="hs-identifier">policyPickKnownPeersForGossip</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-431"></a><span>       </span><a name="policyPickColdPeersToPromote"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickColdPeersToPromote"><span class="hs-identifier">policyPickColdPeersToPromote</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-432"></a><span>       </span><a name="policyPickWarmPeersToPromote"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickWarmPeersToPromote"><span class="hs-identifier">policyPickWarmPeersToPromote</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-433"></a><span>       </span><a name="policyPickHotPeersToDemote"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickHotPeersToDemote"><span class="hs-identifier">policyPickHotPeersToDemote</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-434"></a><span>       </span><a name="policyPickWarmPeersToDemote"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickWarmPeersToDemote"><span class="hs-identifier">policyPickWarmPeersToDemote</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-435"></a><span>       </span><a name="policyPickColdPeersToForget"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyPickColdPeersToForget"><span class="hs-identifier">policyPickColdPeersToForget</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier hs-type">PickPolicy</span></a><span> </span><a href="#local-6989586621679107521"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107522"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>       </span><a name="policyFindPublicRootTimeout"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyFindPublicRootTimeout"><span class="hs-identifier">policyFindPublicRootTimeout</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">,</span><span>
</span><a name="line-438"></a><span>       </span><a name="policyMaxInProgressGossipReqs"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyMaxInProgressGossipReqs"><span class="hs-identifier">policyMaxInProgressGossipReqs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-439"></a><span>       </span><a name="policyGossipRetryTime"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyGossipRetryTime"><span class="hs-identifier">policyGossipRetryTime</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">,</span><span>
</span><a name="line-440"></a><span>       </span><a name="policyGossipBatchWaitTime"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyGossipBatchWaitTime"><span class="hs-identifier">policyGossipBatchWaitTime</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">,</span><span>
</span><a name="line-441"></a><span>       </span><a name="policyGossipOverallTimeout"><a href="Ouroboros.Network.PeerSelection.Governor.html#policyGossipOverallTimeout"><span class="hs-identifier">policyGossipOverallTimeout</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-442"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-comment">-- | A peer pick policy is an action that picks a subset of elements from a</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- map of peers.</span><span>
</span><a name="line-446"></a><span class="hs-comment">--</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- The pre-condition is that the map of available choices will be non-empty,</span><span>
</span><a name="line-448"></a><span class="hs-comment">-- and the requested number to pick will be strictly positive.</span><span>
</span><a name="line-449"></a><span class="hs-comment">--</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- The post-condition is that the picked set is non-empty but must not be</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- bigger than the requested number.</span><span>
</span><a name="line-452"></a><span class="hs-comment">--</span><span>
</span><a name="line-453"></a><span class="hs-keyword">type</span><span> </span><a name="PickPolicy"><a href="Ouroboros.Network.PeerSelection.Governor.html#PickPolicy"><span class="hs-identifier">PickPolicy</span></a></a><span> </span><a name="local-6989586621679107519"><a href="#local-6989586621679107519"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107520"><a href="#local-6989586621679107520"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107519"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span>
</span><a name="line-454"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-455"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107520"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107519"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-comment">-- | Check pre-conditions and post-conditions on the pick policies</span><span>
</span><a name="line-458"></a><span class="hs-identifier">pickPeers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107604"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679107605"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107604"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107606"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107605"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107604"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>          </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107604"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107606"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107605"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107604"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><a name="pickPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier">pickPeers</span></a></a><span> </span><a name="local-6989586621679107607"><a href="#local-6989586621679107607"><span class="hs-identifier">pick</span></a></a><span> </span><a name="local-6989586621679107608"><a href="#local-6989586621679107608"><span class="hs-identifier">available</span></a></a><span> </span><a name="local-6989586621679107609"><a href="#local-6989586621679107609"><span class="hs-identifier">num</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-462"></a><span>    </span><span class="hs-identifier hs-var">assert</span><span> </span><a href="#local-6989586621679107610"><span class="hs-identifier hs-var">precondition</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679107614"><a href="#local-6989586621679107614"><span class="hs-identifier">picked</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107611"><span class="hs-identifier hs-var">postcondition</span></a><span> </span><a href="#local-6989586621679107614"><span class="hs-identifier hs-var">picked</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679107614"><span class="hs-identifier hs-var">picked</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>         </span><span class="hs-special">(</span><a href="#local-6989586621679107607"><span class="hs-identifier hs-var">pick</span></a><span> </span><a href="#local-6989586621679107608"><span class="hs-identifier hs-var">available</span></a><span> </span><a href="#local-6989586621679107612"><span class="hs-identifier hs-var">numClamped</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-466"></a><span>    </span><a name="local-6989586621679107610"><a href="#local-6989586621679107610"><span class="hs-identifier">precondition</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.null</span><span> </span><a href="#local-6989586621679107608"><span class="hs-identifier hs-var">available</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107609"><span class="hs-identifier hs-var">num</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-467"></a><span>    </span><a name="local-6989586621679107611"><a href="#local-6989586621679107611"><span class="hs-identifier">postcondition</span></a></a><span> </span><a name="local-6989586621679107613"><a href="#local-6989586621679107613"><span class="hs-identifier">picked</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.null</span><span> </span><a href="#local-6989586621679107613"><span class="hs-identifier hs-var">picked</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107613"><span class="hs-identifier hs-var">picked</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107612"><span class="hs-identifier hs-var">numClamped</span></a><span>
</span><a name="line-469"></a><span>                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107613"><span class="hs-identifier hs-var">picked</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107608"><span class="hs-identifier hs-var">available</span></a><span>
</span><a name="line-470"></a><span>    </span><a name="local-6989586621679107612"><a href="#local-6989586621679107612"><span class="hs-identifier">numClamped</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><a href="#local-6989586621679107609"><span class="hs-identifier hs-var">num</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107608"><span class="hs-identifier hs-var">available</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-comment">-- | Adjustable targets for the peer selection mechanism.</span><span>
</span><a name="line-473"></a><span class="hs-comment">--</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- These are used by the peer selection governor as targets. They are used by</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- the peer churn governor loop as knobs to adjust, to influence the peer</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- selection governor.</span><span>
</span><a name="line-477"></a><span class="hs-comment">--</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- The /known/, /established/ and /active/ peer targets are targets both from</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- below and from above: the governor will attempt to grow or shrink the sets</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- to hit these targets.</span><span>
</span><a name="line-481"></a><span class="hs-comment">--</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- Unlike the other targets, the /root/ peer target is \&quot;one sided\&quot;, it is</span><span>
</span><a name="line-483"></a><span class="hs-comment">-- only a target from below. The governor does not try to shrink the root set</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- to hit it, it simply stops looking for more.</span><span>
</span><a name="line-485"></a><span class="hs-comment">--</span><span>
</span><a name="line-486"></a><span class="hs-keyword">data</span><span> </span><a name="PeerSelectionTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier">PeerSelectionTargets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PeerSelectionTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier">PeerSelectionTargets</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>       </span><a name="targetNumberOfRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#targetNumberOfRootPeers"><span class="hs-identifier">targetNumberOfRootPeers</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-489"></a><span>       </span><a name="targetNumberOfKnownPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#targetNumberOfKnownPeers"><span class="hs-identifier">targetNumberOfKnownPeers</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-490"></a><span>       </span><a name="targetNumberOfEstablishedPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#targetNumberOfEstablishedPeers"><span class="hs-identifier">targetNumberOfEstablishedPeers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-491"></a><span>       </span><a name="targetNumberOfActivePeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#targetNumberOfActivePeers"><span class="hs-identifier">targetNumberOfActivePeers</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>       </span><span class="hs-comment">-- Expressed as intervals rather than frequencies</span><span>
</span><a name="line-494"></a><span class="hs-comment">--     targetChurnIntervalKnownPeers       :: !DiffTime,</span><span>
</span><a name="line-495"></a><span class="hs-comment">--     targetChurnIntervalEstablishedPeers :: !DiffTime,</span><span>
</span><a name="line-496"></a><span class="hs-comment">--     targetChurnIntervalActivePeers      :: !DiffTime</span><span>
</span><a name="line-497"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-identifier">nullPeerSelectionTargets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span>
</span><a name="line-501"></a><a name="nullPeerSelectionTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#nullPeerSelectionTargets"><span class="hs-identifier">nullPeerSelectionTargets</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-502"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-503"></a><span>       </span><span class="hs-identifier">targetNumberOfRootPeers</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-504"></a><span>       </span><span class="hs-identifier">targetNumberOfKnownPeers</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-505"></a><span>       </span><span class="hs-identifier">targetNumberOfEstablishedPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-506"></a><span>       </span><span class="hs-identifier">targetNumberOfActivePeers</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-507"></a><span class="hs-comment">--     targetChurnIntervalKnownPeers       = 0,</span><span>
</span><a name="line-508"></a><span class="hs-comment">--     targetChurnIntervalEstablishedPeers = 0,</span><span>
</span><a name="line-509"></a><span class="hs-comment">--     targetChurnIntervalActivePeers      = 0</span><span>
</span><a name="line-510"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-identifier">sanePeerSelectionTargets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-513"></a><a name="sanePeerSelectionTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#sanePeerSelectionTargets"><span class="hs-identifier">sanePeerSelectionTargets</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-514"></a><span>                                 </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107618"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-515"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107618"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>      </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107617"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-516"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107617"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107616"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-517"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>      </span><a href="#local-6989586621679107615"><span class="hs-identifier hs-var">targetNumberOfRootPeers</span></a><span>   </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107616"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-518"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679107615"><span class="hs-identifier hs-var">targetNumberOfRootPeers</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107618"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>      </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">100</span><span>
</span><a name="line-521"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107617"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">1000</span><span>
</span><a name="line-522"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107616"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>       </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">10000</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-comment">-- | Actions performed by the peer selection governor.</span><span>
</span><a name="line-526"></a><span class="hs-comment">--</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- These being pluggable allows:</span><span>
</span><a name="line-528"></a><span class="hs-comment">--</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- * choice of known peer root sets</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- * running both in simulation and for real</span><span>
</span><a name="line-531"></a><span class="hs-comment">--</span><span>
</span><a name="line-532"></a><span class="hs-keyword">data</span><span> </span><a name="PeerSelectionActions"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier">PeerSelectionActions</span></a></a><span> </span><a name="local-6989586621679107516"><a href="#local-6989586621679107516"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107517"><a href="#local-6989586621679107517"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107518"><a href="#local-6989586621679107518"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PeerSelectionActions"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier">PeerSelectionActions</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>       </span><a name="readPeerSelectionTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#readPeerSelectionTargets"><span class="hs-identifier">readPeerSelectionTargets</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span class="hs-special">,</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>       </span><span class="hs-comment">-- | Read the current set of locally or privately known root peers.</span><span>
</span><a name="line-537"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-538"></a><span>       </span><span class="hs-comment">-- In general this is expected to be updated asynchronously by some</span><span>
</span><a name="line-539"></a><span>       </span><span class="hs-comment">-- other thread. It is intended to cover the use case of peers from</span><span>
</span><a name="line-540"></a><span>       </span><span class="hs-comment">-- local configuration. It could be dynamic due to DNS resolution, or</span><span>
</span><a name="line-541"></a><span>       </span><span class="hs-comment">-- due to dynamic configuration updates.</span><span>
</span><a name="line-542"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-543"></a><span>       </span><a name="readLocalRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#readLocalRootPeers"><span class="hs-identifier">readLocalRootPeers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107516"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerAdvertise"><span class="hs-identifier hs-type">PeerAdvertise</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>       </span><span class="hs-comment">-- | Request a sample of public root peers.</span><span>
</span><a name="line-546"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-547"></a><span>       </span><span class="hs-comment">-- It is intended to cover use cases including:</span><span>
</span><a name="line-548"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-549"></a><span>       </span><span class="hs-comment">-- * federated relays from a DNS pool</span><span>
</span><a name="line-550"></a><span>       </span><span class="hs-comment">-- * stake pool relays published in the blockchain</span><span>
</span><a name="line-551"></a><span>       </span><span class="hs-comment">-- * a pre-distributed snapshot of stake pool relays from the blockchain</span><span>
</span><a name="line-552"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-553"></a><span>       </span><a name="requestPublicRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#requestPublicRootPeers"><span class="hs-identifier">requestPublicRootPeers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107516"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>       </span><span class="hs-comment">-- | The action to contact a known peer and request a sample of its</span><span>
</span><a name="line-556"></a><span>       </span><span class="hs-comment">-- known peers.</span><span>
</span><a name="line-557"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-558"></a><span>       </span><span class="hs-comment">-- This is synchronous, but it should expect to be interrupted by a</span><span>
</span><a name="line-559"></a><span>       </span><span class="hs-comment">-- timeout asynchronous exception. Failures are throw as exceptions.</span><span>
</span><a name="line-560"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-561"></a><span>       </span><a name="requestPeerGossip"><a href="Ouroboros.Network.PeerSelection.Governor.html#requestPeerGossip"><span class="hs-identifier">requestPeerGossip</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107516"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107516"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>       </span><a name="establishPeerConnection"><a href="Ouroboros.Network.PeerSelection.Governor.html#establishPeerConnection"><span class="hs-identifier">establishPeerConnection</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107516"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107517"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">,</span><span>
</span><a name="line-564"></a><span>       </span><a name="monitorPeerConnection"><a href="Ouroboros.Network.PeerSelection.Governor.html#monitorPeerConnection"><span class="hs-identifier">monitorPeerConnection</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107517"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span class="hs-special">,</span><span>
</span><a name="line-565"></a><span>       </span><a name="activatePeerConnection"><a href="Ouroboros.Network.PeerSelection.Governor.html#activatePeerConnection"><span class="hs-identifier">activatePeerConnection</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107517"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-566"></a><span>       </span><a name="deactivatePeerConnection"><a href="Ouroboros.Network.PeerSelection.Governor.html#deactivatePeerConnection"><span class="hs-identifier">deactivatePeerConnection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107517"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-567"></a><span>       </span><a name="closePeerConnection"><a href="Ouroboros.Network.PeerSelection.Governor.html#closePeerConnection"><span class="hs-identifier">closePeerConnection</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107517"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107518"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span class="hs-comment">-- | The internal state used by the 'peerSelectionGovernor'.</span><span>
</span><a name="line-572"></a><span class="hs-comment">--</span><span>
</span><a name="line-573"></a><span class="hs-comment">-- The local and public root sets are disjoint, and their union is the</span><span>
</span><a name="line-574"></a><span class="hs-comment">-- overall root set.</span><span>
</span><a name="line-575"></a><span class="hs-comment">--</span><span>
</span><a name="line-576"></a><span class="hs-keyword">data</span><span> </span><a name="PeerSelectionState"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier">PeerSelectionState</span></a></a><span> </span><a name="local-6989586621679107514"><a href="#local-6989586621679107514"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107515"><a href="#local-6989586621679107515"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PeerSelectionState"><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier">PeerSelectionState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>       </span><a name="targets"><a href="Ouroboros.Network.PeerSelection.Governor.html#targets"><span class="hs-identifier">targets</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span class="hs-special">,</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span>       </span><span class="hs-comment">-- | The current set of local root peers.</span><span>
</span><a name="line-581"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-582"></a><span>       </span><a name="localRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#localRootPeers"><span class="hs-identifier">localRootPeers</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerAdvertise"><span class="hs-identifier hs-type">PeerAdvertise</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>       </span><a name="publicRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#publicRootPeers"><span class="hs-identifier">publicRootPeers</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>       </span><span class="hs-comment">-- |</span><span>
</span><a name="line-587"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-588"></a><span>       </span><a name="knownPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#knownPeers"><span class="hs-identifier">knownPeers</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeers"><span class="hs-identifier hs-type">KnownPeers</span></a><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>       </span><span class="hs-comment">-- |</span><span>
</span><a name="line-591"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-592"></a><span>       </span><a name="establishedPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedPeers"><span class="hs-identifier">establishedPeers</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107515"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-593"></a><span>       </span><a name="establishedStatus"><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedStatus"><span class="hs-identifier">establishedStatus</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>       </span><span class="hs-comment">-- |</span><span>
</span><a name="line-596"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-597"></a><span>       </span><a name="activePeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#activePeers"><span class="hs-identifier">activePeers</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>       </span><span class="hs-comment">-- | A counter to manage the exponential backoff strategy for when to</span><span>
</span><a name="line-600"></a><span>       </span><span class="hs-comment">-- retry querying for more public root peers. It is negative for retry</span><span>
</span><a name="line-601"></a><span>       </span><span class="hs-comment">-- counts after failure, and positive for retry counts that are</span><span>
</span><a name="line-602"></a><span>       </span><span class="hs-comment">-- successful but make no progress.</span><span>
</span><a name="line-603"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-604"></a><span>       </span><a name="publicRootBackoffs"><a href="Ouroboros.Network.PeerSelection.Governor.html#publicRootBackoffs"><span class="hs-identifier">publicRootBackoffs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>       </span><span class="hs-comment">-- | The earliest time we would be prepared to request more public root</span><span>
</span><a name="line-607"></a><span>       </span><span class="hs-comment">-- peers. This is used with the 'publicRootBackoffs' to manage the</span><span>
</span><a name="line-608"></a><span>       </span><span class="hs-comment">-- exponential backoff.</span><span>
</span><a name="line-609"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-610"></a><span>       </span><a name="publicRootRetryTime"><a href="Ouroboros.Network.PeerSelection.Governor.html#publicRootRetryTime"><span class="hs-identifier">publicRootRetryTime</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span class="hs-special">,</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span>       </span><a name="inProgressPublicRootsReq"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressPublicRootsReq"><span class="hs-identifier">inProgressPublicRootsReq</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-613"></a><span>       </span><a name="inProgressGossipReqs"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressGossipReqs"><span class="hs-identifier">inProgressGossipReqs</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-614"></a><span>       </span><a name="inProgressPromoteCold"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressPromoteCold"><span class="hs-identifier">inProgressPromoteCold</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-615"></a><span>       </span><a name="inProgressPromoteWarm"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressPromoteWarm"><span class="hs-identifier">inProgressPromoteWarm</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-616"></a><span>       </span><a name="inProgressDemoteWarm"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressDemoteWarm"><span class="hs-identifier">inProgressDemoteWarm</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-617"></a><span>       </span><a name="inProgressDemoteHot"><a href="Ouroboros.Network.PeerSelection.Governor.html#inProgressDemoteHot"><span class="hs-identifier">inProgressDemoteHot</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107514"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-comment">--     TODO: need something like this to distinguish between lots of bad peers</span><span>
</span><a name="line-620"></a><span class="hs-comment">--     and us getting disconnected from the network locally. We don't want a</span><span>
</span><a name="line-621"></a><span class="hs-comment">--     network disconnect to cause us to flush our full known peer set by</span><span>
</span><a name="line-622"></a><span class="hs-comment">--     considering them all to have bad connectivity.</span><span>
</span><a name="line-623"></a><span class="hs-comment">--     Should also take account of DNS failures for root peer set.</span><span>
</span><a name="line-624"></a><span class="hs-comment">--     lastSucessfulNetworkEvent :: Time</span><span>
</span><a name="line-625"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-626"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-identifier">emptyPeerSelectionState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107602"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107603"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-629"></a><a name="emptyPeerSelectionState"><a href="Ouroboros.Network.PeerSelection.Governor.html#emptyPeerSelectionState"><span class="hs-identifier">emptyPeerSelectionState</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-630"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-631"></a><span>      </span><span class="hs-identifier">targets</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#nullPeerSelectionTargets"><span class="hs-identifier hs-var">nullPeerSelectionTargets</span></a><span class="hs-special">,</span><span>
</span><a name="line-632"></a><span>      </span><span class="hs-identifier">localRootPeers</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-633"></a><span>      </span><span class="hs-identifier">publicRootPeers</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">,</span><span>
</span><a name="line-634"></a><span>      </span><span class="hs-identifier">knownPeers</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#empty"><span class="hs-identifier hs-var">KnownPeers.empty</span></a><span class="hs-special">,</span><span>
</span><a name="line-635"></a><span>      </span><span class="hs-identifier">establishedPeers</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-636"></a><span>      </span><span class="hs-identifier">establishedStatus</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-637"></a><span>      </span><span class="hs-identifier">activePeers</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">,</span><span>
</span><a name="line-638"></a><span>      </span><span class="hs-identifier">publicRootBackoffs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-639"></a><span>      </span><span class="hs-identifier">publicRootRetryTime</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-var">Time</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-640"></a><span>      </span><span class="hs-identifier">inProgressPublicRootsReq</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-641"></a><span>      </span><span class="hs-identifier">inProgressGossipReqs</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-642"></a><span>      </span><span class="hs-identifier">inProgressPromoteCold</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">,</span><span>
</span><a name="line-643"></a><span>      </span><span class="hs-identifier">inProgressPromoteWarm</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">,</span><span>
</span><a name="line-644"></a><span>      </span><span class="hs-identifier">inProgressDemoteWarm</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">,</span><span>
</span><a name="line-645"></a><span>      </span><span class="hs-identifier">inProgressDemoteHot</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span class="hs-identifier">invariantPeerSelectionState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107600"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-649"></a><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107600"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107601"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-650"></a><a name="invariantPeerSelectionState"><a href="Ouroboros.Network.PeerSelection.Governor.html#invariantPeerSelectionState"><span class="hs-identifier">invariantPeerSelectionState</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-651"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#invariant"><span class="hs-identifier hs-var">KnownPeers.invariant</span></a><span> </span><a href="#local-6989586621679107622"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>    </span><span class="hs-comment">-- The activePeers is a subset of the establishedPeers</span><span>
</span><a name="line-654"></a><span>    </span><span class="hs-comment">-- which is a subset of the known peers</span><span>
</span><a name="line-655"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107637"><span class="hs-identifier hs-var">activePeersSet</span></a><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span>
</span><a name="line-656"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span> </span><a href="#local-6989586621679107635"><span class="hs-identifier hs-var">knownPeersSet</span></a><span>
</span><a name="line-657"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107624"><span class="hs-identifier hs-var">establishedStatus</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span>    </span><span class="hs-comment">-- The localRootPeers and publicRootPeers must not overlap.</span><span>
</span><a name="line-660"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.intersection</span><span> </span><a href="#local-6989586621679107634"><span class="hs-identifier hs-var">localRootPeersSet</span></a><span> </span><a href="#local-6989586621679107621"><span class="hs-identifier hs-var">publicRootPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span>    </span><span class="hs-comment">-- The localRootPeers are a subset of the knownPeers,</span><span>
</span><a name="line-663"></a><span>    </span><span class="hs-comment">-- and with correct source and other info in the knownPeers.</span><span>
</span><a name="line-664"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.isSubmapOfBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679107641"><a href="#local-6989586621679107641"><span class="hs-identifier">rootPeerAdvertise</span></a></a><span>
</span><a name="line-665"></a><span>                       </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-var">KnownPeerInfo</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679107642"><a href="#local-6989586621679107642"><span class="hs-identifier">knownPeerAdvertise</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107643"><a href="#local-6989586621679107643"><span class="hs-identifier">knownPeerSource</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-666"></a><span>                           </span><a href="#local-6989586621679107643"><span class="hs-identifier hs-var">knownPeerSource</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceLocalRoot"><span class="hs-identifier hs-var">PeerSourceLocalRoot</span></a><span>
</span><a name="line-667"></a><span>                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107642"><span class="hs-identifier hs-var">knownPeerAdvertise</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679107641"><span class="hs-identifier hs-var">rootPeerAdvertise</span></a><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>                     </span><a href="#local-6989586621679107620"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-669"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107622"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span>    </span><span class="hs-comment">-- The publicRootPeers are a subset of the knownPeers,</span><span>
</span><a name="line-672"></a><span>    </span><span class="hs-comment">-- and with correct source info in the knownPeers.</span><span>
</span><a name="line-673"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.isSubmapOfBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-var">KnownPeerInfo</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679107644"><a href="#local-6989586621679107644"><span class="hs-identifier">knownPeerSource</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-674"></a><span>                         </span><a href="#local-6989586621679107644"><span class="hs-identifier hs-var">knownPeerSource</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourcePublicRoot"><span class="hs-identifier hs-var">PeerSourcePublicRoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679107621"><span class="hs-identifier hs-var">publicRootPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>                     </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107622"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span>    </span><span class="hs-comment">--TODO: all other peers have PeerSourceGossip, so no stale source info.</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>    </span><span class="hs-comment">-- We don't want to pick local root peers to forget, so it had better be</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-comment">-- the case that there's fewer of them than our target number.</span><span>
</span><a name="line-682"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107620"><span class="hs-identifier hs-var">localRootPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier">targetNumberOfKnownPeers</span><span> </span><a href="#local-6989586621679107619"><span class="hs-identifier hs-var">targets</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>    </span><span class="hs-comment">-- All currently established peers are in the availableToConnect set since</span><span>
</span><a name="line-685"></a><span>    </span><span class="hs-comment">-- the alternative is a record of failure, but these are not (yet) failed.</span><span>
</span><a name="line-686"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">KnownPeers.availableToConnect</span><span> </span><a href="#local-6989586621679107622"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span>    </span><span class="hs-comment">-- No constraint for publicRootBackoffs, publicRootRetryTime</span><span>
</span><a name="line-689"></a><span>    </span><span class="hs-comment">-- or inProgressPublicRootsReq</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679107629"><span class="hs-identifier hs-var">inProgressGossipReqs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-692"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107630"><span class="hs-identifier hs-var">inProgressPromoteCold</span></a><span> </span><a href="#local-6989586621679107638"><span class="hs-identifier hs-var">coldPeersSet</span></a><span>
</span><a name="line-693"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107631"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span> </span><a href="#local-6989586621679107639"><span class="hs-identifier hs-var">warmPeersSet</span></a><span>
</span><a name="line-694"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107632"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>  </span><a href="#local-6989586621679107639"><span class="hs-identifier hs-var">warmPeersSet</span></a><span>
</span><a name="line-695"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.isSubsetOf</span><span> </span><a href="#local-6989586621679107633"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>   </span><a href="#local-6989586621679107640"><span class="hs-identifier hs-var">hotPeersSet</span></a><span>
</span><a name="line-696"></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Set.null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.intersection</span><span> </span><a href="#local-6989586621679107631"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span> </span><a href="#local-6989586621679107632"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-698"></a><span>    </span><a name="local-6989586621679107634"><a href="#local-6989586621679107634"><span class="hs-identifier">localRootPeersSet</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107620"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-699"></a><span>    </span><a name="local-6989586621679107635"><a href="#local-6989586621679107635"><span class="hs-identifier">knownPeersSet</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107622"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>    </span><a name="local-6989586621679107636"><a href="#local-6989586621679107636"><span class="hs-identifier">establishedPeersSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107623"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-701"></a><span>    </span><a name="local-6989586621679107637"><a href="#local-6989586621679107637"><span class="hs-identifier">activePeersSet</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107625"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-702"></a><span>    </span><a name="local-6989586621679107638"><a href="#local-6989586621679107638"><span class="hs-identifier">coldPeersSet</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107635"><span class="hs-identifier hs-var">knownPeersSet</span></a><span> </span><span class="hs-operator hs-var">Set.\\</span><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span>
</span><a name="line-703"></a><span>    </span><a name="local-6989586621679107639"><a href="#local-6989586621679107639"><span class="hs-identifier">warmPeersSet</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107636"><span class="hs-identifier hs-var">establishedPeersSet</span></a><span> </span><span class="hs-operator hs-var">Set.\\</span><span> </span><a href="#local-6989586621679107637"><span class="hs-identifier hs-var">activePeersSet</span></a><span>
</span><a name="line-704"></a><span>    </span><a name="local-6989586621679107640"><a href="#local-6989586621679107640"><span class="hs-identifier">hotPeersSet</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107637"><span class="hs-identifier hs-var">activePeersSet</span></a><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-707"></a><span class="hs-comment">--</span><span>
</span><a name="line-708"></a><span class="hs-identifier">peerSelectionGovernor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#MonadTime"><span class="hs-identifier hs-type">MonadTime</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-709"></a><span>                          </span><span class="hs-identifier hs-type">Alternative</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107598"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePeerSelection"><span class="hs-identifier hs-type">TracePeerSelection</span></a><span> </span><a href="#local-6989586621679107598"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a><span> </span><a href="#local-6989586621679107598"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107599"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107598"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107599"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-713"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span>  </span><a href="#local-6989586621679107598"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-714"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107597"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Void</span><span>
</span><a name="line-715"></a><a name="peerSelectionGovernor"><a href="Ouroboros.Network.PeerSelection.Governor.html#peerSelectionGovernor"><span class="hs-identifier">peerSelectionGovernor</span></a></a><span> </span><a name="local-6989586621679107645"><a href="#local-6989586621679107645"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679107646"><a href="#local-6989586621679107646"><span class="hs-identifier">debugTracer</span></a></a><span> </span><a name="local-6989586621679107647"><a href="#local-6989586621679107647"><span class="hs-identifier">actions</span></a></a><span> </span><a name="local-6989586621679107648"><a href="#local-6989586621679107648"><span class="hs-identifier">policy</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-716"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#withJobPool"><span class="hs-identifier hs-var">JobPool.withJobPool</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107649"><a href="#local-6989586621679107649"><span class="hs-identifier">jobPool</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-717"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#peerSelectionGovernorLoop"><span class="hs-identifier hs-var">peerSelectionGovernorLoop</span></a><span>
</span><a name="line-718"></a><span>        </span><a href="#local-6989586621679107645"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="#local-6989586621679107646"><span class="hs-identifier hs-var">debugTracer</span></a><span>
</span><a name="line-719"></a><span>        </span><a href="#local-6989586621679107647"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107648"><span class="hs-identifier hs-var">policy</span></a><span>
</span><a name="line-720"></a><span>        </span><a href="#local-6989586621679107649"><span class="hs-identifier hs-var">jobPool</span></a><span>
</span><a name="line-721"></a><span>        </span><a href="Ouroboros.Network.PeerSelection.Governor.html#emptyPeerSelectionState"><span class="hs-identifier hs-var">emptyPeerSelectionState</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- | Our pattern here is a loop with two sets of guarded actions:</span><span>
</span><a name="line-725"></a><span class="hs-comment">--</span><span>
</span><a name="line-726"></a><span class="hs-comment">-- * Actions guarded on predicates on the current immutable state, e.g.</span><span>
</span><a name="line-727"></a><span class="hs-comment">--   * below known peer targets &amp; below in-progress limit</span><span>
</span><a name="line-728"></a><span class="hs-comment">--</span><span>
</span><a name="line-729"></a><span class="hs-comment">-- * Actions guarded by blocking and waiting for state changes, e.g.</span><span>
</span><a name="line-730"></a><span class="hs-comment">--   * root peer set changed</span><span>
</span><a name="line-731"></a><span class="hs-comment">--   * churn timeout</span><span>
</span><a name="line-732"></a><span class="hs-comment">--   * async action completed</span><span>
</span><a name="line-733"></a><span class="hs-comment">--   * established connection failed</span><span>
</span><a name="line-734"></a><span class="hs-comment">--</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- We check the internal actions first, and otherwise the blocking actions.</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- In each case we trace the action, update the state and execute the</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- action asynchronously.</span><span>
</span><a name="line-738"></a><span class="hs-comment">--</span><span>
</span><a name="line-739"></a><span class="hs-identifier">peerSelectionGovernorLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107594"><a href="#local-6989586621679107594"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107595"><a href="#local-6989586621679107595"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107596"><a href="#local-6989586621679107596"><span class="hs-identifier">peerconn</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-740"></a><span>                             </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadMask"><span class="hs-identifier hs-type">MonadMask</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-741"></a><span>                              </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#MonadTime"><span class="hs-identifier hs-type">MonadTime</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-742"></a><span>                              </span><span class="hs-identifier hs-type">Alternative</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>                          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePeerSelection"><span class="hs-identifier hs-type">TracePeerSelection</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#Tracer"><span class="hs-identifier hs-type">Tracer</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-746"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span>  </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-747"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#JobPool"><span class="hs-identifier hs-type">JobPool</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-749"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Void</span><span>
</span><a name="line-750"></a><a name="peerSelectionGovernorLoop"><a href="Ouroboros.Network.PeerSelection.Governor.html#peerSelectionGovernorLoop"><span class="hs-identifier">peerSelectionGovernorLoop</span></a></a><span> </span><a name="local-6989586621679107650"><a href="#local-6989586621679107650"><span class="hs-identifier">tracer</span></a></a><span> </span><a name="local-6989586621679107651"><a href="#local-6989586621679107651"><span class="hs-identifier">debugTracer</span></a></a><span>
</span><a name="line-751"></a><span>                          </span><a name="local-6989586621679107652"><a href="#local-6989586621679107652"><span class="hs-identifier">actions</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-752"></a><span>                          </span><a name="local-6989586621679107662"><a href="#local-6989586621679107662"><span class="hs-identifier">policy</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-753"></a><span>                          </span><a name="local-6989586621679107674"><a href="#local-6989586621679107674"><span class="hs-identifier">jobPool</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-754"></a><span>    </span><a href="#local-6989586621679107675"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-755"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-756"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Void</span><span>
</span><a name="line-757"></a><span>    </span><a name="local-6989586621679107675"><a href="#local-6989586621679107675"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679107678"><a href="#local-6989586621679107678"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#invariantPeerSelectionState"><span class="hs-identifier hs-var">invariantPeerSelectionState</span></a><span> </span><a href="#local-6989586621679107678"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-758"></a><span>      </span><a name="local-6989586621679107679"><a href="#local-6989586621679107679"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a><span>
</span><a name="line-759"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107680"><a href="#local-6989586621679107680"><span class="hs-identifier">knownPeers'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#setCurrentTime"><span class="hs-identifier hs-var">KnownPeers.setCurrentTime</span></a><span> </span><a href="#local-6989586621679107679"><span class="hs-identifier hs-var">now</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107678"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>          </span><a name="local-6989586621679107681"><a href="#local-6989586621679107681"><span class="hs-identifier">st'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107678"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">knownPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107680"><span class="hs-identifier hs-var">knownPeers'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span>      </span><a name="local-6989586621679107682"><a href="#local-6989586621679107682"><span class="hs-identifier">decision</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107676"><span class="hs-identifier hs-var">evalGuardedDecisions</span></a><span> </span><a href="#local-6989586621679107679"><span class="hs-identifier hs-var">now</span></a><span> </span><a href="#local-6989586621679107681"><span class="hs-identifier hs-var">st'</span></a><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679107683"><a href="#local-6989586621679107683"><span class="hs-identifier">decisionTrace</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107684"><a href="#local-6989586621679107684"><span class="hs-identifier">decisionJobs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107685"><a href="#local-6989586621679107685"><span class="hs-identifier">decisionState</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107682"><span class="hs-identifier hs-var">decision</span></a><span>
</span><a name="line-765"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679107650"><span class="hs-identifier hs-var">tracer</span></a><span> </span><a href="#local-6989586621679107683"><span class="hs-identifier hs-var">decisionTrace</span></a><span>
</span><a name="line-766"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.JobPool.html#forkJob"><span class="hs-identifier hs-var">JobPool.forkJob</span></a><span> </span><a href="#local-6989586621679107674"><span class="hs-identifier hs-var">jobPool</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679107684"><span class="hs-identifier hs-var">decisionJobs</span></a><span>
</span><a name="line-767"></a><span>      </span><a href="#local-6989586621679107675"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679107685"><span class="hs-identifier hs-var">decisionState</span></a><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span>    </span><span class="hs-identifier">evalGuardedDecisions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-770"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-771"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>    </span><a name="local-6989586621679107676"><a href="#local-6989586621679107676"><span class="hs-identifier">evalGuardedDecisions</span></a></a><span> </span><a name="local-6989586621679107686"><a href="#local-6989586621679107686"><span class="hs-identifier">now</span></a></a><span> </span><a name="local-6989586621679107687"><a href="#local-6989586621679107687"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-773"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107677"><span class="hs-identifier hs-var">guardedDecisions</span></a><span> </span><a href="#local-6989586621679107686"><span class="hs-identifier hs-var">now</span></a><span> </span><a href="#local-6989586621679107687"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-774"></a><span>        </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-775"></a><span>          </span><span class="hs-comment">-- impossible since guardedDecisions always has something to wait for</span><span>
</span><a name="line-776"></a><span>          </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;peerSelectionGovernorLoop: impossible: nothing to do&quot;</span><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span>        </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621679107688"><a href="#local-6989586621679107688"><span class="hs-identifier">decisionAction</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-779"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679107651"><span class="hs-identifier hs-var">debugTracer</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGovernorState"><span class="hs-identifier hs-var">TraceGovernorState</span></a><span> </span><a href="#local-6989586621679107687"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><a href="#local-6989586621679107688"><span class="hs-identifier hs-var">decisionAction</span></a><span>
</span><a name="line-781"></a><span>
</span><a name="line-782"></a><span>        </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Min</span><span> </span><a name="local-6989586621679107689"><a href="#local-6989586621679107689"><span class="hs-identifier">wakeupAt</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679107690"><a href="#local-6989586621679107690"><span class="hs-identifier">decisionAction</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-783"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107691"><a href="#local-6989586621679107691"><span class="hs-identifier">wakeupIn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#diffTime"><span class="hs-identifier hs-var">diffTime</span></a><span> </span><a href="#local-6989586621679107689"><span class="hs-identifier hs-var">wakeupAt</span></a><span> </span><a href="#local-6989586621679107686"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-784"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/src/Control.Tracer.html#traceWith"><span class="hs-identifier hs-var">traceWith</span></a><span> </span><a href="#local-6989586621679107651"><span class="hs-identifier hs-var">debugTracer</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGovernorState"><span class="hs-identifier hs-var">TraceGovernorState</span></a><span> </span><a href="#local-6989586621679107687"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679107691"><span class="hs-identifier hs-var">wakeupIn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>          </span><a name="local-6989586621679107692"><a href="#local-6989586621679107692"><span class="hs-identifier">wakupTimeout</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#newTimeout"><span class="hs-identifier hs-var">newTimeout</span></a><span> </span><a href="#local-6989586621679107691"><span class="hs-identifier hs-var">wakeupIn</span></a><span>
</span><a name="line-786"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107693"><a href="#local-6989586621679107693"><span class="hs-identifier">wakeup</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#awaitTimeout"><span class="hs-identifier hs-var">awaitTimeout</span></a><span> </span><a href="#local-6989586621679107692"><span class="hs-identifier hs-var">wakupTimeout</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#wakeupDecision"><span class="hs-identifier hs-var">wakeupDecision</span></a><span> </span><a href="#local-6989586621679107687"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>          </span><a name="local-6989586621679107694"><a href="#local-6989586621679107694"><span class="hs-identifier">decision</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107690"><span class="hs-identifier hs-var">decisionAction</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="#local-6989586621679107693"><span class="hs-identifier hs-var">wakeup</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>          </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#cancelTimeout"><span class="hs-identifier hs-var">cancelTimeout</span></a><span> </span><a href="#local-6989586621679107692"><span class="hs-identifier hs-var">wakupTimeout</span></a><span>
</span><a name="line-789"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679107694"><span class="hs-identifier hs-var">decision</span></a><span>
</span><a name="line-790"></a><span>
</span><a name="line-791"></a><span>    </span><span class="hs-identifier">guardedDecisions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-792"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-793"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107594"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107595"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107596"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621679107677"><a href="#local-6989586621679107677"><span class="hs-identifier">guardedDecisions</span></a></a><span> </span><a name="local-6989586621679107695"><a href="#local-6989586621679107695"><span class="hs-identifier">now</span></a></a><span> </span><a name="local-6989586621679107696"><a href="#local-6989586621679107696"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-795"></a><span>      </span><span class="hs-comment">-- All the alternative non-blocking internal decisions.</span><span>
</span><a name="line-796"></a><span>         </span><a href="Ouroboros.Network.PeerSelection.Governor.html#rootPeersBelowTarget"><span class="hs-identifier hs-var">rootPeersBelowTarget</span></a><span>        </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span>        </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679107695"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-797"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#knownPeersBelowTarget"><span class="hs-identifier hs-var">knownPeersBelowTarget</span></a><span>       </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679107695"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-798"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#knownPeersAboveTarget"><span class="hs-identifier hs-var">knownPeersAboveTarget</span></a><span>               </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-799"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedPeersBelowTarget"><span class="hs-identifier hs-var">establishedPeersBelowTarget</span></a><span> </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-800"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedPeersAboveTarget"><span class="hs-identifier hs-var">establishedPeersAboveTarget</span></a><span> </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-801"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#activePeersBelowTarget"><span class="hs-identifier hs-var">activePeersBelowTarget</span></a><span>      </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-802"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#activePeersAboveTarget"><span class="hs-identifier hs-var">activePeersAboveTarget</span></a><span>      </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107662"><span class="hs-identifier hs-var">policy</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>      </span><span class="hs-comment">-- All the alternative potentially-blocking decisions.</span><span>
</span><a name="line-805"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#changedTargets"><span class="hs-identifier hs-var">changedTargets</span></a><span>                </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-806"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#changedLocalRootPeers"><span class="hs-identifier hs-var">changedLocalRootPeers</span></a><span>         </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-807"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobCompleted"><span class="hs-identifier hs-var">jobCompleted</span></a><span>                  </span><a href="#local-6989586621679107674"><span class="hs-identifier hs-var">jobPool</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679107695"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-808"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#monitorConnections"><span class="hs-identifier hs-var">monitorConnections</span></a><span>            </span><a href="#local-6989586621679107652"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107696"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span>      </span><span class="hs-comment">-- There is no rootPeersAboveTarget since the roots target is one sided.</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span>      </span><span class="hs-comment">-- The changedTargets needs to come before the changedLocalRootPeers in</span><span>
</span><a name="line-813"></a><span>      </span><span class="hs-comment">-- the list of alternates above because our invariant requires that</span><span>
</span><a name="line-814"></a><span>      </span><span class="hs-comment">-- the number of root nodes be less than our target for known peers,</span><span>
</span><a name="line-815"></a><span>      </span><span class="hs-comment">-- but at startup our initial targets are 0, so we need to read and set</span><span>
</span><a name="line-816"></a><span>      </span><span class="hs-comment">-- the targets before we set the root peer set. Otherwise we violate our</span><span>
</span><a name="line-817"></a><span>      </span><span class="hs-comment">-- invariant (and if we ignored that, we'd try to immediately forget</span><span>
</span><a name="line-818"></a><span>      </span><span class="hs-comment">-- roots peers because we'd be above target for known peers).</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-keyword">data</span><span> </span><a name="Guarded"><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier">Guarded</span></a></a><span> </span><a name="local-6989586621679107512"><a href="#local-6989586621679107512"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107513"><a href="#local-6989586621679107513"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="GuardedSkip"><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier">GuardedSkip</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Min</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="Guarded"><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier">Guarded</span></a></a><span>     </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Min</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107512"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107513"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span> </span><a href="#local-6989586621679107523"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><a href="#local-6989586621679107523"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107524"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-825"></a><span>  </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><a name="local-6989586621679107525"><a href="#local-6989586621679107525"><span class="hs-identifier">ta</span></a></a><span> </span><a name="local-6989586621679107526"><a href="#local-6989586621679107526"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><a name="local-6989586621679107527"><a href="#local-6989586621679107527"><span class="hs-identifier">tb</span></a></a><span> </span><a name="local-6989586621679107528"><a href="#local-6989586621679107528"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><span class="hs-special">(</span><a href="#local-6989586621679107525"><span class="hs-identifier hs-var">ta</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107527"><span class="hs-identifier hs-var">tb</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107526"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="#local-6989586621679107528"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>  </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><a name="local-6989586621679107529"><a href="#local-6989586621679107529"><span class="hs-identifier">ta</span></a></a><span> </span><a name="local-6989586621679107530"><a href="#local-6989586621679107530"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><a name="local-6989586621679107531"><a href="#local-6989586621679107531"><span class="hs-identifier">tb</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><span class="hs-special">(</span><a href="#local-6989586621679107529"><span class="hs-identifier hs-var">ta</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107531"><span class="hs-identifier hs-var">tb</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621679107530"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-827"></a><span>  </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><a name="local-6989586621679107532"><a href="#local-6989586621679107532"><span class="hs-identifier">ta</span></a></a><span>   </span><span class="hs-operator">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><a name="local-6989586621679107533"><a href="#local-6989586621679107533"><span class="hs-identifier">tb</span></a></a><span> </span><a name="local-6989586621679107534"><a href="#local-6989586621679107534"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span>     </span><span class="hs-special">(</span><a href="#local-6989586621679107532"><span class="hs-identifier hs-var">ta</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107533"><span class="hs-identifier hs-var">tb</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621679107534"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-828"></a><span>  </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><a name="local-6989586621679107535"><a href="#local-6989586621679107535"><span class="hs-identifier">ta</span></a></a><span>   </span><span class="hs-operator">&lt;&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><a name="local-6989586621679107536"><a href="#local-6989586621679107536"><span class="hs-identifier">tb</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107535"><span class="hs-identifier hs-var">ta</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107536"><span class="hs-identifier hs-var">tb</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-keyword">data</span><span> </span><a name="Decision"><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier">Decision</span></a></a><span> </span><a name="local-6989586621679107509"><a href="#local-6989586621679107509"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107510"><a href="#local-6989586621679107510"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107511"><a href="#local-6989586621679107511"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Decision"><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier">Decision</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-832"></a><span>         </span><span class="hs-comment">-- | A trace event to classify the decision and action</span><span>
</span><a name="line-833"></a><span>       </span><a name="decisionTrace"><a href="Ouroboros.Network.PeerSelection.Governor.html#decisionTrace"><span class="hs-identifier">decisionTrace</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePeerSelection"><span class="hs-identifier hs-type">TracePeerSelection</span></a><span> </span><a href="#local-6989586621679107510"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">,</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span>         </span><span class="hs-comment">-- | An updated state to use immediately</span><span>
</span><a name="line-836"></a><span>       </span><a name="decisionState"><a href="Ouroboros.Network.PeerSelection.Governor.html#decisionState"><span class="hs-identifier">decisionState</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107510"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107511"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">,</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span>       </span><span class="hs-comment">-- | An optional 'Job' to execute asynchronously. This job leads to</span><span>
</span><a name="line-839"></a><span>       </span><span class="hs-comment">-- a further 'Decision'. This gives a state update to apply upon</span><span>
</span><a name="line-840"></a><span>       </span><span class="hs-comment">-- completion, but also allows chaining further job actions.</span><span>
</span><a name="line-841"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-842"></a><span>       </span><a name="decisionJobs"><a href="Ouroboros.Network.PeerSelection.Governor.html#decisionJobs"><span class="hs-identifier">decisionJobs</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107509"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107509"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107510"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107511"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">wakeupDecision</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107591"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107592"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-846"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107593"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107591"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107592"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-847"></a><a name="wakeupDecision"><a href="Ouroboros.Network.PeerSelection.Governor.html#wakeupDecision"><span class="hs-identifier">wakeupDecision</span></a></a><span> </span><a name="local-6989586621679107697"><a href="#local-6989586621679107697"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-848"></a><span>  </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-849"></a><span>    </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGovernorWakeup"><span class="hs-identifier hs-var">TraceGovernorWakeup</span></a><span class="hs-special">,</span><span>
</span><a name="line-850"></a><span>    </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107697"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span>
</span><a name="line-851"></a><span>    </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-852"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span class="hs-keyword">newtype</span><span> </span><a name="Completion"><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier">Completion</span></a></a><span> </span><a name="local-6989586621679107506"><a href="#local-6989586621679107506"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107507"><a href="#local-6989586621679107507"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107508"><a href="#local-6989586621679107508"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-855"></a><span>        </span><a name="Completion"><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier">Completion</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107507"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107508"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-856"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107506"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107507"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107508"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-keyword">data</span><span> </span><a name="TracePeerSelection"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePeerSelection"><span class="hs-identifier">TracePeerSelection</span></a></a><span> </span><a name="local-6989586621679107505"><a href="#local-6989586621679107505"><span class="hs-identifier">peeraddr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-859"></a><span>       </span><a name="TraceLocalRootPeersChanged"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceLocalRootPeersChanged"><span class="hs-identifier">TraceLocalRootPeersChanged</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerAdvertise"><span class="hs-identifier hs-type">PeerAdvertise</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerAdvertise"><span class="hs-identifier hs-type">PeerAdvertise</span></a><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceTargetsChanged"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceTargetsChanged"><span class="hs-identifier">TraceTargetsChanged</span></a></a><span>     </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span>
</span><a name="line-862"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePublicRootsRequest"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsRequest"><span class="hs-identifier">TracePublicRootsRequest</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-863"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePublicRootsResults"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsResults"><span class="hs-identifier">TracePublicRootsResults</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-864"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePublicRootsFailure"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsFailure"><span class="hs-identifier">TracePublicRootsFailure</span></a></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-865"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceGossipRequests"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipRequests"><span class="hs-identifier">TraceGossipRequests</span></a></a><span>     </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- target, actual, selected</span><span>
</span><a name="line-866"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceGossipResults"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipResults"><span class="hs-identifier">TraceGossipResults</span></a></a><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">--TODO: classify failures</span><span>
</span><a name="line-867"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceForgetColdPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceForgetColdPeers"><span class="hs-identifier">TraceForgetColdPeers</span></a></a><span>    </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- target, actual, selected</span><span>
</span><a name="line-868"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteColdPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdPeers"><span class="hs-identifier">TracePromoteColdPeers</span></a></a><span>   </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteColdFailed"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdFailed"><span class="hs-identifier">TracePromoteColdFailed</span></a></a><span>  </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-870"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteColdDone"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdDone"><span class="hs-identifier">TracePromoteColdDone</span></a></a><span>    </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-871"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteWarmPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmPeers"><span class="hs-identifier">TracePromoteWarmPeers</span></a></a><span>   </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteWarmFailed"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmFailed"><span class="hs-identifier">TracePromoteWarmFailed</span></a></a><span>  </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-873"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TracePromoteWarmDone"><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmDone"><span class="hs-identifier">TracePromoteWarmDone</span></a></a><span>    </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-874"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteWarmPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmPeers"><span class="hs-identifier">TraceDemoteWarmPeers</span></a></a><span>    </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- target, actual, selected</span><span>
</span><a name="line-875"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteWarmFailed"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmFailed"><span class="hs-identifier">TraceDemoteWarmFailed</span></a></a><span>   </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-876"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteWarmDone"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmDone"><span class="hs-identifier">TraceDemoteWarmDone</span></a></a><span>     </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-877"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteHotPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotPeers"><span class="hs-identifier">TraceDemoteHotPeers</span></a></a><span>     </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteHotFailed"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotFailed"><span class="hs-identifier">TraceDemoteHotFailed</span></a></a><span>    </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-identifier hs-type">SomeException</span><span>
</span><a name="line-879"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteHotDone"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotDone"><span class="hs-identifier">TraceDemoteHotDone</span></a></a><span>      </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-880"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceDemoteAsynchronous"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteAsynchronous"><span class="hs-identifier">TraceDemoteAsynchronous</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107505"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a name="TraceGovernorWakeup"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGovernorWakeup"><span class="hs-identifier">TraceGovernorWakeup</span></a></a><span>
</span><a name="line-882"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span class="hs-keyword">data</span><span> </span><a name="DebugPeerSelection"><a href="Ouroboros.Network.PeerSelection.Governor.html#DebugPeerSelection"><span class="hs-identifier">DebugPeerSelection</span></a></a><span> </span><a name="local-6989586621679107503"><a href="#local-6989586621679107503"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107504"><a href="#local-6989586621679107504"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-885"></a><span>       </span><a name="TraceGovernorState"><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGovernorState"><span class="hs-identifier">TraceGovernorState</span></a></a><span>  </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107503"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107504"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-886"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span class="hs-identifier">rootPeersBelowTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107588"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107589"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-890"></a><span>                     </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107589"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107590"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107588"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-891"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107589"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107590"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-892"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-893"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107588"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107588"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107589"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107590"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-894"></a><a name="rootPeersBelowTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#rootPeersBelowTarget"><span class="hs-identifier">rootPeersBelowTarget</span></a></a><span> </span><a name="local-6989586621679107698"><a href="#local-6989586621679107698"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-895"></a><span>                     </span><a name="local-6989586621679107699"><a href="#local-6989586621679107699"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-896"></a><span>                       </span><a name="local-6989586621679107700"><a href="#local-6989586621679107700"><span class="hs-identifier">localRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-897"></a><span>                       </span><a name="local-6989586621679107701"><a href="#local-6989586621679107701"><span class="hs-identifier">publicRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-898"></a><span>                       </span><a name="local-6989586621679107702"><a href="#local-6989586621679107702"><span class="hs-identifier">publicRootRetryTime</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-899"></a><span>                       </span><a name="local-6989586621679107703"><a href="#local-6989586621679107703"><span class="hs-identifier">inProgressPublicRootsReq</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-900"></a><span>                       </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-901"></a><span>                                   </span><a name="local-6989586621679107704"><a href="#local-6989586621679107704"><span class="hs-identifier">targetNumberOfRootPeers</span></a></a><span>
</span><a name="line-902"></a><span>                                 </span><span class="hs-special">}</span><span>
</span><a name="line-903"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-904"></a><span>                     </span><a name="local-6989586621679107705"><a href="#local-6989586621679107705"><span class="hs-identifier">now</span></a></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-comment">-- Are we under target for number of root peers?</span><span>
</span><a name="line-906"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107707"><span class="hs-identifier hs-var">maxExtraRootPeers</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>    </span><span class="hs-comment">-- Are we already requesting more root peers?</span><span>
</span><a name="line-909"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679107703"><span class="hs-identifier hs-var">inProgressPublicRootsReq</span></a><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><span>    </span><span class="hs-comment">-- We limit how frequently we make requests, are we allowed to do it yet?</span><span>
</span><a name="line-912"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107705"><span class="hs-identifier hs-var">now</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679107702"><span class="hs-identifier hs-var">publicRootRetryTime</span></a><span>
</span><a name="line-913"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-914"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-915"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsRequest"><span class="hs-identifier hs-var">TracePublicRootsRequest</span></a><span>
</span><a name="line-916"></a><span>                          </span><a href="#local-6989586621679107704"><span class="hs-identifier hs-var">targetNumberOfRootPeers</span></a><span>
</span><a name="line-917"></a><span>                          </span><a href="#local-6989586621679107706"><span class="hs-identifier hs-var">numRootPeers</span></a><span class="hs-special">,</span><span>
</span><a name="line-918"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107699"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inProgressPublicRootsReq</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-919"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobReqPublicRootPeers"><span class="hs-identifier hs-var">jobReqPublicRootPeers</span></a><span> </span><a href="#local-6989586621679107698"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107707"><span class="hs-identifier hs-var">maxExtraRootPeers</span></a><span class="hs-special">]</span><span>
</span><a name="line-920"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span>    </span><span class="hs-comment">-- If we would be able to do the request except for the time, return the</span><span>
</span><a name="line-923"></a><span>    </span><span class="hs-comment">-- next retry time.</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107707"><span class="hs-identifier hs-var">maxExtraRootPeers</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-925"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679107703"><span class="hs-identifier hs-var">inProgressPublicRootsReq</span></a><span>
</span><a name="line-926"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Min</span><span> </span><a href="#local-6989586621679107702"><span class="hs-identifier hs-var">publicRootRetryTime</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-930"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-931"></a><span>    </span><a name="local-6989586621679107706"><a href="#local-6989586621679107706"><span class="hs-identifier">numRootPeers</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107700"><span class="hs-identifier hs-var">localRootPeers</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107701"><span class="hs-identifier hs-var">publicRootPeers</span></a><span>
</span><a name="line-932"></a><span>    </span><a name="local-6989586621679107707"><a href="#local-6989586621679107707"><span class="hs-identifier">maxExtraRootPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107704"><span class="hs-identifier hs-var">targetNumberOfRootPeers</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107706"><span class="hs-identifier hs-var">numRootPeers</span></a><span>
</span><a name="line-933"></a><span>
</span><a name="line-934"></a><span class="hs-identifier">jobReqPublicRootPeers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107585"><a href="#local-6989586621679107585"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107586"><a href="#local-6989586621679107586"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107587"><a href="#local-6989586621679107587"><span class="hs-identifier">peerconn</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-935"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107586"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107586"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107587"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-937"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-938"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107586"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107587"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><a name="jobReqPublicRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobReqPublicRootPeers"><span class="hs-identifier">jobReqPublicRootPeers</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107708"><a href="#local-6989586621679107708"><span class="hs-identifier">requestPublicRootPeers</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-940"></a><span>                   </span><a name="local-6989586621679107709"><a href="#local-6989586621679107709"><span class="hs-identifier">numExtraAllowed</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-941"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><a href="#local-6989586621679107711"><span class="hs-identifier hs-var">job</span></a><span> </span><a href="#local-6989586621679107710"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-942"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-943"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107586"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107587"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-944"></a><span>    </span><a name="local-6989586621679107710"><a href="#local-6989586621679107710"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107712"><a href="#local-6989586621679107712"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-945"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107713"><a href="#local-6989586621679107713"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107714"><a href="#local-6989586621679107714"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-946"></a><span>      </span><span class="hs-comment">-- This is a failure, so move the backoff counter one in the failure</span><span>
</span><a name="line-947"></a><span>      </span><span class="hs-comment">-- direction (negative) and schedule the next retry time accordingly.</span><span>
</span><a name="line-948"></a><span>      </span><span class="hs-comment">-- We use an exponential backoff strategy. The max retry time of 2^12</span><span>
</span><a name="line-949"></a><span>      </span><span class="hs-comment">-- seconds is just over an hour.</span><span>
</span><a name="line-950"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">publicRootBackoffs'</span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-951"></a><span>          </span><a name="local-6989586621679107715"><a href="#local-6989586621679107715"><span class="hs-identifier">publicRootBackoffs'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">publicRootBackoffs</span><span> </span><a href="#local-6989586621679107713"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">min</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span>          </span><span class="hs-identifier">publicRootRetryDiffTime'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-954"></a><span>          </span><a name="local-6989586621679107716"><a href="#local-6989586621679107716"><span class="hs-identifier">publicRootRetryDiffTime'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">^</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">abs</span><span> </span><a href="#local-6989586621679107715"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">min</span><span class="hs-special">`</span><span> </span><span class="hs-number">12</span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>
</span><a name="line-956"></a><span>          </span><span class="hs-identifier">publicRootRetryTime'</span><span>     </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-957"></a><span>          </span><a name="local-6989586621679107717"><a href="#local-6989586621679107717"><span class="hs-identifier">publicRootRetryTime'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#addTime"><span class="hs-identifier hs-var">addTime</span></a><span> </span><a href="#local-6989586621679107716"><span class="hs-identifier hs-var">publicRootRetryDiffTime'</span></a><span> </span><a href="#local-6989586621679107714"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-958"></a><span>       </span><span class="hs-keyword">in</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-959"></a><span>            </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsFailure"><span class="hs-identifier hs-var">TracePublicRootsFailure</span></a><span>
</span><a name="line-960"></a><span>                              </span><a href="#local-6989586621679107712"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-961"></a><span>                              </span><a href="#local-6989586621679107715"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span>
</span><a name="line-962"></a><span>                              </span><a href="#local-6989586621679107716"><span class="hs-identifier hs-var">publicRootRetryDiffTime'</span></a><span class="hs-special">,</span><span>
</span><a name="line-963"></a><span>            </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107713"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-964"></a><span>                              </span><span class="hs-identifier">inProgressPublicRootsReq</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-965"></a><span>                              </span><span class="hs-identifier">publicRootBackoffs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107715"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-966"></a><span>                              </span><span class="hs-identifier">publicRootRetryTime</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107717"><span class="hs-identifier hs-var">publicRootRetryTime'</span></a><span>
</span><a name="line-967"></a><span>                            </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-968"></a><span>            </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-969"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span>    </span><span class="hs-identifier">job</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107585"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107586"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107587"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>    </span><a name="local-6989586621679107711"><a href="#local-6989586621679107711"><span class="hs-identifier">job</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-973"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679107718"><a href="#local-6989586621679107718"><span class="hs-identifier">results</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107719"><a href="#local-6989586621679107719"><span class="hs-identifier">ttl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107708"><span class="hs-identifier hs-var">requestPublicRootPeers</span></a><span> </span><a href="#local-6989586621679107709"><span class="hs-identifier hs-var">numExtraAllowed</span></a><span>
</span><a name="line-974"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107720"><a href="#local-6989586621679107720"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107721"><a href="#local-6989586621679107721"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-975"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107722"><a href="#local-6989586621679107722"><span class="hs-identifier">newPeers</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107718"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-operator hs-var">Set.\\</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">localRootPeers</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>                                       </span><span class="hs-operator hs-var">Set.\\</span><span> </span><span class="hs-identifier">publicRootPeers</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-977"></a><span>            </span><a name="local-6989586621679107723"><a href="#local-6989586621679107723"><span class="hs-identifier">publicRootPeers'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">publicRootPeers</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107722"><span class="hs-identifier hs-var">newPeers</span></a><span>
</span><a name="line-978"></a><span>            </span><a name="local-6989586621679107724"><a href="#local-6989586621679107724"><span class="hs-identifier">knownPeers'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span>
</span><a name="line-979"></a><span>                                 </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourcePublicRoot"><span class="hs-identifier hs-var">PeerSourcePublicRoot</span></a><span>
</span><a name="line-980"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#DoAdvertisePeer"><span class="hs-identifier hs-var">DoAdvertisePeer</span></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>                                 </span><a href="#local-6989586621679107722"><span class="hs-identifier hs-var">newPeers</span></a><span>
</span><a name="line-982"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span>            </span><span class="hs-comment">-- We got a successful response to our request, but if we're still</span><span>
</span><a name="line-985"></a><span>            </span><span class="hs-comment">-- below target we're going to want to try again at some point.</span><span>
</span><a name="line-986"></a><span>            </span><span class="hs-comment">-- If we made progress towards our target then we will retry at the</span><span>
</span><a name="line-987"></a><span>            </span><span class="hs-comment">-- suggested ttl. But if we did not make progress then we want to</span><span>
</span><a name="line-988"></a><span>            </span><span class="hs-comment">-- follow an exponential backoff strategy. The max retry time of 2^12</span><span>
</span><a name="line-989"></a><span>            </span><span class="hs-comment">-- seconds is just over an hour.</span><span>
</span><a name="line-990"></a><span>            </span><span class="hs-identifier">publicRootBackoffs'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-991"></a><span>            </span><a name="local-6989586621679107725"><a href="#local-6989586621679107725"><span class="hs-identifier">publicRootBackoffs'</span></a></a><span>
</span><a name="line-992"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Set.null</span><span> </span><a href="#local-6989586621679107722"><span class="hs-identifier hs-var">newPeers</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">publicRootBackoffs</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-993"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span>            </span><span class="hs-identifier">publicRootRetryDiffTime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-996"></a><span>            </span><a name="local-6989586621679107726"><a href="#local-6989586621679107726"><span class="hs-identifier">publicRootRetryDiffTime</span></a></a><span>
</span><a name="line-997"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107725"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-998"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107719"><span class="hs-identifier hs-var">ttl</span></a><span>
</span><a name="line-999"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-operator hs-var">^</span><span class="hs-special">(</span><a href="#local-6989586621679107725"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">min</span><span class="hs-special">`</span><span> </span><span class="hs-number">12</span><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span>            </span><span class="hs-identifier">publicRootRetryTime</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-1002"></a><span>            </span><a name="local-6989586621679107727"><a href="#local-6989586621679107727"><span class="hs-identifier">publicRootRetryTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#addTime"><span class="hs-identifier hs-var">addTime</span></a><span> </span><a href="#local-6989586621679107726"><span class="hs-identifier hs-var">publicRootRetryDiffTime</span></a><span> </span><a href="#local-6989586621679107721"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-1003"></a><span>         </span><span class="hs-keyword">in</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1004"></a><span>              </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePublicRootsResults"><span class="hs-identifier hs-var">TracePublicRootsResults</span></a><span>
</span><a name="line-1005"></a><span>                                </span><a href="#local-6989586621679107722"><span class="hs-identifier hs-var">newPeers</span></a><span>
</span><a name="line-1006"></a><span>                                </span><a href="#local-6989586621679107725"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span>
</span><a name="line-1007"></a><span>                                </span><a href="#local-6989586621679107726"><span class="hs-identifier hs-var">publicRootRetryDiffTime</span></a><span class="hs-special">,</span><span>
</span><a name="line-1008"></a><span>              </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107720"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1009"></a><span>                                </span><span class="hs-identifier">publicRootPeers</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107723"><span class="hs-identifier hs-var">publicRootPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1010"></a><span>                                </span><span class="hs-identifier">knownPeers</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107724"><span class="hs-identifier hs-var">knownPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1011"></a><span>                                </span><span class="hs-identifier">publicRootBackoffs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107725"><span class="hs-identifier hs-var">publicRootBackoffs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1012"></a><span>                                </span><span class="hs-identifier">publicRootRetryTime</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107727"><span class="hs-identifier hs-var">publicRootRetryTime</span></a><span class="hs-special">,</span><span>
</span><a name="line-1013"></a><span>                                </span><span class="hs-identifier">inProgressPublicRootsReq</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1014"></a><span>                              </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1015"></a><span>              </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1016"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-1017"></a><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-identifier">knownPeersBelowTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107583"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107583"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107584"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1021"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107583"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1022"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107583"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107584"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1023"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-1024"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107582"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107583"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107584"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><a name="knownPeersBelowTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#knownPeersBelowTarget"><span class="hs-identifier">knownPeersBelowTarget</span></a></a><span> </span><a name="local-6989586621679107728"><a href="#local-6989586621679107728"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-1026"></a><span>                      </span><a name="local-6989586621679107729"><a href="#local-6989586621679107729"><span class="hs-identifier">policy</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1027"></a><span>                        </span><a name="local-6989586621679107730"><a href="#local-6989586621679107730"><span class="hs-identifier">policyMaxInProgressGossipReqs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1028"></a><span>                        </span><a name="local-6989586621679107731"><a href="#local-6989586621679107731"><span class="hs-identifier">policyPickKnownPeersForGossip</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1029"></a><span>                        </span><a name="local-6989586621679107732"><a href="#local-6989586621679107732"><span class="hs-identifier">policyGossipRetryTime</span></a></a><span>
</span><a name="line-1030"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-1031"></a><span>                      </span><a name="local-6989586621679107733"><a href="#local-6989586621679107733"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1032"></a><span>                        </span><a name="local-6989586621679107734"><a href="#local-6989586621679107734"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1033"></a><span>                        </span><a name="local-6989586621679107735"><a href="#local-6989586621679107735"><span class="hs-identifier">inProgressGossipReqs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1034"></a><span>                        </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1035"></a><span>                                    </span><a name="local-6989586621679107736"><a href="#local-6989586621679107736"><span class="hs-identifier">targetNumberOfKnownPeers</span></a></a><span>
</span><a name="line-1036"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-1037"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-1038"></a><span>                      </span><a name="local-6989586621679107737"><a href="#local-6989586621679107737"><span class="hs-identifier">now</span></a></a><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-comment">-- Are we under target for number of known peers?</span><span>
</span><a name="line-1040"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107738"><span class="hs-identifier hs-var">numKnownPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679107736"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span>    </span><span class="hs-comment">-- Are we at our limit for number of gossip requests?</span><span>
</span><a name="line-1043"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107739"><span class="hs-identifier hs-var">numGossipReqsPossible</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span>    </span><span class="hs-comment">-- Are there any known peers that we can send a gossip request to?</span><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-comment">-- We can only ask ones where we have not asked them within a certain time.</span><span>
</span><a name="line-1047"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.null</span><span> </span><a href="#local-6989586621679107740"><span class="hs-identifier hs-var">availableForGossip</span></a><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1049"></a><span>      </span><a name="local-6989586621679107741"><a href="#local-6989586621679107741"><span class="hs-identifier">selectedForGossip</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1050"></a><span>                             </span><a href="#local-6989586621679107731"><span class="hs-identifier hs-var">policyPickKnownPeersForGossip</span></a><span>
</span><a name="line-1051"></a><span>                             </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107734"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1052"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107740"><span class="hs-identifier hs-var">availableForGossip</span></a><span class="hs-special">)</span><span>
</span><a name="line-1053"></a><span>                             </span><a href="#local-6989586621679107739"><span class="hs-identifier hs-var">numGossipReqsPossible</span></a><span>
</span><a name="line-1054"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107742"><a href="#local-6989586621679107742"><span class="hs-identifier">numGossipReqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107741"><span class="hs-identifier hs-var">selectedForGossip</span></a><span>
</span><a name="line-1055"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1056"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipRequests"><span class="hs-identifier hs-var">TraceGossipRequests</span></a><span>
</span><a name="line-1057"></a><span>                          </span><a href="#local-6989586621679107736"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1058"></a><span>                          </span><a href="#local-6989586621679107738"><span class="hs-identifier hs-var">numKnownPeers</span></a><span>
</span><a name="line-1059"></a><span>                          </span><a href="#local-6989586621679107740"><span class="hs-identifier hs-var">availableForGossip</span></a><span>
</span><a name="line-1060"></a><span>                          </span><a href="#local-6989586621679107741"><span class="hs-identifier hs-var">selectedForGossip</span></a><span class="hs-special">,</span><span>
</span><a name="line-1061"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107733"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1062"></a><span>                          </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107735"><span class="hs-identifier hs-var">inProgressGossipReqs</span></a><span>
</span><a name="line-1063"></a><span>                                               </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679107742"><span class="hs-identifier hs-var">numGossipReqs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1064"></a><span>                          </span><span class="hs-identifier">knownPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#setGossipTime"><span class="hs-identifier hs-var">KnownPeers.setGossipTime</span></a><span>
</span><a name="line-1065"></a><span>                                         </span><a href="#local-6989586621679107741"><span class="hs-identifier hs-var">selectedForGossip</span></a><span>
</span><a name="line-1066"></a><span>                                         </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#addTime"><span class="hs-identifier hs-var">addTime</span></a><span> </span><a href="#local-6989586621679107732"><span class="hs-identifier hs-var">policyGossipRetryTime</span></a><span> </span><a href="#local-6989586621679107737"><span class="hs-identifier hs-var">now</span></a><span class="hs-special">)</span><span>
</span><a name="line-1067"></a><span>                                         </span><a href="#local-6989586621679107734"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1068"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1069"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobGossip"><span class="hs-identifier hs-var">jobGossip</span></a><span> </span><a href="#local-6989586621679107728"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107729"><span class="hs-identifier hs-var">policy</span></a><span>
</span><a name="line-1070"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679107741"><span class="hs-identifier hs-var">selectedForGossip</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1071"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1072"></a><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-comment">-- If we could gossip except that there are none currently available</span><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-comment">-- then we return the next wakeup time (if any)</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107738"><span class="hs-identifier hs-var">numKnownPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679107736"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107739"><span class="hs-identifier hs-var">numGossipReqsPossible</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.null</span><span> </span><a href="#local-6989586621679107740"><span class="hs-identifier hs-var">availableForGossip</span></a><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Min</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#minGossipTime"><span class="hs-identifier hs-var">KnownPeers.minGossipTime</span></a><span> </span><a href="#local-6989586621679107734"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>
</span><a name="line-1080"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1081"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1083"></a><span>    </span><a name="local-6989586621679107738"><a href="#local-6989586621679107738"><span class="hs-identifier">numKnownPeers</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#size"><span class="hs-identifier hs-var">KnownPeers.size</span></a><span> </span><a href="#local-6989586621679107734"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1084"></a><span>    </span><a name="local-6989586621679107739"><a href="#local-6989586621679107739"><span class="hs-identifier">numGossipReqsPossible</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107730"><span class="hs-identifier hs-var">policyMaxInProgressGossipReqs</span></a><span>
</span><a name="line-1085"></a><span>                          </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107735"><span class="hs-identifier hs-var">inProgressGossipReqs</span></a><span>
</span><a name="line-1086"></a><span>    </span><a name="local-6989586621679107740"><a href="#local-6989586621679107740"><span class="hs-identifier">availableForGossip</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">KnownPeers.availableForGossip</span><span> </span><a href="#local-6989586621679107734"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1087"></a><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-identifier">jobGossip</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107579"><a href="#local-6989586621679107579"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107580"><a href="#local-6989586621679107580"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107581"><a href="#local-6989586621679107581"><span class="hs-identifier">peerconn</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1090"></a><span>             </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1091"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107581"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1092"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1093"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span>
</span><a name="line-1094"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107581"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><a name="jobGossip"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobGossip"><span class="hs-identifier">jobGossip</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107743"><a href="#local-6989586621679107743"><span class="hs-identifier">requestPeerGossip</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1096"></a><span>           </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1097"></a><span>    </span><span class="hs-glyph">\</span><a name="local-6989586621679107805"><a href="#local-6989586621679107805"><span class="hs-identifier">peers</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107756"><span class="hs-identifier hs-var">jobPhase1</span></a><span> </span><a href="#local-6989586621679107805"><span class="hs-identifier hs-var">peers</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107755"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679107805"><span class="hs-identifier hs-var">peers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1098"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1099"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107581"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1100"></a><span>    </span><a name="local-6989586621679107755"><a href="#local-6989586621679107755"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107758"><a href="#local-6989586621679107758"><span class="hs-identifier">peers</span></a></a><span> </span><a name="local-6989586621679107759"><a href="#local-6989586621679107759"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1101"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107760"><a href="#local-6989586621679107760"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1102"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1103"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipResults"><span class="hs-identifier hs-var">TraceGossipResults</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107761"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679107759"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679107761"><a href="#local-6989586621679107761"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107758"><span class="hs-identifier hs-var">peers</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1104"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107760"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1105"></a><span>                          </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><a href="#local-6989586621679107760"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1106"></a><span>                                               </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679107758"><span class="hs-identifier hs-var">peers</span></a><span>
</span><a name="line-1107"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1108"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1109"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1110"></a><span>
</span><a name="line-1111"></a><span>    </span><span class="hs-identifier">jobPhase1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107581"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>    </span><a name="local-6989586621679107756"><a href="#local-6989586621679107756"><span class="hs-identifier">jobPhase1</span></a></a><span> </span><a name="local-6989586621679107762"><a href="#local-6989586621679107762"><span class="hs-identifier">peers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1113"></a><span>      </span><span class="hs-comment">-- In the typical case, where most requests return within a short</span><span>
</span><a name="line-1114"></a><span>      </span><span class="hs-comment">-- timeout we want to collect all the responses into a batch and</span><span>
</span><a name="line-1115"></a><span>      </span><span class="hs-comment">-- add them to the known peers set in one go.</span><span>
</span><a name="line-1116"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1117"></a><span>      </span><span class="hs-comment">-- So fire them all off in one go:</span><span>
</span><a name="line-1118"></a><span>      </span><a name="local-6989586621679107764"><a href="#local-6989586621679107764"><span class="hs-identifier">gossips</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#async"><span class="hs-identifier hs-var">async</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107743"><span class="hs-identifier hs-var">requestPeerGossip</span></a><span> </span><a href="#local-6989586621679107763"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679107763"><a href="#local-6989586621679107763"><span class="hs-identifier">peer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107762"><span class="hs-identifier hs-var">peers</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1119"></a><span>
</span><a name="line-1120"></a><span>      </span><span class="hs-comment">-- First to finish synchronisation between /all/ the gossips completing</span><span>
</span><a name="line-1121"></a><span>      </span><span class="hs-comment">-- or the timeout (with whatever partial results we have at the time)</span><span>
</span><a name="line-1122"></a><span>      </span><a name="local-6989586621679107765"><a href="#local-6989586621679107765"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#waitAllCatchOrTimeout"><span class="hs-identifier hs-var">waitAllCatchOrTimeout</span></a><span> </span><a href="#local-6989586621679107764"><span class="hs-identifier hs-var">gossips</span></a><span> </span><a href="#local-6989586621679107753"><span class="hs-identifier hs-var">policyGossipBatchWaitTime</span></a><span>
</span><a name="line-1123"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107765"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1124"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107766"><a href="#local-6989586621679107766"><span class="hs-identifier">totalResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1125"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107767"><a href="#local-6989586621679107767"><span class="hs-identifier">peerResults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107762"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679107766"><span class="hs-identifier hs-var">totalResults</span></a><span>
</span><a name="line-1126"></a><span>              </span><a name="local-6989586621679107768"><a href="#local-6989586621679107768"><span class="hs-identifier">newPeers</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679107770"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107769"><a href="#local-6989586621679107769"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107766"><span class="hs-identifier hs-var">totalResults</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107770"><a href="#local-6989586621679107770"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107769"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1127"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107771"><a href="#local-6989586621679107771"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1128"></a><span>            </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipResults"><span class="hs-identifier hs-var">TraceGossipResults</span></a><span> </span><a href="#local-6989586621679107767"><span class="hs-identifier hs-var">peerResults</span></a><span class="hs-special">,</span><span>
</span><a name="line-1129"></a><span>            </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107771"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1130"></a><span>                              </span><span class="hs-comment">--TODO: also update with the failures</span><span>
</span><a name="line-1131"></a><span>                              </span><span class="hs-identifier">knownPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span>
</span><a name="line-1132"></a><span>                                             </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceGossip"><span class="hs-identifier hs-var">PeerSourceGossip</span></a><span>
</span><a name="line-1133"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#DoAdvertisePeer"><span class="hs-identifier hs-var">DoAdvertisePeer</span></a><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679107768"><span class="hs-identifier hs-var">newPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107771"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1136"></a><span>                              </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><a href="#local-6989586621679107771"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1137"></a><span>                                                   </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679107762"><span class="hs-identifier hs-var">peers</span></a><span>
</span><a name="line-1138"></a><span>                            </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1139"></a><span>            </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1140"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-1141"></a><span>
</span><a name="line-1142"></a><span>        </span><span class="hs-comment">-- But if any don't make the first timeout then they'll be added later</span><span>
</span><a name="line-1143"></a><span>        </span><span class="hs-comment">-- when they do reply or never if we hit the hard timeout.</span><span>
</span><a name="line-1144"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679107772"><a href="#local-6989586621679107772"><span class="hs-identifier">partialResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1145"></a><span>
</span><a name="line-1146"></a><span>          </span><span class="hs-comment">-- We have to keep track of the relationship between the peer</span><span>
</span><a name="line-1147"></a><span>          </span><span class="hs-comment">-- addresses and the gossip requests, completed and still in progress:</span><span>
</span><a name="line-1148"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107773"><a href="#local-6989586621679107773"><span class="hs-identifier">peerResults</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107777"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107778"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107777"><a href="#local-6989586621679107777"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679107778"><a href="#local-6989586621679107778"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107762"><span class="hs-identifier hs-var">peers</span></a><span>   </span><a href="#local-6989586621679107772"><span class="hs-identifier hs-var">partialResults</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1150"></a><span>              </span><a name="local-6989586621679107774"><a href="#local-6989586621679107774"><span class="hs-identifier">newPeers</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>  </span><a href="#local-6989586621679107780"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1151"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107779"><a href="#local-6989586621679107779"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>          </span><a href="#local-6989586621679107772"><span class="hs-identifier hs-var">partialResults</span></a><span>
</span><a name="line-1152"></a><span>                                 </span><span class="hs-special">,</span><span>  </span><a name="local-6989586621679107780"><a href="#local-6989586621679107780"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107779"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1153"></a><span>              </span><a name="local-6989586621679107775"><a href="#local-6989586621679107775"><span class="hs-identifier">peersRemaining</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>  </span><a href="#local-6989586621679107781"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1154"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107781"><a href="#local-6989586621679107781"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107762"><span class="hs-identifier hs-var">peers</span></a><span>   </span><a href="#local-6989586621679107772"><span class="hs-identifier hs-var">partialResults</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1155"></a><span>              </span><a name="local-6989586621679107776"><a href="#local-6989586621679107776"><span class="hs-identifier">gossipsRemaining</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>  </span><a href="#local-6989586621679107782"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1156"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107782"><a href="#local-6989586621679107782"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107764"><span class="hs-identifier hs-var">gossips</span></a><span> </span><a href="#local-6989586621679107772"><span class="hs-identifier hs-var">partialResults</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107783"><a href="#local-6989586621679107783"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1159"></a><span>            </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipResults"><span class="hs-identifier hs-var">TraceGossipResults</span></a><span> </span><a href="#local-6989586621679107773"><span class="hs-identifier hs-var">peerResults</span></a><span class="hs-special">,</span><span>
</span><a name="line-1160"></a><span>            </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107783"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1161"></a><span>                              </span><span class="hs-comment">--TODO: also update with the failures</span><span>
</span><a name="line-1162"></a><span>                              </span><span class="hs-identifier">knownPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span>
</span><a name="line-1163"></a><span>                                             </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceGossip"><span class="hs-identifier hs-var">PeerSourceGossip</span></a><span>
</span><a name="line-1164"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#DoAdvertisePeer"><span class="hs-identifier hs-var">DoAdvertisePeer</span></a><span class="hs-special">)</span><span>
</span><a name="line-1165"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679107774"><span class="hs-identifier hs-var">newPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1166"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107783"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1167"></a><span>                              </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><a href="#local-6989586621679107783"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1168"></a><span>                                                   </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679107773"><span class="hs-identifier hs-var">peerResults</span></a><span>
</span><a name="line-1169"></a><span>                            </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1170"></a><span>            </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107757"><span class="hs-identifier hs-var">jobPhase2</span></a><span> </span><a href="#local-6989586621679107775"><span class="hs-identifier hs-var">peersRemaining</span></a><span> </span><a href="#local-6989586621679107776"><span class="hs-identifier hs-var">gossipsRemaining</span></a><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span>                                 </span><span class="hs-special">(</span><a href="#local-6989586621679107755"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679107775"><span class="hs-identifier hs-var">peersRemaining</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1172"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span>    </span><span class="hs-identifier">jobPhase2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1175"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107579"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107580"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107581"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>    </span><a name="local-6989586621679107757"><a href="#local-6989586621679107757"><span class="hs-identifier">jobPhase2</span></a></a><span> </span><a name="local-6989586621679107784"><a href="#local-6989586621679107784"><span class="hs-identifier">peers</span></a></a><span> </span><a name="local-6989586621679107785"><a href="#local-6989586621679107785"><span class="hs-identifier">gossips</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>      </span><span class="hs-comment">-- Wait again, for all remaining to finish or a timeout.</span><span>
</span><a name="line-1179"></a><span>      </span><a name="local-6989586621679107786"><a href="#local-6989586621679107786"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#waitAllCatchOrTimeout"><span class="hs-identifier hs-var">waitAllCatchOrTimeout</span></a><span>
</span><a name="line-1180"></a><span>                      </span><a href="#local-6989586621679107785"><span class="hs-identifier hs-var">gossips</span></a><span>
</span><a name="line-1181"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621679107754"><span class="hs-identifier hs-var">policyGossipOverallTimeout</span></a><span>
</span><a name="line-1182"></a><span>                       </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107753"><span class="hs-identifier hs-var">policyGossipBatchWaitTime</span></a><span class="hs-special">)</span><span>
</span><a name="line-1183"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107787"><a href="#local-6989586621679107787"><span class="hs-identifier">peerResults</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1184"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107786"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1185"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107790"><a href="#local-6989586621679107790"><span class="hs-identifier">totalResults</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107784"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679107790"><span class="hs-identifier hs-var">totalResults</span></a><span>
</span><a name="line-1186"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679107791"><a href="#local-6989586621679107791"><span class="hs-identifier">partialResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107793"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621679107792"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="#local-6989586621679107794"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1187"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107793"><a href="#local-6989586621679107793"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107794"><a href="#local-6989586621679107794"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107784"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679107791"><span class="hs-identifier hs-var">partialResults</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1188"></a><span>                </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679107792"><a href="#local-6989586621679107792"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toException</span><span> </span><span class="hs-identifier hs-var">AsyncCancelled</span><span class="hs-special">)</span><span>
</span><a name="line-1189"></a><span>
</span><a name="line-1190"></a><span>          </span><a name="local-6989586621679107788"><a href="#local-6989586621679107788"><span class="hs-identifier">newPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1191"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107786"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1192"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107795"><a href="#local-6989586621679107795"><span class="hs-identifier">totalResults</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679107797"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107796"><a href="#local-6989586621679107796"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107795"><span class="hs-identifier hs-var">totalResults</span></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679107797"><a href="#local-6989586621679107797"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107796"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1193"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679107798"><a href="#local-6989586621679107798"><span class="hs-identifier">partialResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679107800"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107799"><a href="#local-6989586621679107799"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107798"><span class="hs-identifier hs-var">partialResults</span></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679107800"><a href="#local-6989586621679107800"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107799"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1194"></a><span>
</span><a name="line-1195"></a><span>          </span><a name="local-6989586621679107789"><a href="#local-6989586621679107789"><span class="hs-identifier">gossipsIncomplete</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1196"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107786"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1197"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679107801"><a href="#local-6989586621679107801"><span class="hs-identifier">_totalResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1198"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679107802"><a href="#local-6989586621679107802"><span class="hs-identifier">partialResults</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1199"></a><span>                </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679107803"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107803"><a href="#local-6989586621679107803"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679107785"><span class="hs-identifier hs-var">gossips</span></a><span> </span><a href="#local-6989586621679107802"><span class="hs-identifier hs-var">partialResults</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#cancel"><span class="hs-identifier hs-var">cancel</span></a><span> </span><a href="#local-6989586621679107789"><span class="hs-identifier hs-var">gossipsIncomplete</span></a><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107804"><a href="#local-6989586621679107804"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1204"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceGossipResults"><span class="hs-identifier hs-var">TraceGossipResults</span></a><span> </span><a href="#local-6989586621679107787"><span class="hs-identifier hs-var">peerResults</span></a><span class="hs-special">,</span><span>
</span><a name="line-1205"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107804"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1206"></a><span>                          </span><span class="hs-comment">--TODO: also update with the failures</span><span>
</span><a name="line-1207"></a><span>                          </span><span class="hs-identifier">knownPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span>
</span><a name="line-1208"></a><span>                                         </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceGossip"><span class="hs-identifier hs-var">PeerSourceGossip</span></a><span>
</span><a name="line-1209"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#DoAdvertisePeer"><span class="hs-identifier hs-var">DoAdvertisePeer</span></a><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679107788"><span class="hs-identifier hs-var">newPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1211"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107804"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1212"></a><span>                          </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inProgressGossipReqs</span><span> </span><a href="#local-6989586621679107804"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1213"></a><span>                                               </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679107784"><span class="hs-identifier hs-var">peers</span></a><span>
</span><a name="line-1214"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1215"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1216"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span>
</span><a name="line-1219"></a><span class="hs-identifier">knownPeersAboveTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107576"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107577"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1220"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107577"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107576"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1221"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107577"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107578"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1222"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107576"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107576"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107577"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107578"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1223"></a><a name="knownPeersAboveTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#knownPeersAboveTarget"><span class="hs-identifier">knownPeersAboveTarget</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1224"></a><span>                        </span><a name="local-6989586621679107806"><a href="#local-6989586621679107806"><span class="hs-identifier">policyPickColdPeersToForget</span></a></a><span>
</span><a name="line-1225"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-1226"></a><span>                      </span><a name="local-6989586621679107807"><a href="#local-6989586621679107807"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1227"></a><span>                        </span><a name="local-6989586621679107808"><a href="#local-6989586621679107808"><span class="hs-identifier">localRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1228"></a><span>                        </span><a name="local-6989586621679107809"><a href="#local-6989586621679107809"><span class="hs-identifier">publicRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1229"></a><span>                        </span><a name="local-6989586621679107810"><a href="#local-6989586621679107810"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1230"></a><span>                        </span><a name="local-6989586621679107811"><a href="#local-6989586621679107811"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1231"></a><span>                        </span><a name="local-6989586621679107812"><a href="#local-6989586621679107812"><span class="hs-identifier">inProgressPromoteCold</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1232"></a><span>                        </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1233"></a><span>                                    </span><a name="local-6989586621679107813"><a href="#local-6989586621679107813"><span class="hs-identifier">targetNumberOfKnownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1234"></a><span>                                    </span><a name="local-6989586621679107814"><a href="#local-6989586621679107814"><span class="hs-identifier">targetNumberOfRootPeers</span></a></a><span>
</span><a name="line-1235"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-1236"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-1237"></a><span>    </span><span class="hs-comment">-- Are we above the target for number of known peers?</span><span>
</span><a name="line-1238"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107815"><span class="hs-identifier hs-var">numKnownPeers</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679107813"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span>    </span><span class="hs-comment">-- Are there any cold peers we could pick to forget?</span><span>
</span><a name="line-1241"></a><span>    </span><span class="hs-comment">-- As a first cheap approximation, check if there are any cold peers.</span><span>
</span><a name="line-1242"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107815"><span class="hs-identifier hs-var">numKnownPeers</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679107816"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span>    </span><span class="hs-comment">-- Beyond this it gets more complicated, and it is not clear that there</span><span>
</span><a name="line-1245"></a><span>    </span><span class="hs-comment">-- are any precise cheap checks. So we just do the full calculation.</span><span>
</span><a name="line-1246"></a><span>    </span><span class="hs-comment">-- In particular there can be overlap between cold peers and root peers</span><span>
</span><a name="line-1247"></a><span>    </span><span class="hs-comment">-- and we have constraints on forgetting root peers.</span><span>
</span><a name="line-1248"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1249"></a><span>    </span><span class="hs-comment">-- We must never pick local root peers to forget as this would violate</span><span>
</span><a name="line-1250"></a><span>    </span><span class="hs-comment">-- our invariant that the localRootPeers is a subset of the knownPeers.</span><span>
</span><a name="line-1251"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1252"></a><span>    </span><span class="hs-comment">-- We also need to avoid picking public root peers if that would put us</span><span>
</span><a name="line-1253"></a><span>    </span><span class="hs-comment">-- below the target for root peers.</span><span>
</span><a name="line-1254"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1255"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107817"><a href="#local-6989586621679107817"><span class="hs-identifier">numRootPeersCanForget</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107808"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-1256"></a><span>                              </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107809"><span class="hs-identifier hs-var">publicRootPeers</span></a><span>
</span><a name="line-1257"></a><span>                              </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107814"><span class="hs-identifier hs-var">targetNumberOfRootPeers</span></a><span>
</span><a name="line-1258"></a><span>        </span><a name="local-6989586621679107818"><a href="#local-6989586621679107818"><span class="hs-identifier">protectedRootPeers</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107808"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-1259"></a><span>                             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">Set.drop</span><span> </span><a href="#local-6989586621679107817"><span class="hs-identifier hs-var">numRootPeersCanForget</span></a><span> </span><a href="#local-6989586621679107809"><span class="hs-identifier hs-var">publicRootPeers</span></a><span>
</span><a name="line-1260"></a><span>        </span><a name="local-6989586621679107819"><a href="#local-6989586621679107819"><span class="hs-identifier">availableToForget</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107810"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1261"></a><span>                                   </span><span class="hs-operator hs-var">Map.\\</span><span> </span><a href="#local-6989586621679107811"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1262"></a><span>                                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107818"><span class="hs-identifier hs-var">protectedRootPeers</span></a><span>
</span><a name="line-1263"></a><span>                                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107812"><span class="hs-identifier hs-var">inProgressPromoteCold</span></a><span>
</span><a name="line-1264"></a><span>
</span><a name="line-1265"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.null</span><span> </span><a href="#local-6989586621679107819"><span class="hs-identifier hs-var">availableToForget</span></a><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1267"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107820"><a href="#local-6989586621679107820"><span class="hs-identifier">numPeersToForget</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107815"><span class="hs-identifier hs-var">numKnownPeers</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107813"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1268"></a><span>      </span><a name="local-6989586621679107821"><a href="#local-6989586621679107821"><span class="hs-identifier">selectedToForget</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1269"></a><span>                            </span><a href="#local-6989586621679107806"><span class="hs-identifier hs-var">policyPickColdPeersToForget</span></a><span>
</span><a name="line-1270"></a><span>                            </span><a href="#local-6989586621679107819"><span class="hs-identifier hs-var">availableToForget</span></a><span>
</span><a name="line-1271"></a><span>                            </span><a href="#local-6989586621679107820"><span class="hs-identifier hs-var">numPeersToForget</span></a><span>
</span><a name="line-1272"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1273"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceForgetColdPeers"><span class="hs-identifier hs-var">TraceForgetColdPeers</span></a><span>
</span><a name="line-1274"></a><span>                          </span><a href="#local-6989586621679107813"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span>
</span><a name="line-1275"></a><span>                          </span><a href="#local-6989586621679107815"><span class="hs-identifier hs-var">numKnownPeers</span></a><span>
</span><a name="line-1276"></a><span>                          </span><a href="#local-6989586621679107821"><span class="hs-identifier hs-var">selectedToForget</span></a><span class="hs-special">,</span><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107807"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1278"></a><span>                          </span><span class="hs-identifier">knownPeers</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#delete"><span class="hs-identifier hs-var">KnownPeers.delete</span></a><span>
</span><a name="line-1279"></a><span>                                              </span><a href="#local-6989586621679107821"><span class="hs-identifier hs-var">selectedToForget</span></a><span>
</span><a name="line-1280"></a><span>                                              </span><a href="#local-6989586621679107810"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">,</span><span>
</span><a name="line-1281"></a><span>                          </span><span class="hs-identifier">publicRootPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107809"><span class="hs-identifier hs-var">publicRootPeers</span></a><span>
</span><a name="line-1282"></a><span>                                              </span><span class="hs-operator hs-var">Set.\\</span><span> </span><a href="#local-6989586621679107821"><span class="hs-identifier hs-var">selectedToForget</span></a><span>
</span><a name="line-1283"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1284"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1285"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1286"></a><span>
</span><a name="line-1287"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1289"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1290"></a><span>    </span><span class="hs-identifier">numKnownPeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numEstablishedPeers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1291"></a><span>    </span><a name="local-6989586621679107815"><a href="#local-6989586621679107815"><span class="hs-identifier">numKnownPeers</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#size"><span class="hs-identifier hs-var">KnownPeers.size</span></a><span> </span><a href="#local-6989586621679107810"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1292"></a><span>    </span><a name="local-6989586621679107816"><a href="#local-6989586621679107816"><span class="hs-identifier">numEstablishedPeers</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107811"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-identifier">establishedPeersBelowTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107573"><a href="#local-6989586621679107573"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107574"><a href="#local-6989586621679107574"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107575"><a href="#local-6989586621679107575"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1296"></a><span>                               </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107575"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107574"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107575"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1298"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107575"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1299"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107574"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1300"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107575"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107575"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107574"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1301"></a><a name="establishedPeersBelowTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedPeersBelowTarget"><span class="hs-identifier">establishedPeersBelowTarget</span></a></a><span> </span><a name="local-6989586621679107822"><a href="#local-6989586621679107822"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-1302"></a><span>                            </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1303"></a><span>                              </span><a name="local-6989586621679107823"><a href="#local-6989586621679107823"><span class="hs-identifier">policyPickColdPeersToPromote</span></a></a><span>
</span><a name="line-1304"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-1305"></a><span>                            </span><a name="local-6989586621679107824"><a href="#local-6989586621679107824"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1306"></a><span>                              </span><a name="local-6989586621679107825"><a href="#local-6989586621679107825"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1307"></a><span>                              </span><a name="local-6989586621679107826"><a href="#local-6989586621679107826"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1308"></a><span>                              </span><a name="local-6989586621679107827"><a href="#local-6989586621679107827"><span class="hs-identifier">inProgressPromoteCold</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1309"></a><span>                              </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1310"></a><span>                                          </span><a name="local-6989586621679107828"><a href="#local-6989586621679107828"><span class="hs-identifier">targetNumberOfEstablishedPeers</span></a></a><span>
</span><a name="line-1311"></a><span>                                        </span><span class="hs-special">}</span><span>
</span><a name="line-1312"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-1313"></a><span>    </span><span class="hs-comment">-- Are we below the target for number of established peers?</span><span>
</span><a name="line-1314"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107829"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679107830"><span class="hs-identifier hs-var">numConnectInProgress</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679107828"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span>    </span><span class="hs-comment">-- Are there any cold peers we could possibly pick to connect to?</span><span>
</span><a name="line-1317"></a><span>    </span><span class="hs-comment">-- We can subtract the established ones because by definition they are</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-comment">-- not cold and our invariant is that they are always in the connect set.</span><span>
</span><a name="line-1319"></a><span>    </span><span class="hs-comment">-- We can also subtract the in progress ones since they are also already</span><span>
</span><a name="line-1320"></a><span>    </span><span class="hs-comment">-- in the connect set and we cannot pick them again.</span><span>
</span><a name="line-1321"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107831"><span class="hs-identifier hs-var">availableToConnect</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107829"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107830"><span class="hs-identifier hs-var">numConnectInProgress</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1322"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1323"></a><span>      </span><span class="hs-comment">-- The availableToPromote here is non-empty due to the second guard.</span><span>
</span><a name="line-1324"></a><span>      </span><span class="hs-comment">-- The known peers map restricted to the connect set is the same size as</span><span>
</span><a name="line-1325"></a><span>      </span><span class="hs-comment">-- the connect set (because it is a subset). The establishedPeers is a</span><span>
</span><a name="line-1326"></a><span>      </span><span class="hs-comment">-- subset of the connect set and we also know that there is no overlap</span><span>
</span><a name="line-1327"></a><span>      </span><span class="hs-comment">-- between inProgressPromoteCold and establishedPeers. QED.</span><span>
</span><a name="line-1328"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1329"></a><span>      </span><span class="hs-comment">-- The numPeersToPromote is positive based on the first guard.</span><span>
</span><a name="line-1330"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1331"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">availableToPromote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107573"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span>
</span><a name="line-1332"></a><span>          </span><a name="local-6989586621679107832"><a href="#local-6989586621679107832"><span class="hs-identifier">availableToPromote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107825"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1333"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107831"><span class="hs-identifier hs-var">availableToConnect</span></a><span>
</span><a name="line-1334"></a><span>                                 </span><span class="hs-operator hs-var">Map.\\</span><span> </span><a href="#local-6989586621679107826"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1335"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107827"><span class="hs-identifier hs-var">inProgressPromoteCold</span></a><span>
</span><a name="line-1336"></a><span>          </span><a name="local-6989586621679107833"><a href="#local-6989586621679107833"><span class="hs-identifier">numPeersToPromote</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107828"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-1337"></a><span>                             </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107829"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1338"></a><span>                             </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107830"><span class="hs-identifier hs-var">numConnectInProgress</span></a><span>
</span><a name="line-1339"></a><span>      </span><a name="local-6989586621679107834"><a href="#local-6989586621679107834"><span class="hs-identifier">selectedToPromote</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1340"></a><span>                             </span><a href="#local-6989586621679107823"><span class="hs-identifier hs-var">policyPickColdPeersToPromote</span></a><span>
</span><a name="line-1341"></a><span>                             </span><a href="#local-6989586621679107832"><span class="hs-identifier hs-var">availableToPromote</span></a><span>
</span><a name="line-1342"></a><span>                             </span><a href="#local-6989586621679107833"><span class="hs-identifier hs-var">numPeersToPromote</span></a><span>
</span><a name="line-1343"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1344"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdPeers"><span class="hs-identifier hs-var">TracePromoteColdPeers</span></a><span>
</span><a name="line-1345"></a><span>                          </span><a href="#local-6989586621679107828"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-1346"></a><span>                          </span><a href="#local-6989586621679107829"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1347"></a><span>                          </span><a href="#local-6989586621679107834"><span class="hs-identifier hs-var">selectedToPromote</span></a><span class="hs-special">,</span><span>
</span><a name="line-1348"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107824"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1349"></a><span>                          </span><span class="hs-identifier">inProgressPromoteCold</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107827"><span class="hs-identifier hs-var">inProgressPromoteCold</span></a><span>
</span><a name="line-1350"></a><span>                                               </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107834"><span class="hs-identifier hs-var">selectedToPromote</span></a><span>
</span><a name="line-1351"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1352"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobPromoteColdPeer"><span class="hs-identifier hs-var">jobPromoteColdPeer</span></a><span> </span><a href="#local-6989586621679107822"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107835"><span class="hs-identifier hs-var">peer</span></a><span>
</span><a name="line-1353"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679107835"><a href="#local-6989586621679107835"><span class="hs-identifier">peer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679107834"><span class="hs-identifier hs-var">selectedToPromote</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1354"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1355"></a><span>
</span><a name="line-1356"></a><span>    </span><span class="hs-comment">-- If we could connect except that there are no peers currently available</span><span>
</span><a name="line-1357"></a><span>    </span><span class="hs-comment">-- then we return the next wakeup time (if any)</span><span>
</span><a name="line-1358"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107829"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679107830"><span class="hs-identifier hs-var">numConnectInProgress</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679107828"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-1359"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Min</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#minConnectTime"><span class="hs-identifier hs-var">KnownPeers.minConnectTime</span></a><span> </span><a href="#local-6989586621679107825"><span class="hs-identifier hs-var">knownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1362"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1363"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1364"></a><span>    </span><span class="hs-identifier">numEstablishedPeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numConnectInProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1365"></a><span>    </span><a name="local-6989586621679107829"><a href="#local-6989586621679107829"><span class="hs-identifier">numEstablishedPeers</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107826"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1366"></a><span>    </span><a name="local-6989586621679107830"><a href="#local-6989586621679107830"><span class="hs-identifier">numConnectInProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107827"><span class="hs-identifier hs-var">inProgressPromoteCold</span></a><span>
</span><a name="line-1367"></a><span>    </span><a name="local-6989586621679107831"><a href="#local-6989586621679107831"><span class="hs-identifier">availableToConnect</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">KnownPeers.availableToConnect</span><span> </span><a href="#local-6989586621679107825"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1368"></a><span>
</span><a name="line-1369"></a><span class="hs-identifier">jobPromoteColdPeer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107570"><a href="#local-6989586621679107570"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107571"><a href="#local-6989586621679107571"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107572"><a href="#local-6989586621679107572"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1370"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1371"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107571"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1372"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-1373"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107571"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1374"></a><a name="jobPromoteColdPeer"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobPromoteColdPeer"><span class="hs-identifier">jobPromoteColdPeer</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107836"><a href="#local-6989586621679107836"><span class="hs-identifier">establishPeerConnection</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679107837"><a href="#local-6989586621679107837"><span class="hs-identifier">peeraddr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1375"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><a href="#local-6989586621679107839"><span class="hs-identifier hs-var">job</span></a><span> </span><a href="#local-6989586621679107838"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-1376"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1377"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107571"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1378"></a><span>    </span><a name="local-6989586621679107838"><a href="#local-6989586621679107838"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107840"><a href="#local-6989586621679107840"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1379"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107841"><a href="#local-6989586621679107841"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107842"><a href="#local-6989586621679107842"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1380"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdFailed"><span class="hs-identifier hs-var">TracePromoteColdFailed</span></a><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107840"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span>
</span><a name="line-1381"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107841"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1382"></a><span>                          </span><span class="hs-identifier">knownPeers</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#incrementFailCount"><span class="hs-identifier hs-var">KnownPeers.incrementFailCount</span></a><span>
</span><a name="line-1383"></a><span>                                                    </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">knownPeers</span><span> </span><a href="#local-6989586621679107841"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1384"></a><span>                          </span><span class="hs-identifier">inProgressPromoteCold</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1385"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">inProgressPromoteCold</span><span> </span><a href="#local-6989586621679107841"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1386"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1387"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1388"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span>    </span><span class="hs-identifier">job</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107572"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107570"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107571"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1391"></a><span>    </span><a name="local-6989586621679107839"><a href="#local-6989586621679107839"><span class="hs-identifier">job</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1392"></a><span>      </span><span class="hs-comment">--TODO: decide if we should do timeouts here or if we should make that</span><span>
</span><a name="line-1393"></a><span>      </span><span class="hs-comment">-- the responsibility of establishPeerConnection</span><span>
</span><a name="line-1394"></a><span>      </span><a name="local-6989586621679107843"><a href="#local-6989586621679107843"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107836"><span class="hs-identifier hs-var">establishPeerConnection</span></a><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1395"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107844"><a href="#local-6989586621679107844"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107845"><a href="#local-6989586621679107845"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1396"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteColdDone"><span class="hs-identifier hs-var">TracePromoteColdDone</span></a><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span class="hs-special">,</span><span>
</span><a name="line-1397"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107844"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1398"></a><span>                          </span><span class="hs-identifier">establishedPeers</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107843"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1399"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">establishedPeers</span><span> </span><a href="#local-6989586621679107844"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1400"></a><span>                          </span><span class="hs-identifier">establishedStatus</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span>
</span><a name="line-1401"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">establishedStatus</span><span> </span><a href="#local-6989586621679107844"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1402"></a><span>                          </span><span class="hs-identifier">inProgressPromoteCold</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107837"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1403"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">inProgressPromoteCold</span><span> </span><a href="#local-6989586621679107844"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1404"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1405"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1406"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1407"></a><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span class="hs-identifier">establishedPeersAboveTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107567"><a href="#local-6989586621679107567"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107568"><a href="#local-6989586621679107568"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107569"><a href="#local-6989586621679107569"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1410"></a><span>                               </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107569"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1411"></a><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107568"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107569"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1412"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107569"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1413"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107568"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1414"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107569"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107569"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107568"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1415"></a><a name="establishedPeersAboveTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#establishedPeersAboveTarget"><span class="hs-identifier">establishedPeersAboveTarget</span></a></a><span> </span><a name="local-6989586621679107846"><a href="#local-6989586621679107846"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-1416"></a><span>                            </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1417"></a><span>                              </span><a name="local-6989586621679107847"><a href="#local-6989586621679107847"><span class="hs-identifier">policyPickWarmPeersToDemote</span></a></a><span>
</span><a name="line-1418"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-1419"></a><span>                            </span><a name="local-6989586621679107848"><a href="#local-6989586621679107848"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1420"></a><span>                              </span><a name="local-6989586621679107849"><a href="#local-6989586621679107849"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1421"></a><span>                              </span><a name="local-6989586621679107850"><a href="#local-6989586621679107850"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1422"></a><span>                              </span><a name="local-6989586621679107851"><a href="#local-6989586621679107851"><span class="hs-identifier">activePeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1423"></a><span>                              </span><a name="local-6989586621679107852"><a href="#local-6989586621679107852"><span class="hs-identifier">inProgressDemoteWarm</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1424"></a><span>                              </span><a name="local-6989586621679107853"><a href="#local-6989586621679107853"><span class="hs-identifier">inProgressPromoteWarm</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1425"></a><span>                              </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1426"></a><span>                                          </span><a name="local-6989586621679107854"><a href="#local-6989586621679107854"><span class="hs-identifier">targetNumberOfEstablishedPeers</span></a></a><span>
</span><a name="line-1427"></a><span>                                        </span><span class="hs-special">}</span><span>
</span><a name="line-1428"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-1429"></a><span>    </span><span class="hs-comment">-- Are we above the target for number of established peers?</span><span>
</span><a name="line-1430"></a><span>    </span><span class="hs-comment">-- Or more precisely, how many established peers could we demote?</span><span>
</span><a name="line-1431"></a><span>    </span><span class="hs-comment">-- We only want to pick established peers that are not active, since for</span><span>
</span><a name="line-1432"></a><span>    </span><span class="hs-comment">-- active one we need to demote them first.</span><span>
</span><a name="line-1433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">numEstablishedPeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numActivePeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numPeersToDemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1434"></a><span>        </span><a name="local-6989586621679107855"><a href="#local-6989586621679107855"><span class="hs-identifier">numEstablishedPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107850"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1435"></a><span>        </span><a name="local-6989586621679107856"><a href="#local-6989586621679107856"><span class="hs-identifier">numActivePeers</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107851"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1436"></a><span>        </span><span class="hs-comment">-- One constraint on how many to demote is the difference in the</span><span>
</span><a name="line-1437"></a><span>        </span><span class="hs-comment">-- number we have now vs the target. The other constraint is that</span><span>
</span><a name="line-1438"></a><span>        </span><span class="hs-comment">-- we pick established peers that are not also active. These</span><span>
</span><a name="line-1439"></a><span>        </span><span class="hs-comment">-- constraints combine by taking the minimum. We must also subtract</span><span>
</span><a name="line-1440"></a><span>        </span><span class="hs-comment">-- the number we're demoting so we don't repeat the same work. And</span><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-comment">-- cannot demote ones we're in the process of promoting.</span><span>
</span><a name="line-1442"></a><span>        </span><a name="local-6989586621679107857"><a href="#local-6989586621679107857"><span class="hs-identifier">numPeersToDemote</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107855"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1443"></a><span>                                   </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107854"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1444"></a><span>                                  </span><span class="hs-special">(</span><a href="#local-6989586621679107855"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1445"></a><span>                                   </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107856"><span class="hs-identifier hs-var">numActivePeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1446"></a><span>                            </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107852"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>
</span><a name="line-1447"></a><span>                            </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107853"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span>
</span><a name="line-1448"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107857"><span class="hs-identifier hs-var">numPeersToDemote</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1449"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">availableToDemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span>
</span><a name="line-1452"></a><span>          </span><a name="local-6989586621679107858"><a href="#local-6989586621679107858"><span class="hs-identifier">availableToDemote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107849"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1453"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.intersection</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107850"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1454"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107851"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1455"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107852"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>
</span><a name="line-1456"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107853"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span>
</span><a name="line-1457"></a><span>      </span><a name="local-6989586621679107859"><a href="#local-6989586621679107859"><span class="hs-identifier">selectedToDemote</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1458"></a><span>                            </span><a href="#local-6989586621679107847"><span class="hs-identifier hs-var">policyPickWarmPeersToDemote</span></a><span>
</span><a name="line-1459"></a><span>                            </span><a href="#local-6989586621679107858"><span class="hs-identifier hs-var">availableToDemote</span></a><span>
</span><a name="line-1460"></a><span>                            </span><a href="#local-6989586621679107857"><span class="hs-identifier hs-var">numPeersToDemote</span></a><span>
</span><a name="line-1461"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">selectedToDemote'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107567"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107568"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1462"></a><span>          </span><a name="local-6989586621679107860"><a href="#local-6989586621679107860"><span class="hs-identifier">selectedToDemote'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107850"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1463"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107859"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1464"></a><span>
</span><a name="line-1465"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1466"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmPeers"><span class="hs-identifier hs-var">TraceDemoteWarmPeers</span></a><span>
</span><a name="line-1467"></a><span>                          </span><a href="#local-6989586621679107854"><span class="hs-identifier hs-var">targetNumberOfEstablishedPeers</span></a><span>
</span><a name="line-1468"></a><span>                          </span><a href="#local-6989586621679107855"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span>
</span><a name="line-1469"></a><span>                          </span><a href="#local-6989586621679107859"><span class="hs-identifier hs-var">selectedToDemote</span></a><span class="hs-special">,</span><span>
</span><a name="line-1470"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107848"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1471"></a><span>                          </span><span class="hs-identifier">inProgressDemoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107852"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>
</span><a name="line-1472"></a><span>                                              </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107859"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1473"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1474"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobDemoteEstablishedPeer"><span class="hs-identifier hs-var">jobDemoteEstablishedPeer</span></a><span> </span><a href="#local-6989586621679107846"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107861"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107862"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1475"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107861"><a href="#local-6989586621679107861"><span class="hs-identifier">peeraddr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107862"><a href="#local-6989586621679107862"><span class="hs-identifier">peerconn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.assocs</span><span> </span><a href="#local-6989586621679107860"><span class="hs-identifier hs-var">selectedToDemote'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1476"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1479"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1480"></a><span>
</span><a name="line-1481"></a><span class="hs-identifier">jobDemoteEstablishedPeer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107564"><a href="#local-6989586621679107564"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107565"><a href="#local-6989586621679107565"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107566"><a href="#local-6989586621679107566"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1482"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1483"></a><span>                         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107565"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1484"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-1485"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107565"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1486"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107565"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1487"></a><a name="jobDemoteEstablishedPeer"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobDemoteEstablishedPeer"><span class="hs-identifier">jobDemoteEstablishedPeer</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107863"><a href="#local-6989586621679107863"><span class="hs-identifier">closePeerConnection</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1488"></a><span>                         </span><a name="local-6989586621679107864"><a href="#local-6989586621679107864"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107865"><a href="#local-6989586621679107865"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1489"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><a href="#local-6989586621679107867"><span class="hs-identifier hs-var">job</span></a><span> </span><a href="#local-6989586621679107866"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-1490"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1491"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107565"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1492"></a><span>    </span><a name="local-6989586621679107866"><a href="#local-6989586621679107866"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107868"><a href="#local-6989586621679107868"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1493"></a><span>      </span><span class="hs-comment">-- It's quite bad if closing fails, but the best we can do is revert to</span><span>
</span><a name="line-1494"></a><span>      </span><span class="hs-comment">-- the state where we believed this peer is still warm, since then we</span><span>
</span><a name="line-1495"></a><span>      </span><span class="hs-comment">-- can have another go or perhaps it'll be closed for other reasons and</span><span>
</span><a name="line-1496"></a><span>      </span><span class="hs-comment">-- our monitoring will notice it.</span><span>
</span><a name="line-1497"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107869"><a href="#local-6989586621679107869"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107870"><a href="#local-6989586621679107870"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1498"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmFailed"><span class="hs-identifier hs-var">TraceDemoteWarmFailed</span></a><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107868"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span>
</span><a name="line-1499"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107869"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1500"></a><span>                          </span><span class="hs-identifier">inProgressDemoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1501"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier">inProgressDemoteWarm</span><span> </span><a href="#local-6989586621679107869"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1502"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1503"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1504"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1505"></a><span>
</span><a name="line-1506"></a><span>    </span><span class="hs-identifier">job</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107566"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107564"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107565"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1507"></a><span>    </span><a name="local-6989586621679107867"><a href="#local-6989586621679107867"><span class="hs-identifier">job</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1508"></a><span>      </span><a href="#local-6989586621679107863"><span class="hs-identifier hs-var">closePeerConnection</span></a><span> </span><a href="#local-6989586621679107865"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1509"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107871"><a href="#local-6989586621679107871"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107872"><a href="#local-6989586621679107872"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1510"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteWarmDone"><span class="hs-identifier hs-var">TraceDemoteWarmDone</span></a><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span class="hs-special">,</span><span>
</span><a name="line-1511"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107871"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1512"></a><span>                          </span><span class="hs-identifier">establishedPeers</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.delete</span><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1513"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier">establishedPeers</span><span> </span><a href="#local-6989586621679107871"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1514"></a><span>                          </span><span class="hs-identifier">establishedStatus</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.delete</span><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1515"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier">establishedStatus</span><span> </span><a href="#local-6989586621679107871"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1516"></a><span>                          </span><span class="hs-identifier">inProgressDemoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107864"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1517"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier">inProgressDemoteWarm</span><span> </span><a href="#local-6989586621679107871"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1518"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1519"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1520"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1521"></a><span>
</span><a name="line-1522"></a><span class="hs-identifier">activePeersBelowTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107561"><a href="#local-6989586621679107561"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107562"><a href="#local-6989586621679107562"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107563"><a href="#local-6989586621679107563"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1523"></a><span>                          </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107563"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107562"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107563"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1525"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107563"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1526"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107562"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1527"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107563"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107563"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107562"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1528"></a><a name="activePeersBelowTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#activePeersBelowTarget"><span class="hs-identifier">activePeersBelowTarget</span></a></a><span> </span><a name="local-6989586621679107873"><a href="#local-6989586621679107873"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-1529"></a><span>                       </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1530"></a><span>                         </span><a name="local-6989586621679107874"><a href="#local-6989586621679107874"><span class="hs-identifier">policyPickWarmPeersToPromote</span></a></a><span>
</span><a name="line-1531"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1532"></a><span>                       </span><a name="local-6989586621679107875"><a href="#local-6989586621679107875"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1533"></a><span>                         </span><a name="local-6989586621679107876"><a href="#local-6989586621679107876"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1534"></a><span>                         </span><a name="local-6989586621679107877"><a href="#local-6989586621679107877"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1535"></a><span>                         </span><a name="local-6989586621679107878"><a href="#local-6989586621679107878"><span class="hs-identifier">activePeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1536"></a><span>                         </span><a name="local-6989586621679107879"><a href="#local-6989586621679107879"><span class="hs-identifier">inProgressPromoteWarm</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1537"></a><span>                         </span><a name="local-6989586621679107880"><a href="#local-6989586621679107880"><span class="hs-identifier">inProgressDemoteWarm</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1538"></a><span>                         </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1539"></a><span>                                     </span><a name="local-6989586621679107881"><a href="#local-6989586621679107881"><span class="hs-identifier">targetNumberOfActivePeers</span></a></a><span>
</span><a name="line-1540"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-1541"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1542"></a><span>    </span><span class="hs-comment">-- Are we below the target for number of active peers?</span><span>
</span><a name="line-1543"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107883"><span class="hs-identifier hs-var">numActivePeers</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679107884"><span class="hs-identifier hs-var">numPromoteInProgress</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679107881"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-1544"></a><span>
</span><a name="line-1545"></a><span>    </span><span class="hs-comment">-- Are there any warm peers we could pick to promote?</span><span>
</span><a name="line-1546"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107882"><span class="hs-identifier hs-var">numEstablishedPeers</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107883"><span class="hs-identifier hs-var">numActivePeers</span></a><span>
</span><a name="line-1547"></a><span>                        </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107884"><span class="hs-identifier hs-var">numPromoteInProgress</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107885"><span class="hs-identifier hs-var">numDemoteInProgress</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1549"></a><span>          </span><span class="hs-comment">-- The availableToPromote is non-empty due to the second guard.</span><span>
</span><a name="line-1550"></a><span>          </span><span class="hs-comment">-- The numPeersToPromote is positive due to the first guard.</span><span>
</span><a name="line-1551"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">availableToPromote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span>
</span><a name="line-1552"></a><span>          </span><a name="local-6989586621679107886"><a href="#local-6989586621679107886"><span class="hs-identifier">availableToPromote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107876"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1553"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.intersection</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107877"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1554"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107878"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1555"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107879"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span>
</span><a name="line-1556"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107880"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>
</span><a name="line-1557"></a><span>          </span><a name="local-6989586621679107887"><a href="#local-6989586621679107887"><span class="hs-identifier">numPeersToPromote</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107881"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-1558"></a><span>                             </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107883"><span class="hs-identifier hs-var">numActivePeers</span></a><span>
</span><a name="line-1559"></a><span>                             </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107884"><span class="hs-identifier hs-var">numPromoteInProgress</span></a><span>
</span><a name="line-1560"></a><span>      </span><a name="local-6989586621679107888"><a href="#local-6989586621679107888"><span class="hs-identifier">selectedToPromote</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1561"></a><span>                             </span><a href="#local-6989586621679107874"><span class="hs-identifier hs-var">policyPickWarmPeersToPromote</span></a><span>
</span><a name="line-1562"></a><span>                             </span><a href="#local-6989586621679107886"><span class="hs-identifier hs-var">availableToPromote</span></a><span>
</span><a name="line-1563"></a><span>                             </span><a href="#local-6989586621679107887"><span class="hs-identifier hs-var">numPeersToPromote</span></a><span>
</span><a name="line-1564"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">selectedToPromote'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107561"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107562"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1565"></a><span>          </span><a name="local-6989586621679107889"><a href="#local-6989586621679107889"><span class="hs-identifier">selectedToPromote'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107877"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1566"></a><span>                                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107888"><span class="hs-identifier hs-var">selectedToPromote</span></a><span>
</span><a name="line-1567"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1568"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmPeers"><span class="hs-identifier hs-var">TracePromoteWarmPeers</span></a><span>
</span><a name="line-1569"></a><span>                          </span><a href="#local-6989586621679107881"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-1570"></a><span>                          </span><a href="#local-6989586621679107883"><span class="hs-identifier hs-var">numActivePeers</span></a><span>
</span><a name="line-1571"></a><span>                          </span><a href="#local-6989586621679107888"><span class="hs-identifier hs-var">selectedToPromote</span></a><span class="hs-special">,</span><span>
</span><a name="line-1572"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107875"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1573"></a><span>                          </span><span class="hs-identifier">inProgressPromoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107879"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span>
</span><a name="line-1574"></a><span>                                               </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107888"><span class="hs-identifier hs-var">selectedToPromote</span></a><span>
</span><a name="line-1575"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1576"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobPromoteWarmPeer"><span class="hs-identifier hs-var">jobPromoteWarmPeer</span></a><span> </span><a href="#local-6989586621679107873"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107890"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107891"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1577"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107890"><a href="#local-6989586621679107890"><span class="hs-identifier">peeraddr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107891"><a href="#local-6989586621679107891"><span class="hs-identifier">peerconn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.assocs</span><span> </span><a href="#local-6989586621679107889"><span class="hs-identifier hs-var">selectedToPromote'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1578"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1581"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1582"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1583"></a><span>    </span><span class="hs-identifier">numEstablishedPeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numActivePeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numPromoteInProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1584"></a><span>    </span><a name="local-6989586621679107882"><a href="#local-6989586621679107882"><span class="hs-identifier">numEstablishedPeers</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.size</span><span> </span><a href="#local-6989586621679107877"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1585"></a><span>    </span><a name="local-6989586621679107883"><a href="#local-6989586621679107883"><span class="hs-identifier">numActivePeers</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107878"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1586"></a><span>    </span><a name="local-6989586621679107884"><a href="#local-6989586621679107884"><span class="hs-identifier">numPromoteInProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107879"><span class="hs-identifier hs-var">inProgressPromoteWarm</span></a><span>
</span><a name="line-1587"></a><span>    </span><a name="local-6989586621679107885"><a href="#local-6989586621679107885"><span class="hs-identifier">numDemoteInProgress</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107880"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span>
</span><a name="line-1588"></a><span>
</span><a name="line-1589"></a><span>
</span><a name="line-1590"></a><span class="hs-identifier">jobPromoteWarmPeer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107558"><a href="#local-6989586621679107558"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107559"><a href="#local-6989586621679107559"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107560"><a href="#local-6989586621679107560"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1591"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1592"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107559"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1593"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-1594"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107559"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1595"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107559"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1596"></a><a name="jobPromoteWarmPeer"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobPromoteWarmPeer"><span class="hs-identifier">jobPromoteWarmPeer</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107892"><a href="#local-6989586621679107892"><span class="hs-identifier">activatePeerConnection</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1597"></a><span>                   </span><a name="local-6989586621679107893"><a href="#local-6989586621679107893"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107894"><a href="#local-6989586621679107894"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1598"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><a href="#local-6989586621679107896"><span class="hs-identifier hs-var">job</span></a><span> </span><a href="#local-6989586621679107895"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-1599"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1600"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107559"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1601"></a><span>    </span><a name="local-6989586621679107895"><a href="#local-6989586621679107895"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107897"><a href="#local-6989586621679107897"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1602"></a><span>      </span><span class="hs-comment">--TODO: decide what happens if promotion fails, do we stay warm or go to</span><span>
</span><a name="line-1603"></a><span>      </span><span class="hs-comment">-- cold? Will this be reported asynchronously via the state monitoring?</span><span>
</span><a name="line-1604"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107898"><a href="#local-6989586621679107898"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107899"><a href="#local-6989586621679107899"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1605"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmFailed"><span class="hs-identifier hs-var">TracePromoteWarmFailed</span></a><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107897"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span>
</span><a name="line-1606"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107898"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1607"></a><span>                          </span><span class="hs-identifier">inProgressPromoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1608"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">inProgressPromoteWarm</span><span> </span><a href="#local-6989586621679107898"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1609"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1610"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1611"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span>    </span><span class="hs-identifier">job</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107560"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107558"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107559"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1614"></a><span>    </span><a name="local-6989586621679107896"><a href="#local-6989586621679107896"><span class="hs-identifier">job</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1615"></a><span>      </span><span class="hs-comment">--TODO: decide if we should do timeouts here or if we should make that</span><span>
</span><a name="line-1616"></a><span>      </span><span class="hs-comment">-- the responsibility of activatePeerConnection</span><span>
</span><a name="line-1617"></a><span>      </span><a href="#local-6989586621679107892"><span class="hs-identifier hs-var">activatePeerConnection</span></a><span> </span><a href="#local-6989586621679107894"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1618"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107900"><a href="#local-6989586621679107900"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107901"><a href="#local-6989586621679107901"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1619"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TracePromoteWarmDone"><span class="hs-identifier hs-var">TracePromoteWarmDone</span></a><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span class="hs-special">,</span><span>
</span><a name="line-1620"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107900"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1621"></a><span>                          </span><span class="hs-identifier">activePeers</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1622"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">activePeers</span><span> </span><a href="#local-6989586621679107900"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1623"></a><span>                          </span><span class="hs-identifier">establishedStatus</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerHot"><span class="hs-identifier hs-var">PeerHot</span></a><span>
</span><a name="line-1624"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">establishedStatus</span><span> </span><a href="#local-6989586621679107900"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1625"></a><span>                          </span><span class="hs-identifier">inProgressPromoteWarm</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107893"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1626"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier">inProgressPromoteWarm</span><span> </span><a href="#local-6989586621679107900"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1627"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1628"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1629"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1630"></a><span>
</span><a name="line-1631"></a><span>
</span><a name="line-1632"></a><span class="hs-identifier">activePeersAboveTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107555"><a href="#local-6989586621679107555"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107556"><a href="#local-6989586621679107556"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107557"><a href="#local-6989586621679107557"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1633"></a><span>                          </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107557"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1634"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107556"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107557"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1635"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-type">PeerSelectionPolicy</span></a><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107557"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1636"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107556"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1637"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107557"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107557"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107556"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1638"></a><a name="activePeersAboveTarget"><a href="Ouroboros.Network.PeerSelection.Governor.html#activePeersAboveTarget"><span class="hs-identifier">activePeersAboveTarget</span></a></a><span> </span><a name="local-6989586621679107902"><a href="#local-6989586621679107902"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-1639"></a><span>                       </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionPolicy"><span class="hs-identifier hs-var">PeerSelectionPolicy</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1640"></a><span>                         </span><a name="local-6989586621679107903"><a href="#local-6989586621679107903"><span class="hs-identifier">policyPickHotPeersToDemote</span></a></a><span>
</span><a name="line-1641"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1642"></a><span>                       </span><a name="local-6989586621679107904"><a href="#local-6989586621679107904"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1643"></a><span>                         </span><a name="local-6989586621679107905"><a href="#local-6989586621679107905"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1644"></a><span>                         </span><a name="local-6989586621679107906"><a href="#local-6989586621679107906"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1645"></a><span>                         </span><a name="local-6989586621679107907"><a href="#local-6989586621679107907"><span class="hs-identifier">activePeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1646"></a><span>                         </span><a name="local-6989586621679107908"><a href="#local-6989586621679107908"><span class="hs-identifier">inProgressDemoteHot</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1647"></a><span>                         </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1648"></a><span>                                     </span><a name="local-6989586621679107909"><a href="#local-6989586621679107909"><span class="hs-identifier">targetNumberOfActivePeers</span></a></a><span>
</span><a name="line-1649"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-1650"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-comment">-- Are we above the target for number of active peers?</span><span>
</span><a name="line-1652"></a><span>    </span><span class="hs-comment">-- Or more precisely, how many active peers could we demote?</span><span>
</span><a name="line-1653"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">numActivePeers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numPeersToDemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1654"></a><span>        </span><a name="local-6989586621679107910"><a href="#local-6989586621679107910"><span class="hs-identifier">numActivePeers</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107907"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1655"></a><span>        </span><span class="hs-comment">-- The main constraint on how many to demote is the difference in the</span><span>
</span><a name="line-1656"></a><span>        </span><span class="hs-comment">-- number we have now vs the target. We must also subtract the number</span><span>
</span><a name="line-1657"></a><span>        </span><span class="hs-comment">-- we're already demoting so we don't repeat the same work.</span><span>
</span><a name="line-1658"></a><span>        </span><a name="local-6989586621679107911"><a href="#local-6989586621679107911"><span class="hs-identifier">numPeersToDemote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107910"><span class="hs-identifier hs-var">numActivePeers</span></a><span>
</span><a name="line-1659"></a><span>                         </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679107909"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-1660"></a><span>                         </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621679107908"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>
</span><a name="line-1661"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679107911"><span class="hs-identifier hs-var">numPeersToDemote</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1662"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">availableToDemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#KnownPeerInfo"><span class="hs-identifier hs-type">KnownPeerInfo</span></a><span>
</span><a name="line-1665"></a><span>          </span><a name="local-6989586621679107912"><a href="#local-6989586621679107912"><span class="hs-identifier">availableToDemote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#toMap"><span class="hs-identifier hs-var">KnownPeers.toMap</span></a><span> </span><a href="#local-6989586621679107905"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1666"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107907"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1667"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.withoutKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107908"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>
</span><a name="line-1668"></a><span>      </span><a name="local-6989586621679107913"><a href="#local-6989586621679107913"><span class="hs-identifier">selectedToDemote</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#pickPeers"><span class="hs-identifier hs-var">pickPeers</span></a><span>
</span><a name="line-1669"></a><span>                            </span><a href="#local-6989586621679107903"><span class="hs-identifier hs-var">policyPickHotPeersToDemote</span></a><span>
</span><a name="line-1670"></a><span>                            </span><a href="#local-6989586621679107912"><span class="hs-identifier hs-var">availableToDemote</span></a><span>
</span><a name="line-1671"></a><span>                            </span><a href="#local-6989586621679107911"><span class="hs-identifier hs-var">numPeersToDemote</span></a><span>
</span><a name="line-1672"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">selectedToDemote'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107555"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107556"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1673"></a><span>          </span><a name="local-6989586621679107914"><a href="#local-6989586621679107914"><span class="hs-identifier">selectedToDemote'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107906"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1674"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107913"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1677"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotPeers"><span class="hs-identifier hs-var">TraceDemoteHotPeers</span></a><span>
</span><a name="line-1678"></a><span>                          </span><a href="#local-6989586621679107909"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a><span>
</span><a name="line-1679"></a><span>                          </span><a href="#local-6989586621679107910"><span class="hs-identifier hs-var">numActivePeers</span></a><span>
</span><a name="line-1680"></a><span>                          </span><a href="#local-6989586621679107913"><span class="hs-identifier hs-var">selectedToDemote</span></a><span class="hs-special">,</span><span>
</span><a name="line-1681"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107904"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1682"></a><span>                          </span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107908"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>
</span><a name="line-1683"></a><span>                                             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107913"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1684"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1685"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobDemoteActivePeer"><span class="hs-identifier hs-var">jobDemoteActivePeer</span></a><span> </span><a href="#local-6989586621679107902"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107915"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107916"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1686"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107915"><a href="#local-6989586621679107915"><span class="hs-identifier">peeraddr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107916"><a href="#local-6989586621679107916"><span class="hs-identifier">peerconn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.assocs</span><span> </span><a href="#local-6989586621679107914"><span class="hs-identifier hs-var">selectedToDemote'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1687"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1690"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#GuardedSkip"><span class="hs-identifier hs-var">GuardedSkip</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span class="hs-identifier">jobDemoteActivePeer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107552"><a href="#local-6989586621679107552"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107553"><a href="#local-6989586621679107553"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107554"><a href="#local-6989586621679107554"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1693"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1694"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107553"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1695"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-1696"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107553"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1697"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-type">Job</span></a><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107553"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1698"></a><a name="jobDemoteActivePeer"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobDemoteActivePeer"><span class="hs-identifier">jobDemoteActivePeer</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107917"><a href="#local-6989586621679107917"><span class="hs-identifier">deactivatePeerConnection</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1699"></a><span>                    </span><a name="local-6989586621679107918"><a href="#local-6989586621679107918"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107919"><a href="#local-6989586621679107919"><span class="hs-identifier">peerconn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1700"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#Job"><span class="hs-identifier hs-var">Job</span></a><span> </span><a href="#local-6989586621679107921"><span class="hs-identifier hs-var">job</span></a><span> </span><a href="#local-6989586621679107920"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-1701"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1702"></a><span>    </span><span class="hs-identifier">handler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107553"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1703"></a><span>    </span><a name="local-6989586621679107920"><a href="#local-6989586621679107920"><span class="hs-identifier">handler</span></a></a><span> </span><a name="local-6989586621679107922"><a href="#local-6989586621679107922"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1704"></a><span>      </span><span class="hs-comment">-- It's quite bad if closing fails, but the best we can do is revert to</span><span>
</span><a name="line-1705"></a><span>      </span><span class="hs-comment">-- the state where we believed these peers are still warm, since then we</span><span>
</span><a name="line-1706"></a><span>      </span><span class="hs-comment">-- can have another go at the ones we didn't yet try to close, or perhaps</span><span>
</span><a name="line-1707"></a><span>      </span><span class="hs-comment">-- it'll be closed for other reasons and our monitoring will notice it.</span><span>
</span><a name="line-1708"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107923"><a href="#local-6989586621679107923"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107924"><a href="#local-6989586621679107924"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1709"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotFailed"><span class="hs-identifier hs-var">TraceDemoteHotFailed</span></a><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107922"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span>
</span><a name="line-1710"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107923"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1711"></a><span>                          </span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1712"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><a href="#local-6989586621679107923"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1713"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1714"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1715"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1716"></a><span>
</span><a name="line-1717"></a><span>    </span><span class="hs-identifier">job</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107554"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107552"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107553"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1718"></a><span>    </span><a name="local-6989586621679107921"><a href="#local-6989586621679107921"><span class="hs-identifier">job</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1719"></a><span>      </span><a href="#local-6989586621679107917"><span class="hs-identifier hs-var">deactivatePeerConnection</span></a><span> </span><a href="#local-6989586621679107919"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1720"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679107925"><a href="#local-6989586621679107925"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107926"><a href="#local-6989586621679107926"><span class="hs-identifier">_now</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1721"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteHotDone"><span class="hs-identifier hs-var">TraceDemoteHotDone</span></a><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span class="hs-special">,</span><span>
</span><a name="line-1722"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107925"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1723"></a><span>                          </span><span class="hs-identifier">activePeers</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1724"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier">activePeers</span><span> </span><a href="#local-6989586621679107925"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1725"></a><span>                          </span><span class="hs-identifier">establishedStatus</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span>
</span><a name="line-1726"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier">establishedStatus</span><span> </span><a href="#local-6989586621679107925"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1727"></a><span>                          </span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621679107918"><span class="hs-identifier hs-var">peeraddr</span></a><span>
</span><a name="line-1728"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><a href="#local-6989586621679107925"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1730"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1731"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1732"></a><span>
</span><a name="line-1733"></a><span>
</span><a name="line-1734"></a><span>
</span><a name="line-1735"></a><span class="hs-identifier">changedLocalRootPeers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107549"><a href="#local-6989586621679107549"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107550"><a href="#local-6989586621679107550"><span class="hs-identifier">peerconn</span></a></a><span> </span><a name="local-6989586621679107551"><a href="#local-6989586621679107551"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1736"></a><span>                         </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107551"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107550"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107551"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1738"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107550"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1739"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107551"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107551"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107550"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1740"></a><a name="changedLocalRootPeers"><a href="Ouroboros.Network.PeerSelection.Governor.html#changedLocalRootPeers"><span class="hs-identifier">changedLocalRootPeers</span></a></a><span> </span><a name="local-6989586621679107927"><a href="#local-6989586621679107927"><span class="hs-identifier">actions</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107928"><a href="#local-6989586621679107928"><span class="hs-identifier">readLocalRootPeers</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1741"></a><span>                      </span><a name="local-6989586621679107929"><a href="#local-6989586621679107929"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span class="hs-special">{</span><span>
</span><a name="line-1742"></a><span>                        </span><a name="local-6989586621679107930"><a href="#local-6989586621679107930"><span class="hs-identifier">localRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1743"></a><span>                        </span><a name="local-6989586621679107931"><a href="#local-6989586621679107931"><span class="hs-identifier">publicRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1744"></a><span>                        </span><a name="local-6989586621679107932"><a href="#local-6989586621679107932"><span class="hs-identifier">knownPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1745"></a><span>                        </span><a name="local-6989586621679107933"><a href="#local-6989586621679107933"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1746"></a><span>                        </span><a name="local-6989586621679107934"><a href="#local-6989586621679107934"><span class="hs-identifier">activePeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1747"></a><span>                        </span><a name="local-6989586621679107935"><a href="#local-6989586621679107935"><span class="hs-identifier">inProgressDemoteHot</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1748"></a><span>                        </span><span class="hs-identifier">targets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-var">PeerSelectionTargets</span></a><span class="hs-special">{</span><a name="local-6989586621679107936"><a href="#local-6989586621679107936"><span class="hs-identifier">targetNumberOfKnownPeers</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1749"></a><span>                      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1750"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1751"></a><span>      </span><span class="hs-comment">-- We have to enforce the invariant that the number of root peers is</span><span>
</span><a name="line-1752"></a><span>      </span><span class="hs-comment">-- not more than the target number of known peers. It's unlikely in</span><span>
</span><a name="line-1753"></a><span>      </span><span class="hs-comment">-- practice so it's ok to resolve it arbitrarily using Map.take.</span><span>
</span><a name="line-1754"></a><span>      </span><a name="local-6989586621679107937"><a href="#local-6989586621679107937"><span class="hs-identifier">localRootPeers'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.take</span><span> </span><a href="#local-6989586621679107936"><span class="hs-identifier hs-var">targetNumberOfKnownPeers</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679107928"><span class="hs-identifier hs-var">readLocalRootPeers</span></a><span>
</span><a name="line-1755"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679107930"><span class="hs-identifier hs-var">localRootPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1756"></a><span>
</span><a name="line-1757"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107938"><a href="#local-6989586621679107938"><span class="hs-identifier">added</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span> </span><span class="hs-operator hs-var">Map.\\</span><span> </span><a href="#local-6989586621679107930"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-1758"></a><span>          </span><a name="local-6989586621679107939"><a href="#local-6989586621679107939"><span class="hs-identifier">removed</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107930"><span class="hs-identifier hs-var">localRootPeers</span></a><span>  </span><span class="hs-operator hs-var">Map.\\</span><span> </span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span>
</span><a name="line-1759"></a><span>          </span><a name="local-6989586621679107940"><a href="#local-6989586621679107940"><span class="hs-identifier">addedSet</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107938"><span class="hs-identifier hs-var">added</span></a><span>
</span><a name="line-1760"></a><span>          </span><a name="local-6989586621679107941"><a href="#local-6989586621679107941"><span class="hs-identifier">removedSet</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107939"><span class="hs-identifier hs-var">removed</span></a><span>
</span><a name="line-1761"></a><span>          </span><a name="local-6989586621679107942"><a href="#local-6989586621679107942"><span class="hs-identifier">knownPeers'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceLocalRoot"><span class="hs-identifier hs-var">PeerSourceLocalRoot</span></a><span>
</span><a name="line-1762"></a><span>                                          </span><span class="hs-special">(</span><a href="#local-6989586621679107938"><span class="hs-identifier hs-var">added</span></a><span> </span><span class="hs-operator hs-var">Map.!</span><span class="hs-special">)</span><span>
</span><a name="line-1763"></a><span>                                          </span><a href="#local-6989586621679107940"><span class="hs-identifier hs-var">addedSet</span></a><span>
</span><a name="line-1764"></a><span>
</span><a name="line-1765"></a><span>                        </span><span class="hs-comment">-- We do not immediately remove old ones from the</span><span>
</span><a name="line-1766"></a><span>                        </span><span class="hs-comment">-- known peers set because we may have established</span><span>
</span><a name="line-1767"></a><span>                        </span><span class="hs-comment">-- connections, but we mark them so that policy</span><span>
</span><a name="line-1768"></a><span>                        </span><span class="hs-comment">-- functions can prioritise them to forget:</span><span>
</span><a name="line-1769"></a><span>                      </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Network.PeerSelection.KnownPeers.html#insert"><span class="hs-identifier hs-var">KnownPeers.insert</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerSourceStaleRoot"><span class="hs-identifier hs-var">PeerSourceStaleRoot</span></a><span>
</span><a name="line-1770"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#DoNotAdvertisePeer"><span class="hs-identifier hs-var">DoNotAdvertisePeer</span></a><span class="hs-special">)</span><span>
</span><a name="line-1771"></a><span>                                          </span><a href="#local-6989586621679107941"><span class="hs-identifier hs-var">removedSet</span></a><span>
</span><a name="line-1772"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679107932"><span class="hs-identifier hs-var">knownPeers</span></a><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span>          </span><span class="hs-comment">-- We have to adjust the publicRootPeers to maintain the invariant</span><span>
</span><a name="line-1775"></a><span>          </span><span class="hs-comment">-- that the local and public sets are non-overlapping.</span><span>
</span><a name="line-1776"></a><span>          </span><a name="local-6989586621679107943"><a href="#local-6989586621679107943"><span class="hs-identifier">publicRootPeers'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107931"><span class="hs-identifier hs-var">publicRootPeers</span></a><span> </span><span class="hs-operator hs-var">Set.\\</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span>
</span><a name="line-1777"></a><span>
</span><a name="line-1778"></a><span>          </span><span class="hs-comment">-- If we are removing local roots and we have active connections to</span><span>
</span><a name="line-1779"></a><span>          </span><span class="hs-comment">-- them then things are a little more complicated. We would typically</span><span>
</span><a name="line-1780"></a><span>          </span><span class="hs-comment">-- change local roots so that we can establish new connections to</span><span>
</span><a name="line-1781"></a><span>          </span><span class="hs-comment">-- the new local roots. But since we will typically already be at our</span><span>
</span><a name="line-1782"></a><span>          </span><span class="hs-comment">-- target for active peers then that will not be possible without us</span><span>
</span><a name="line-1783"></a><span>          </span><span class="hs-comment">-- taking additional action. What we choose to do here is to demote</span><span>
</span><a name="line-1784"></a><span>          </span><span class="hs-comment">-- the peer from active to warm, which will then allow new ones to</span><span>
</span><a name="line-1785"></a><span>          </span><span class="hs-comment">-- be promoted to active.</span><span>
</span><a name="line-1786"></a><span>          </span><span class="hs-identifier">selectedToDemote</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span>
</span><a name="line-1787"></a><span>          </span><span class="hs-identifier">selectedToDemote'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107549"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107550"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1788"></a><span>
</span><a name="line-1789"></a><span>          </span><a name="local-6989586621679107944"><a href="#local-6989586621679107944"><span class="hs-identifier">selectedToDemote</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107934"><span class="hs-identifier hs-var">activePeers</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.intersection</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107941"><span class="hs-identifier hs-var">removedSet</span></a><span>
</span><a name="line-1790"></a><span>          </span><a name="local-6989586621679107945"><a href="#local-6989586621679107945"><span class="hs-identifier">selectedToDemote'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107933"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1791"></a><span>                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.restrictKeys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107944"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1792"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1793"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceLocalRootPeersChanged"><span class="hs-identifier hs-var">TraceLocalRootPeersChanged</span></a><span> </span><a href="#local-6989586621679107930"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-1794"></a><span>                                                   </span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1795"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107929"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1796"></a><span>                          </span><span class="hs-identifier">localRootPeers</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107937"><span class="hs-identifier hs-var">localRootPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1797"></a><span>                          </span><span class="hs-identifier">publicRootPeers</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107943"><span class="hs-identifier hs-var">publicRootPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1798"></a><span>                          </span><span class="hs-identifier">knownPeers</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107942"><span class="hs-identifier hs-var">knownPeers'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1799"></a><span>                          </span><span class="hs-identifier">inProgressDemoteHot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107935"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>
</span><a name="line-1800"></a><span>                                             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107944"><span class="hs-identifier hs-var">selectedToDemote</span></a><span>
</span><a name="line-1801"></a><span>                        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1802"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#jobDemoteActivePeer"><span class="hs-identifier hs-var">jobDemoteActivePeer</span></a><span> </span><a href="#local-6989586621679107927"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621679107946"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><a href="#local-6989586621679107947"><span class="hs-identifier hs-var">peerconn</span></a><span>
</span><a name="line-1803"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107946"><a href="#local-6989586621679107946"><span class="hs-identifier">peeraddr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107947"><a href="#local-6989586621679107947"><span class="hs-identifier">peerconn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.assocs</span><span> </span><a href="#local-6989586621679107945"><span class="hs-identifier hs-var">selectedToDemote'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1804"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1805"></a><span>
</span><a name="line-1806"></a><span>
</span><a name="line-1807"></a><span class="hs-identifier">changedTargets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107546"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1808"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107547"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107548"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107546"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1809"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107547"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107548"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1810"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107546"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107546"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107547"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107548"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1811"></a><a name="changedTargets"><a href="Ouroboros.Network.PeerSelection.Governor.html#changedTargets"><span class="hs-identifier">changedTargets</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107948"><a href="#local-6989586621679107948"><span class="hs-identifier">readPeerSelectionTargets</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1812"></a><span>               </span><a name="local-6989586621679107949"><a href="#local-6989586621679107949"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span class="hs-special">{</span><span>
</span><a name="line-1813"></a><span>                 </span><a name="local-6989586621679107950"><a href="#local-6989586621679107950"><span class="hs-identifier">localRootPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1814"></a><span>                 </span><a name="local-6989586621679107951"><a href="#local-6989586621679107951"><span class="hs-identifier">targets</span></a></a><span>
</span><a name="line-1815"></a><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1816"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1817"></a><span>      </span><a name="local-6989586621679107952"><a href="#local-6989586621679107952"><span class="hs-identifier">targets'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679107948"><span class="hs-identifier hs-var">readPeerSelectionTargets</span></a><span>
</span><a name="line-1818"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679107952"><span class="hs-identifier hs-var">targets'</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679107951"><span class="hs-identifier hs-var">targets</span></a><span class="hs-special">)</span><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span>      </span><span class="hs-comment">-- We have to enforce the invariant that the number of root peers is</span><span>
</span><a name="line-1821"></a><span>      </span><span class="hs-comment">-- not more than the target number of known peers. It's unlikely in</span><span>
</span><a name="line-1822"></a><span>      </span><span class="hs-comment">-- practice so it's ok to resolve it arbitrarily using Map.take.</span><span>
</span><a name="line-1823"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107953"><a href="#local-6989586621679107953"><span class="hs-identifier">localRootPeers'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.take</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">targetNumberOfKnownPeers</span><span> </span><a href="#local-6989586621679107952"><span class="hs-identifier hs-var">targets'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1824"></a><span>                                     </span><a href="#local-6989586621679107950"><span class="hs-identifier hs-var">localRootPeers</span></a><span>
</span><a name="line-1825"></a><span>
</span><a name="line-1826"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1827"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceTargetsChanged"><span class="hs-identifier hs-var">TraceTargetsChanged</span></a><span> </span><a href="#local-6989586621679107951"><span class="hs-identifier hs-var">targets</span></a><span> </span><a href="#local-6989586621679107952"><span class="hs-identifier hs-var">targets'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1828"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1829"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#sanePeerSelectionTargets"><span class="hs-identifier hs-var">sanePeerSelectionTargets</span></a><span> </span><a href="#local-6989586621679107952"><span class="hs-identifier hs-var">targets'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1830"></a><span>                        </span><a href="#local-6989586621679107949"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1831"></a><span>                          </span><span class="hs-identifier">targets</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107952"><span class="hs-identifier hs-var">targets'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1832"></a><span>                          </span><span class="hs-identifier">localRootPeers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107953"><span class="hs-identifier hs-var">localRootPeers'</span></a><span>
</span><a name="line-1833"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-1834"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1835"></a><span>
</span><a name="line-1836"></a><span>
</span><a name="line-1837"></a><span class="hs-identifier">jobCompleted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107543"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1838"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#JobPool"><span class="hs-identifier hs-type">JobPool</span></a><span> </span><a href="#local-6989586621679107543"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-type">Completion</span></a><span> </span><a href="#local-6989586621679107543"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107544"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107545"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1839"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107544"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107545"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1840"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTime.html#Time"><span class="hs-identifier hs-type">Time</span></a><span>
</span><a name="line-1841"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107543"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107543"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107544"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107545"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1842"></a><a name="jobCompleted"><a href="Ouroboros.Network.PeerSelection.Governor.html#jobCompleted"><span class="hs-identifier">jobCompleted</span></a></a><span> </span><a name="local-6989586621679107954"><a href="#local-6989586621679107954"><span class="hs-identifier">jobPool</span></a></a><span> </span><a name="local-6989586621679107955"><a href="#local-6989586621679107955"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621679107956"><a href="#local-6989586621679107956"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1843"></a><span>    </span><span class="hs-comment">-- This case is simple because the job pool returns a 'Completion' which is</span><span>
</span><a name="line-1844"></a><span>    </span><span class="hs-comment">-- just a function from the current state to a new 'Decision'.</span><span>
</span><a name="line-1845"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1846"></a><span>      </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Completion"><span class="hs-identifier hs-var">Completion</span></a><span> </span><a name="local-6989586621679107957"><a href="#local-6989586621679107957"><span class="hs-identifier">completion</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Network.PeerSelection.JobPool.html#collect"><span class="hs-identifier hs-var">JobPool.collect</span></a><span> </span><a href="#local-6989586621679107954"><span class="hs-identifier hs-var">jobPool</span></a><span>
</span><a name="line-1847"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621679107957"><span class="hs-identifier hs-var">completion</span></a><span> </span><a href="#local-6989586621679107955"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621679107956"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-1848"></a><span>
</span><a name="line-1849"></a><span>
</span><a name="line-1850"></a><span class="hs-identifier">monitorConnections</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679107540"><a href="#local-6989586621679107540"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679107541"><a href="#local-6989586621679107541"><span class="hs-identifier">peeraddr</span></a></a><span> </span><a name="local-6989586621679107542"><a href="#local-6989586621679107542"><span class="hs-identifier">peerconn</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1851"></a><span>                      </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1852"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107542"><span class="hs-identifier hs-type">peerconn</span></a><span> </span><a href="#local-6989586621679107540"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1853"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-type">PeerSelectionState</span></a><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107542"><span class="hs-identifier hs-type">peerconn</span></a><span>
</span><a name="line-1854"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-type">Guarded</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679107540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-type">Decision</span></a><span> </span><a href="#local-6989586621679107540"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="#local-6989586621679107542"><span class="hs-identifier hs-type">peerconn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1855"></a><a name="monitorConnections"><a href="Ouroboros.Network.PeerSelection.Governor.html#monitorConnections"><span class="hs-identifier">monitorConnections</span></a></a><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionActions"><span class="hs-identifier hs-var">PeerSelectionActions</span></a><span class="hs-special">{</span><a name="local-6989586621679107958"><a href="#local-6989586621679107958"><span class="hs-identifier">monitorPeerConnection</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1856"></a><span>                   </span><a name="local-6989586621679107959"><a href="#local-6989586621679107959"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionState"><span class="hs-identifier hs-var">PeerSelectionState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1857"></a><span>                     </span><a name="local-6989586621679107960"><a href="#local-6989586621679107960"><span class="hs-identifier">activePeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1858"></a><span>                     </span><a name="local-6989586621679107961"><a href="#local-6989586621679107961"><span class="hs-identifier">establishedPeers</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1859"></a><span>                     </span><a name="local-6989586621679107962"><a href="#local-6989586621679107962"><span class="hs-identifier">establishedStatus</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1860"></a><span>                     </span><a name="local-6989586621679107963"><a href="#local-6989586621679107963"><span class="hs-identifier">inProgressDemoteHot</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1861"></a><span>                     </span><a name="local-6989586621679107964"><a href="#local-6989586621679107964"><span class="hs-identifier">inProgressDemoteWarm</span></a></a><span>
</span><a name="line-1862"></a><span>                   </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1863"></a><span>    </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Guarded"><span class="hs-identifier hs-var">Guarded</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1864"></a><span>      </span><a name="local-6989586621679107971"><a href="#local-6989586621679107971"><span class="hs-identifier">establishedStatus'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="#local-6989586621679107958"><span class="hs-identifier hs-var">monitorPeerConnection</span></a><span> </span><a href="#local-6989586621679107961"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1865"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679107972"><a href="#local-6989586621679107972"><span class="hs-identifier">demotions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107965"><span class="hs-identifier hs-var">asynchronousDemotions</span></a><span> </span><a href="#local-6989586621679107962"><span class="hs-identifier hs-var">establishedStatus</span></a><span>
</span><a name="line-1866"></a><span>                                            </span><a href="#local-6989586621679107971"><span class="hs-identifier hs-var">establishedStatus'</span></a><span>
</span><a name="line-1867"></a><span>      </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.null</span><span> </span><a href="#local-6989586621679107972"><span class="hs-identifier hs-var">demotions</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1868"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679107973"><a href="#local-6989586621679107973"><span class="hs-identifier">demotedToWarm</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679107974"><a href="#local-6989586621679107974"><span class="hs-identifier">demotedToCold</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.partition</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679107972"><span class="hs-identifier hs-var">demotions</span></a><span>
</span><a name="line-1869"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#Decision"><span class="hs-identifier hs-var">Decision</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1870"></a><span>        </span><span class="hs-identifier">decisionTrace</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#TraceDemoteAsynchronous"><span class="hs-identifier hs-var">TraceDemoteAsynchronous</span></a><span> </span><a href="#local-6989586621679107972"><span class="hs-identifier hs-var">demotions</span></a><span class="hs-special">,</span><span>
</span><a name="line-1871"></a><span>        </span><span class="hs-identifier">decisionJobs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1872"></a><span>        </span><span class="hs-identifier">decisionState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107959"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1873"></a><span>                          </span><span class="hs-identifier">activePeers</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107960"><span class="hs-identifier hs-var">activePeers</span></a><span>
</span><a name="line-1874"></a><span>                                                </span><span class="hs-operator hs-var">Set.\\</span><span> </span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621679107973"><span class="hs-identifier hs-var">demotedToWarm</span></a><span class="hs-special">,</span><span>
</span><a name="line-1875"></a><span>                          </span><span class="hs-identifier">establishedPeers</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107961"><span class="hs-identifier hs-var">establishedPeers</span></a><span>
</span><a name="line-1876"></a><span>                                                </span><span class="hs-operator hs-var">Map.\\</span><span> </span><a href="#local-6989586621679107974"><span class="hs-identifier hs-var">demotedToCold</span></a><span class="hs-special">,</span><span>
</span><a name="line-1877"></a><span>
</span><a name="line-1878"></a><span>                          </span><span class="hs-comment">-- Note that we do not use establishedStatus' which</span><span>
</span><a name="line-1879"></a><span>                          </span><span class="hs-comment">-- has the synchronous ones that are supposed to be</span><span>
</span><a name="line-1880"></a><span>                          </span><span class="hs-comment">-- handled elsewhere. We just update the async ones:</span><span>
</span><a name="line-1881"></a><span>                          </span><span class="hs-identifier">establishedStatus</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679107962"><span class="hs-identifier hs-var">establishedStatus</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679107972"><span class="hs-identifier hs-var">demotions</span></a><span>
</span><a name="line-1882"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-1883"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-1884"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1885"></a><span>    </span><span class="hs-comment">-- Those demotions that occurred not as a result of action by the governor.</span><span>
</span><a name="line-1886"></a><span>    </span><span class="hs-comment">-- They're further classified into demotions to warm, and demotions to cold.</span><span>
</span><a name="line-1887"></a><span>    </span><span class="hs-identifier">asynchronousDemotions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span>
</span><a name="line-1888"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span>
</span><a name="line-1889"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span>
</span><a name="line-1890"></a><span>    </span><a name="local-6989586621679107965"><a href="#local-6989586621679107965"><span class="hs-identifier">asynchronousDemotions</span></a></a><span> </span><a name="local-6989586621679107967"><a href="#local-6989586621679107967"><span class="hs-identifier">old</span></a></a><span> </span><a name="local-6989586621679107968"><a href="#local-6989586621679107968"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1891"></a><span>      </span><span class="hs-identifier hs-var">Map.mapMaybeWithKey</span><span> </span><a href="#local-6989586621679107966"><span class="hs-identifier hs-var">asyncDemotion</span></a><span>
</span><a name="line-1892"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1893"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.intersectionWith</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679107967"><span class="hs-identifier hs-var">old</span></a><span> </span><a href="#local-6989586621679107968"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>    </span><span class="hs-comment">-- The asynchronous ones, those not directed by the governor, are:</span><span>
</span><a name="line-1896"></a><span>    </span><span class="hs-comment">-- hot -&gt; warm, warm -&gt; cold and hot -&gt; cold, other than the ones in the in</span><span>
</span><a name="line-1897"></a><span>    </span><span class="hs-comment">-- relevant progress set.</span><span>
</span><a name="line-1898"></a><span>    </span><span class="hs-identifier">asyncDemotion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679107541"><span class="hs-identifier hs-type">peeraddr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerStatus"><span class="hs-identifier hs-type">PeerStatus</span></a><span>
</span><a name="line-1899"></a><span>    </span><a name="local-6989586621679107966"><a href="#local-6989586621679107966"><span class="hs-identifier">asyncDemotion</span></a></a><span> </span><a name="local-6989586621679107969"><a href="#local-6989586621679107969"><span class="hs-identifier">peeraddr</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerHot"><span class="hs-identifier hs-var">PeerHot</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1900"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107969"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.notMember</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107963"><span class="hs-identifier hs-var">inProgressDemoteHot</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span>
</span><a name="line-1901"></a><span>    </span><span class="hs-identifier">asyncDemotion</span><span> </span><a name="local-6989586621679107970"><a href="#local-6989586621679107970"><span class="hs-identifier">peeraddr</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerWarm"><span class="hs-identifier hs-var">PeerWarm</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerCold"><span class="hs-identifier hs-var">PeerCold</span></a><span class="hs-special">)</span><span>
</span><a name="line-1902"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679107970"><span class="hs-identifier hs-var">peeraddr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.notMember</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679107964"><span class="hs-identifier hs-var">inProgressDemoteWarm</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerCold"><span class="hs-identifier hs-var">PeerCold</span></a><span>
</span><a name="line-1903"></a><span>    </span><span class="hs-identifier">asyncDemotion</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">(</span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerHot"><span class="hs-identifier hs-var">PeerHot</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerCold"><span class="hs-identifier hs-var">PeerCold</span></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Ouroboros.Network.PeerSelection.Types.html#PeerCold"><span class="hs-identifier hs-var">PeerCold</span></a><span>
</span><a name="line-1904"></a><span>    </span><span class="hs-identifier">asyncDemotion</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1905"></a><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1908"></a><span class="hs-comment">-- Peer churn governor</span><span>
</span><a name="line-1909"></a><span class="hs-comment">--</span><span>
</span><a name="line-1910"></a><span>
</span><a name="line-1911"></a><span class="hs-comment">{-
$peer-churn-governor
-}</span><span>
</span><a name="line-1914"></a><span>
</span><a name="line-1915"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-1916"></a><span class="hs-comment">--</span><span>
</span><a name="line-1917"></a><span class="hs-identifier">peerChurnGovernor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679107539"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1918"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Network.PeerSelection.Governor.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a><span>
</span><a name="line-1919"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107539"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">--Void</span><span>
</span><a name="line-1920"></a><a name="peerChurnGovernor"><a href="Ouroboros.Network.PeerSelection.Governor.html#peerChurnGovernor"><span class="hs-identifier">peerChurnGovernor</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1921"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1922"></a><span>
</span><a name="line-1923"></a><span>
</span><a name="line-1924"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-1925"></a><span class="hs-comment">-- Utils</span><span>
</span><a name="line-1926"></a><span class="hs-comment">--</span><span>
</span><a name="line-1927"></a><span>
</span><a name="line-1928"></a><span class="hs-comment">-- | Perform a first-to-finish synchronisation between:</span><span>
</span><a name="line-1929"></a><span class="hs-comment">--</span><span>
</span><a name="line-1930"></a><span class="hs-comment">-- * /all/ the async actions completing; or</span><span>
</span><a name="line-1931"></a><span class="hs-comment">-- * the timeout with whatever partial results we have at the time</span><span>
</span><a name="line-1932"></a><span class="hs-comment">--</span><span>
</span><a name="line-1933"></a><span class="hs-comment">-- The result list is the same length and order as the asyncs, so the results</span><span>
</span><a name="line-1934"></a><span class="hs-comment">-- can be paired up.</span><span>
</span><a name="line-1935"></a><span class="hs-comment">--</span><span>
</span><a name="line-1936"></a><span class="hs-identifier">waitAllCatchOrTimeout</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#MonadAsync"><span class="hs-identifier hs-type">MonadAsync</span></a><span> </span><a href="#local-6989586621679107537"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#MonadTimer"><span class="hs-identifier hs-type">MonadTimer</span></a><span> </span><a href="#local-6989586621679107537"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1937"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#Async"><span class="hs-identifier hs-type">Async</span></a><span> </span><a href="#local-6989586621679107537"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679107538"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1938"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DiffTime</span><span>
</span><a name="line-1939"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679107537"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679107538"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1940"></a><span>                                   </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679107538"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1941"></a><a name="waitAllCatchOrTimeout"><a href="Ouroboros.Network.PeerSelection.Governor.html#waitAllCatchOrTimeout"><span class="hs-identifier">waitAllCatchOrTimeout</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621679107976"><a href="#local-6989586621679107976"><span class="hs-identifier">time</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1942"></a><span>    </span><a name="local-6989586621679107977"><a href="#local-6989586621679107977"><span class="hs-identifier">t</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#newTimeout"><span class="hs-identifier hs-var">newTimeout</span></a><span> </span><a href="#local-6989586621679107976"><span class="hs-identifier hs-var">time</span></a><span>
</span><a name="line-1943"></a><span>    </span><a name="local-6989586621679107978"><a href="#local-6989586621679107978"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1944"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#waitCatchSTM"><span class="hs-identifier hs-var">waitCatchSTM</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1945"></a><span>                </span><span class="hs-special">`</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span>  </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#awaitTimeout"><span class="hs-identifier hs-var">awaitTimeout</span></a><span> </span><a href="#local-6989586621679107977"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadAsync.html#pollSTM"><span class="hs-identifier hs-var">pollSTM</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1946"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679107978"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1947"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadTimer.html#cancelTimeout"><span class="hs-identifier hs-var">cancelTimeout</span></a><span> </span><a href="#local-6989586621679107977"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1948"></a><span>      </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1949"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679107978"><span class="hs-identifier hs-var">results</span></a><span>
</span><a name="line-1950"></a></pre></body></html>