<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds                  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass             #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE DerivingVia                #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification  #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE GADTs                      #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures             #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase                 #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                 #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards            #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving         #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators              #-}</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">-- | Intended for qualified import</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- &gt; import qualified Ouroboros.Consensus.HardFork.History as HardFork</span><span>
</span><a name="line-21"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.HardFork.History</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-comment">-- * History</span><span>
</span><a name="line-23"></a><span>    </span><span class="hs-comment">-- ** Params</span><span>
</span><a name="line-24"></a><span>    </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier hs-type">SafeZone</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SafeBeforeEpoch"><span class="hs-identifier hs-type">SafeBeforeEpoch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#defaultSafeZone"><span class="hs-identifier hs-var">defaultSafeZone</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#defaultEraParams"><span class="hs-identifier hs-var">defaultEraParams</span></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-comment">-- ** Shape</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-type">Shape</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#singletonShape"><span class="hs-identifier hs-var">singletonShape</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">-- ** Transitions</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-type">Transitions</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#transitionsUnknown"><span class="hs-identifier hs-var">transitionsUnknown</span></a><span>
</span><a name="line-35"></a><span>    </span><span class="hs-comment">-- * Summary</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Non-opaque only for the benefit of tests</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#neverForksSummary"><span class="hs-identifier hs-var">neverForksSummary</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#summarize"><span class="hs-identifier hs-var">summarize</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#summaryBounds"><span class="hs-identifier hs-var">summaryBounds</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#summaryInit"><span class="hs-identifier hs-var">summaryInit</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#summaryWithExactly"><span class="hs-identifier hs-var">summaryWithExactly</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-comment">-- ** Low-level API for summary construction</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpochBound"><span class="hs-identifier hs-var">slotToEpochBound</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#maxMaybeEpoch"><span class="hs-identifier hs-var">maxMaybeEpoch</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#mkEraEnd"><span class="hs-identifier hs-var">mkEraEnd</span></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-comment">-- * Queries</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-comment">-- Opaque</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier hs-var">runQuery</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQueryThrow"><span class="hs-identifier hs-var">runQueryThrow</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQueryPure"><span class="hs-identifier hs-var">runQueryPure</span></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#wallclockToSlot"><span class="hs-identifier hs-var">wallclockToSlot</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToWallclock"><span class="hs-identifier hs-var">slotToWallclock</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch"><span class="hs-identifier hs-var">slotToEpoch</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot"><span class="hs-identifier hs-var">epochToSlot</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-comment">-- * Support for 'EpochInfo'</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#summaryToEpochInfo"><span class="hs-identifier hs-var">summaryToEpochInfo</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#snapshotEpochInfo"><span class="hs-identifier hs-var">snapshotEpochInfo</span></a><span>
</span><a name="line-59"></a><span>    </span><span class="hs-comment">-- * Caching</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier hs-type">RunWithCachedSummary</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQueryThrow"><span class="hs-identifier hs-var">cachedRunQueryThrow</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runWithCachedSummary"><span class="hs-identifier hs-var">runWithCachedSummary</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-comment">-- * Exported only for the benefit of tests</span><span>
</span><a name="line-64"></a><span>    </span><span class="hs-comment">-- ** Bounds</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span> </span><span class="hs-comment">-- Still opaque, even for tests. Has internal invariants.</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#boundEpoch"><span class="hs-identifier hs-var">boundEpoch</span></a><span>
</span><a name="line-67"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#boundSlot"><span class="hs-identifier hs-var">boundSlot</span></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#boundTime"><span class="hs-identifier hs-var">boundTime</span></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#initBound"><span class="hs-identifier hs-var">initBound</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#mkUpperBound"><span class="hs-identifier hs-var">mkUpperBound</span></a><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">-- ** Summary</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- ** Summary translations</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-comment">-- ** Invariants</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#invariantSummary"><span class="hs-identifier hs-var">invariantSummary</span></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#invariantShape"><span class="hs-identifier hs-var">invariantShape</span></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-comment">-- ** Auxiliary</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier hs-var">addEpochs</span></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier hs-var">addSlots</span></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#countEpochs"><span class="hs-identifier hs-var">countEpochs</span></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#countSlots"><span class="hs-identifier hs-var">countSlots</span></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Codec.Serialise</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">assert</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Except</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Bifunctor</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Fixed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">divMod'</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">asum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toList</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Functor.Identity</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Time</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Stack</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.html"><span class="hs-identifier">Cardano.Prelude</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#UseIsNormalFormNamed"><span class="hs-identifier hs-type">UseIsNormalFormNamed</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html"><span class="hs-identifier">Cardano.Slotting.EpochInfo.API</span></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span>           </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html"><span class="hs-identifier">Cardano.Slotting.Slot</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html"><span class="hs-identifier">Ouroboros.Consensus.BlockchainTime.WallClock.Types</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Config.SecurityParam.html"><span class="hs-identifier">Ouroboros.Consensus.Config.SecurityParam</span></a><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.Counting.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Counting</span></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span>           </span><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  OVERVIEW

  The overall chain consists of various /era/s. Each era has its own set of era
  parameters such as the slot length and epoch size, as well as its own block
  format, ledger format, ledger rules, etc. It is assumed that the overall
  /shape/ of the chain is known. In other words, we statically know which eras
  we expect and what their parameters are; adding an additional era would
  require a code update. What we /don't/ know precisely is /when/ we transition
  from one era to the next, i.e., the hard fork transition points.

  When we are at genesis, the chain therefore looks something like this:

  &gt; *-------------------?--------------------?--------------------
  &gt; ^
  &gt; \-- tip

  where we have (in this example) three eras (say, Byron, Shelley and Goguen)
  and therefore two hard fork transitions. Hard forks happen at epoch
  boundaries; the exact 'EpochNo' of each hard fork is determined by the era
  preceding it. Naturally, the exact 'EpochNo' of /past/ hard forks is known:

  &gt; ---------------A--------------*----------?--------------------
  &gt;                               ^
  &gt;                               \-- tip

  where A is a known hard fork transition, and the next hard fork transition
  is still unknown.

  SAFE ZONES

  Future hard fork points may be known or unknown, where &quot;known&quot; means
  &quot;certain&quot;; i.e., for Byron, it would mean an update proposal has been voted
  on, confirmed, endorsed, and that endorsement is at least @k@ blocks deep into
  the chain; for Shelley it means an update proposal is voted on and accepted,
  and that acceptance is at least @k@ blocks deep into the chain.

  When a hard fork point is still unknown, we assume that each era determines a
  &quot;safe zone&quot;: a number of slots from the tip of the ledger in which it is
  guaranteed that the hard fork will not happen.

  &gt; CASE (i)
  &gt;
  &gt; ---------------A--------------*----------?--------------------
  &gt;                               \..../
  &gt;                                safe
  &gt;                                zone

  Since the hard fork will not happen in the safe zone, we can extend the use of
  the current set of era parameters past the tip into the safe zone, giving us a
  limited ability to make predictions for the future (such as converting between
  slot numbers and wallclock time).

  We assume that once a transition point is known (and no longer subject to
  roll-back), this is guaranteed not to change anymore and we can use the era's
  parameters up to the transition point:

  &gt; CASE (ii)
  &gt;
  &gt; ---------------A--------------*----------------B--------------
  &gt;                               \.............../
  &gt;                                implicitly safe

  Moreover, we assume that we can extend B's safe zone from the point of the
  hard fork transition:

  &gt; CASE (iii)
  &gt;
  &gt; ---------------A--------------*----------------B--------------
  &gt;                               \.............../\..../
  &gt;                                implicitly safe  safe
  &gt;                                                 zone

  This is justified because the safe zones arise from stability requirements
  for the transactions that establish the transition point. The earliest point
  such a transaction could be included in the chain is after the hard fork
  transition, since it must be a transaction from the /new/ era.

  NOTE ON STABILITY

  If we used as yet /unconfirmed/ update proposals to determine hard fork
  transition points, then any of the resulting time conversions would be
  subject to rollback; if we switched to a different fork, time conversions
  might suddenly look different. Whilst this /may/ be doable, in practice this
  is a headache we would very much like to avoid. For example, it might mean
  that when a block comes in and we determine that it's from the future,
  we might have prematurely marked it as invalid. So, we insist that time
  conversions must be based on update propsals that are /certain/ (no longer
  subject to rollback). This means that the &quot;safe zone&quot; we have been discussing
  above must extend from the point of stability forward. Moreover, the safe zone
  must be long enough to include a sufficient number of blocks such that we can
  evaluate enough headers of an alternative fork (without having its blocks)
  to decide that we want to switch to that fork; since in the worst case that
  means we have to evaluate @k@ headers (or @k+1@), the safe zone must be long
  enough to cover @k@ blocks (and therefore a safe zone of @2k@ slots for Byron,
  and (probably) a safe zone of @3k/f@ slots for Shelley). Effectively, this
  means that consensus wants &quot;stability itself to be stable&quot;; we need a double
  safe zone after an update proposal has been confirmed.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- | Parameters that can vary across hard forks</span><span>
</span><a name="line-208"></a><span class="hs-keyword">data</span><span> </span><a name="EraParams"><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier">EraParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EraParams"><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier">EraParams</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-209"></a><span>      </span><a name="eraEpochSize"><a href="Ouroboros.Consensus.HardFork.History.html#eraEpochSize"><span class="hs-identifier">eraEpochSize</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-type">EpochSize</span></a><span>
</span><a name="line-210"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="eraSlotLength"><a href="Ouroboros.Consensus.HardFork.History.html#eraSlotLength"><span class="hs-identifier">eraSlotLength</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SlotLength"><span class="hs-identifier hs-type">SlotLength</span></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="eraSafeZone"><a href="Ouroboros.Consensus.HardFork.History.html#eraSafeZone"><span class="hs-identifier">eraSafeZone</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier hs-type">SafeZone</span></a><span>
</span><a name="line-212"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- | Default 'EraParams'</span><span>
</span><a name="line-217"></a><span class="hs-comment">--</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- We set</span><span>
</span><a name="line-219"></a><span class="hs-comment">--</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- * epoch size to @10k@ slots</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- * the safe zone to @2k@ slots</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- * the upper bound to 'UnsafeUnbounded'</span><span>
</span><a name="line-223"></a><span class="hs-comment">--</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- This is primarily useful for tests.</span><span>
</span><a name="line-225"></a><span class="hs-identifier">defaultEraParams</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SlotLength"><span class="hs-identifier hs-type">SlotLength</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span>
</span><a name="line-226"></a><a name="defaultEraParams"><a href="Ouroboros.Consensus.HardFork.History.html#defaultEraParams"><span class="hs-identifier">defaultEraParams</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-var">SecurityParam</span></a><span> </span><a name="local-6989586621679362566"><a href="#local-6989586621679362566"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679362567"><a href="#local-6989586621679362567"><span class="hs-identifier">slotLength</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-var">EraParams</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-227"></a><span>      </span><span class="hs-identifier">eraEpochSize</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-var">EpochSize</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362566"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraSlotLength</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362567"><span class="hs-identifier hs-var">slotLength</span></a><span>
</span><a name="line-229"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraSafeZone</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#defaultSafeZone"><span class="hs-identifier hs-var">defaultSafeZone</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362566"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">-- | Zone in which it is guaranteed that no hard fork can take place</span><span>
</span><a name="line-233"></a><span class="hs-keyword">data</span><span> </span><a name="SafeZone"><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier">SafeZone</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SafeZone"><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier">SafeZone</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-234"></a><span>      </span><span class="hs-comment">-- | Number of slots from the tip of the ledger</span><span>
</span><a name="line-235"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-236"></a><span>      </span><span class="hs-comment">-- This should be (at least) the number of slots in which we are</span><span>
</span><a name="line-237"></a><span>      </span><span class="hs-comment">-- guaranteed to have @k@ blocks.</span><span>
</span><a name="line-238"></a><span>      </span><a name="safeFromTip"><a href="Ouroboros.Consensus.HardFork.History.html#safeFromTip"><span class="hs-identifier">safeFromTip</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>      </span><span class="hs-comment">-- | Optionally, an 'EpochNo' before which no hard fork can take place</span><span>
</span><a name="line-241"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="safeBeforeEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#safeBeforeEpoch"><span class="hs-identifier">safeBeforeEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#SafeBeforeEpoch"><span class="hs-identifier hs-type">SafeBeforeEpoch</span></a><span>
</span><a name="line-242"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | Default safe zone with no 'safeBeforeEpoch\</span><span>
</span><a name="line-247"></a><span class="hs-identifier">defaultSafeZone</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier hs-type">SafeZone</span></a><span>
</span><a name="line-248"></a><a name="defaultSafeZone"><a href="Ouroboros.Consensus.HardFork.History.html#defaultSafeZone"><span class="hs-identifier">defaultSafeZone</span></a></a><span> </span><a name="local-6989586621679362568"><a href="#local-6989586621679362568"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SafeZone"><span class="hs-identifier hs-var">SafeZone</span></a><span> </span><a href="#local-6989586621679362568"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#NoLowerBound"><span class="hs-identifier hs-var">NoLowerBound</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">-- | Lower bound on when a transition can take place</span><span>
</span><a name="line-251"></a><span class="hs-keyword">data</span><span> </span><a name="SafeBeforeEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#SafeBeforeEpoch"><span class="hs-identifier">SafeBeforeEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-252"></a><span>    </span><span class="hs-comment">-- | No such lower bound is known</span><span>
</span><a name="line-253"></a><span>    </span><a name="NoLowerBound"><a href="Ouroboros.Consensus.HardFork.History.html#NoLowerBound"><span class="hs-identifier">NoLowerBound</span></a></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>    </span><span class="hs-comment">-- | 'EpochNo' before which a transition is guaranteed not to take place</span><span>
</span><a name="line-256"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- Often such a value is available, since a new era is planned only after</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-comment">-- the current era has already been running for a while. For example, at</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">-- the time of writing, we know the Byron to Shelley transition cannot</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-comment">-- happen before epoch 180, since we are currently already in epoch 179.</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-comment">-- Moreover, for epoch transitions that have /already/ taken place, the</span><span>
</span><a name="line-263"></a><span>    </span><span class="hs-comment">-- exact 'EpochNo' of the transition can be used.</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-comment">-- Providing this value is strictly an optimization; for example, it will</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">-- reduce the frequency with which 'summaryToEpochInfo' must update its</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-comment">-- summary of the hard fork history.</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LowerBound"><a href="Ouroboros.Consensus.HardFork.History.html#LowerBound"><span class="hs-identifier">LowerBound</span></a></a><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>    </span><span class="hs-comment">-- | Pretend the transition to the next era will not take place.</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-comment">-- This constructor is marked as unsafe because it effectively extends</span><span>
</span><a name="line-273"></a><span>    </span><span class="hs-comment">-- the safe zone of this era indefinitely into the future. This means that</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-comment">-- we might reach invalid conclusions when doing</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-276"></a><span>    </span><span class="hs-comment">-- * slot to time conversions for blocks that are past the actual safe zone</span><span>
</span><a name="line-277"></a><span>    </span><span class="hs-comment">-- * time to slot conversions for the current time, when behind in syncing</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-comment">-- This is safe when the code is simply not yet ready to transition to the</span><span>
</span><a name="line-280"></a><span>    </span><span class="hs-comment">-- next era, because in that case, we can be sure that blocks that come in</span><span>
</span><a name="line-281"></a><span>    </span><span class="hs-comment">-- are still from this era. It also means that we can always /produce/ a</span><span>
</span><a name="line-282"></a><span>    </span><span class="hs-comment">-- block, no matter how far ahead of the current ledger we are.</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">-- If the code is ready for the transition, just awaiting an update</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- proposal, then 'LowerBound' can be used instead.</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-comment">-- This constructor can be regarded as an &quot; extreme &quot; version of</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-comment">-- 'LowerBound', and can be used for similar reasons.</span><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UnsafeUnbounded"><a href="Ouroboros.Consensus.HardFork.History.html#UnsafeUnbounded"><span class="hs-identifier">UnsafeUnbounded</span></a></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">-- | The shape of the chain (old to new)</span><span>
</span><a name="line-294"></a><span class="hs-comment">--</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- The shape determines how many hard forks we expect as well as the parameters</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- for each era. The type argument is a type-level list containing one entry</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- per era, emphasizing that this information is statically known.</span><span>
</span><a name="line-298"></a><span class="hs-comment">--</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- The indices are currently not yet used, but the idea is that they look</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- something like @'[Byron, Shelley, Goguen]@ and are then also used by the</span><span>
</span><a name="line-301"></a><span class="hs-comment">-- hard fork combinator (most likely this will be a list of block types, since</span><span>
</span><a name="line-302"></a><span class="hs-comment">-- most of consensus is indexed by block types).</span><span>
</span><a name="line-303"></a><span class="hs-keyword">newtype</span><span> </span><a name="Shape"><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier">Shape</span></a></a><span> </span><a name="local-6989586621679362505"><a href="#local-6989586621679362505"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Shape"><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier">Shape</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#Exactly"><span class="hs-identifier hs-type">Exactly</span></a><span> </span><a href="#local-6989586621679362505"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span> </span><span class="hs-keyword">via</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#UseIsNormalFormNamed"><span class="hs-identifier hs-type">UseIsNormalFormNamed</span></a><span> </span><span class="hs-string">&quot;Shape&quot;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-type">Shape</span></a><span> </span><a href="#local-6989586621679362505"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-comment">-- | There is only one era</span><span>
</span><a name="line-308"></a><span class="hs-identifier">singletonShape</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-type">Shape</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><a href="#local-6989586621679362565"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-309"></a><a name="singletonShape"><a href="Ouroboros.Consensus.HardFork.History.html#singletonShape"><span class="hs-identifier">singletonShape</span></a></a><span> </span><a name="local-6989586621679362569"><a href="#local-6989586621679362569"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-var">Shape</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#exactlyOne"><span class="hs-identifier hs-var">exactlyOne</span></a><span> </span><a href="#local-6989586621679362569"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-comment">-- | The exact point of each confirmed hard fork transition (old to new)</span><span>
</span><a name="line-312"></a><span class="hs-comment">--</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- Unlike the 'Shape' of the chain, which is statically known, the 'Transitions'</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- are derived from the state of the ledger (hard fork transition points only</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- become known after a voting procedure).</span><span>
</span><a name="line-316"></a><span class="hs-comment">--</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- Any transition listed here must be &quot;certain&quot;. How certainty is established is</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- ledger dependent, but it should imply that this is no longer subject to</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- rollback.</span><span>
</span><a name="line-320"></a><span class="hs-keyword">data</span><span> </span><a name="Transitions"><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier">Transitions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-operator">*</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator">*</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-321"></a><span>  </span><span class="hs-comment">-- | If the indices are, say, @'[Byron, Shelley, Goguen]@, then we can have</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-comment">-- have at most two transitions: one to Shelley, and one to Goguen. There</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-comment">-- cannot be a transition /to/ the initial ledger.</span><span>
</span><a name="line-324"></a><span>  </span><a name="Transitions"><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier">Transitions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#AtMost"><span class="hs-identifier hs-type">AtMost</span></a><span> </span><a href="#local-6989586621679362503"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-type">Transitions</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362503"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-type">Transitions</span></a><span> </span><a href="#local-6989586621679362741"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">-- | No known transitions yet</span><span>
</span><a name="line-329"></a><span class="hs-identifier">transitionsUnknown</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-type">Transitions</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362564"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><a name="transitionsUnknown"><a href="Ouroboros.Consensus.HardFork.History.html#transitionsUnknown"><span class="hs-identifier">transitionsUnknown</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-var">Transitions</span></a><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#AtMostNil"><span class="hs-identifier hs-var">AtMostNil</span></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Bounds
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-comment">-- | Detailed information about the time bounds of an era</span><span>
</span><a name="line-337"></a><span class="hs-keyword">data</span><span> </span><a name="Bound"><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier">Bound</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Bound"><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier">Bound</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-338"></a><span>      </span><a name="boundTime"><a href="Ouroboros.Consensus.HardFork.History.html#boundTime"><span class="hs-identifier">boundTime</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">UTCTime</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="boundSlot"><a href="Ouroboros.Consensus.HardFork.History.html#boundSlot"><span class="hs-identifier">boundSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-340"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="boundEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#boundEpoch"><span class="hs-identifier">boundEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-341"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Serialise</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-identifier">initBound</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-type">SystemStart</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>
</span><a name="line-346"></a><a name="initBound"><a href="Ouroboros.Consensus.HardFork.History.html#initBound"><span class="hs-identifier">initBound</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-var">SystemStart</span></a><span> </span><a name="local-6989586621679362570"><a href="#local-6989586621679362570"><span class="hs-identifier">start</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-var">Bound</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-347"></a><span>      </span><span class="hs-identifier">boundTime</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362570"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-348"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundSlot</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-349"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-comment">-- | Version of 'mkUpperBound' when the upper bound may not be known</span><span>
</span><a name="line-353"></a><span class="hs-comment">--</span><span>
</span><a name="line-354"></a><span class="hs-comment">-- If passed 'Nothing', assumes 'EraUnbounded'. This is /NOT/</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- suitable for eras where the transition is simply unknown.</span><span>
</span><a name="line-356"></a><span class="hs-identifier">mkEraEnd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span>
</span><a name="line-357"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>          </span><span class="hs-comment">-- ^ Lower bound</span><span>
</span><a name="line-358"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>  </span><span class="hs-comment">-- ^ Upper bound</span><span>
</span><a name="line-359"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span>
</span><a name="line-360"></a><a name="mkEraEnd"><a href="Ouroboros.Consensus.HardFork.History.html#mkEraEnd"><span class="hs-identifier">mkEraEnd</span></a></a><span> </span><a name="local-6989586621679362571"><a href="#local-6989586621679362571"><span class="hs-identifier">params</span></a></a><span> </span><a name="local-6989586621679362572"><a href="#local-6989586621679362572"><span class="hs-identifier">lo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#mkUpperBound"><span class="hs-identifier hs-var">mkUpperBound</span></a><span> </span><a href="#local-6989586621679362571"><span class="hs-identifier hs-var">params</span></a><span> </span><a href="#local-6989586621679362572"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">-- | Compute upper bound given just the epoch number and era parameters</span><span>
</span><a name="line-363"></a><span class="hs-identifier">mkUpperBound</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span>
</span><a name="line-364"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>    </span><span class="hs-comment">-- ^ Lower bound</span><span>
</span><a name="line-365"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>  </span><span class="hs-comment">-- ^ Upper bound</span><span>
</span><a name="line-366"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>
</span><a name="line-367"></a><a name="mkUpperBound"><a href="Ouroboros.Consensus.HardFork.History.html#mkUpperBound"><span class="hs-identifier">mkUpperBound</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-var">EraParams</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679362576"><a href="#local-6989586621679362576"><span class="hs-identifier">lo</span></a></a><span> </span><a name="local-6989586621679362577"><a href="#local-6989586621679362577"><span class="hs-identifier">hiEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-var">Bound</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-368"></a><span>      </span><span class="hs-identifier">boundTime</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span> </span><a href="#local-6989586621679362580"><span class="hs-identifier hs-var">inEraTime</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362576"><span class="hs-identifier hs-var">lo</span></a><span>
</span><a name="line-369"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundSlot</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier hs-var">addSlots</span></a><span>   </span><a href="#local-6989586621679362579"><span class="hs-identifier hs-var">inEraSlots</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362576"><span class="hs-identifier hs-var">lo</span></a><span>
</span><a name="line-370"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362577"><span class="hs-identifier hs-var">hiEpoch</span></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-372"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-373"></a><span>    </span><span class="hs-identifier">inEraEpochs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inEraSlots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621679362578"><a href="#local-6989586621679362578"><span class="hs-identifier">inEraEpochs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#countEpochs"><span class="hs-identifier hs-var">countEpochs</span></a><span> </span><a href="#local-6989586621679362577"><span class="hs-identifier hs-var">hiEpoch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362576"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621679362579"><a href="#local-6989586621679362579"><span class="hs-identifier">inEraSlots</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362578"><span class="hs-identifier hs-var">inEraEpochs</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">unEpochSize</span><span> </span><a href="#local-6989586621679362573"><span class="hs-identifier hs-var">eraEpochSize</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-identifier">inEraTime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621679362580"><a href="#local-6989586621679362580"><span class="hs-identifier">inEraTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679362579"><span class="hs-identifier hs-var">inEraSlots</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">getSlotLength</span><span> </span><a href="#local-6989586621679362574"><span class="hs-identifier hs-var">eraSlotLength</span></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: summary

  This is what we use internally for all translations.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- | Information about a specific era</span><span>
</span><a name="line-387"></a><span class="hs-comment">--</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- The 'eraEnd' of the final era in the summary will be determined by the</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- safe zone considerations discussed above.</span><span>
</span><a name="line-390"></a><span class="hs-comment">--</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- Let the start of the summary be @(t, s, e)@ (time, slot epoch), and the</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- end of the summary be @(t', s', e')@. We have one invariant relating</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- epochs and slots:</span><span>
</span><a name="line-394"></a><span class="hs-comment">--</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- &gt; INV-1a  e' == e + ((s' - s) / epochSize)</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- &gt; INV-1b: s' == s + ((e' - e) * epochSize)</span><span>
</span><a name="line-397"></a><span class="hs-comment">--</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- And another invariant relating time and slots:</span><span>
</span><a name="line-399"></a><span class="hs-comment">--</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- &gt; INV-2a: s' == s + ((t' - t) / slotLen)</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- &gt; INV-2b: t' == t + ((s' - s) * slotLen)</span><span>
</span><a name="line-402"></a><span class="hs-comment">--</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- Note that these aren't really two sets of independent invariants. @INV-1a@</span><span>
</span><a name="line-404"></a><span class="hs-comment">-- follows from @INV-1b@:</span><span>
</span><a name="line-405"></a><span class="hs-comment">--</span><span>
</span><a name="line-406"></a><span class="hs-comment">-- &gt;       s'                   == s + ((e' - e) * epochSize)</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- &gt;       s' - s               ==     ((e' - e) * epochSize)</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- &gt;      (s' - s) / epochSize  ==       e' - e</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- &gt; e + ((s' - s) / epochSize) ==       e'</span><span>
</span><a name="line-410"></a><span class="hs-comment">--</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- Similarly, @INV-2a@ follows from @INV-2b@:</span><span>
</span><a name="line-412"></a><span class="hs-comment">--</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- &gt;       t'                 == t + ((s' - s) * slotLen)</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- &gt;       t' - t             ==     ((s' - s) * slotLen)</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- &gt;      (t' - t) / slotLen  ==       s' - s</span><span>
</span><a name="line-416"></a><span class="hs-comment">-- &gt; s + ((t' - t) / slotLen) ==       s'</span><span>
</span><a name="line-417"></a><span class="hs-keyword">data</span><span> </span><a name="EraSummary"><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier">EraSummary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EraSummary"><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier">EraSummary</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-418"></a><span>      </span><a name="eraStart"><a href="Ouroboros.Consensus.HardFork.History.html#eraStart"><span class="hs-identifier">eraStart</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>     </span><span class="hs-comment">-- ^ Inclusive lower bound</span><span>
</span><a name="line-419"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="eraEnd"><a href="Ouroboros.Consensus.HardFork.History.html#eraEnd"><span class="hs-identifier">eraEnd</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span>    </span><span class="hs-comment">-- ^ Exclusive upper bound</span><span>
</span><a name="line-420"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="eraParams"><a href="Ouroboros.Consensus.HardFork.History.html#eraParams"><span class="hs-identifier">eraParams</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span> </span><span class="hs-comment">-- ^ Active parameters</span><span>
</span><a name="line-421"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-comment">-- | Exclusive upper bound on the era</span><span>
</span><a name="line-426"></a><span class="hs-keyword">data</span><span> </span><a name="EraEnd"><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier">EraEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-427"></a><span>    </span><span class="hs-comment">-- | Bounded era</span><span>
</span><a name="line-428"></a><span>    </span><a name="EraEnd"><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier">EraEnd</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>    </span><span class="hs-comment">-- | Unbounded era</span><span>
</span><a name="line-431"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-comment">-- This arises from the use of 'UnsafeUnbounded'.</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="EraUnbounded"><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier">EraUnbounded</span></a></a><span>
</span><a name="line-434"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">stock</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">anyclass</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-comment">-- | Summary of the /confirmed/ part of the ledger</span><span>
</span><a name="line-438"></a><span class="hs-comment">--</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- The summary zips 'Shape' with 'Forks', and provides detailed information</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- about the start and end of each era.</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-comment">-- We have at most one summary for each era, and at least one</span><span>
</span><a name="line-443"></a><span class="hs-keyword">newtype</span><span> </span><a name="Summary"><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier">Summary</span></a></a><span> </span><a name="local-6989586621679362502"><a href="#local-6989586621679362502"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Summary"><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier">Summary</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a><span> </span><a href="#local-6989586621679362502"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-comment">-- WHNF is sufficient, because the counting types are all strict</span><span>
</span><a name="line-447"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#UseIsNormalFormNamed"><span class="hs-identifier hs-type">UseIsNormalFormNamed</span></a><span> </span><span class="hs-string">&quot;Summary&quot;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362740"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>         </span><span class="hs-keyword">instance</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-prelude-0.1.0.0/noopt/doc/html/cardano-prelude/src/Cardano.Prelude.GHC.Heap.NormalForm.Classy.html#NoUnexpectedThunks"><span class="hs-identifier hs-type">NoUnexpectedThunks</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362740"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Trivial summary
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-comment">-- | 'Summary' for a ledger that never forks</span><span>
</span><a name="line-455"></a><span class="hs-identifier">neverForksSummary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-type">SystemStart</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><a href="#local-6989586621679362562"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-456"></a><a name="neverForksSummary"><a href="Ouroboros.Consensus.HardFork.History.html#neverForksSummary"><span class="hs-identifier">neverForksSummary</span></a></a><span> </span><a name="local-6989586621679362581"><a href="#local-6989586621679362581"><span class="hs-identifier">start</span></a></a><span> </span><a name="local-6989586621679362582"><a href="#local-6989586621679362582"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#NonEmptyOne"><span class="hs-identifier hs-var">NonEmptyOne</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-457"></a><span>      </span><span class="hs-identifier">eraStart</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#initBound"><span class="hs-identifier hs-var">initBound</span></a><span> </span><a href="#local-6989586621679362581"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-458"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraEnd</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span>
</span><a name="line-459"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraParams</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362582"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-460"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Basic API for 'Summary'
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-comment">-- | Outer bounds of the summary</span><span>
</span><a name="line-467"></a><span class="hs-identifier">summaryBounds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362561"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><a name="summaryBounds"><a href="Ouroboros.Consensus.HardFork.History.html#summaryBounds"><span class="hs-identifier">summaryBounds</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><a name="local-6989586621679362583"><a href="#local-6989586621679362583"><span class="hs-identifier">summary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">eraStart</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#nonEmptyHead"><span class="hs-identifier hs-var">nonEmptyHead</span></a><span> </span><a href="#local-6989586621679362583"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraEnd</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#nonEmptyLast"><span class="hs-identifier hs-var">nonEmptyLast</span></a><span> </span><a href="#local-6989586621679362583"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span class="hs-comment">-- | Analogue of 'Data.List.init' for 'Summary' (i.e., split off the final era)</span><span>
</span><a name="line-472"></a><span class="hs-comment">--</span><span>
</span><a name="line-473"></a><span class="hs-comment">-- This is primarily useful for tests.</span><span>
</span><a name="line-474"></a><span class="hs-identifier">summaryInit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362560"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362560"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><a name="summaryInit"><a href="Ouroboros.Consensus.HardFork.History.html#summaryInit"><span class="hs-identifier">summaryInit</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><a name="local-6989586621679362584"><a href="#local-6989586621679362584"><span class="hs-identifier">summary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#nonEmptyInit"><span class="hs-identifier hs-var">nonEmptyInit</span></a><span> </span><a href="#local-6989586621679362584"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">-- | Construct 'Summary' with an exact number of 'EraSummary'</span><span>
</span><a name="line-478"></a><span class="hs-comment">--</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- Primarily useful for tests.</span><span>
</span><a name="line-480"></a><span class="hs-identifier">summaryWithExactly</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#Exactly"><span class="hs-identifier hs-type">Exactly</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362559"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362559"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><a name="summaryWithExactly"><a href="Ouroboros.Consensus.HardFork.History.html#summaryWithExactly"><span class="hs-identifier">summaryWithExactly</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#exactlyWeakenNonEmpty"><span class="hs-identifier hs-var">exactlyWeakenNonEmpty</span></a><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Translations (primarily for the benefit of tests)
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-keyword">class</span><span> </span><a name="ShiftTime"><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier">ShiftTime</span></a></a><span> </span><a name="local-6989586621679362501"><a href="#local-6989586621679362501"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-488"></a><span>  </span><a name="shiftTime"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362501"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362501"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-type">SystemStart</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-491"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><a name="local-6989586621679362537"><a href="#local-6989586621679362537"><span class="hs-identifier">delta</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-var">SystemStart</span></a><span> </span><a name="local-6989586621679362538"><a href="#local-6989586621679362538"><span class="hs-identifier">start</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-var">SystemStart</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362537"><span class="hs-identifier hs-var">delta</span></a><span> </span><a href="#local-6989586621679362538"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><a href="#local-6989586621679362536"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679362536"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-494"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362533"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-497"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><a name="local-6989586621679362534"><a href="#local-6989586621679362534"><span class="hs-identifier">delta</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><a name="local-6989586621679362535"><a href="#local-6989586621679362535"><span class="hs-identifier">summary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362534"><span class="hs-identifier hs-var">delta</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679362535"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-500"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><a name="local-6989586621679362529"><a href="#local-6989586621679362529"><span class="hs-identifier">delta</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span class="hs-special">{</span><span>
</span><a name="line-501"></a><span>      </span><span class="hs-identifier">eraStart</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362529"><span class="hs-identifier hs-var">delta</span></a><span> </span><a href="#local-6989586621679362530"><span class="hs-identifier hs-var">eraStart</span></a><span>
</span><a name="line-502"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraEnd</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362529"><span class="hs-identifier hs-var">delta</span></a><span> </span><a href="#local-6989586621679362531"><span class="hs-identifier hs-var">eraEnd</span></a><span>
</span><a name="line-503"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eraParams</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362532"><span class="hs-identifier hs-var">eraParams</span></a><span>
</span><a name="line-504"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-507"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><a name="local-6989586621679362527"><a href="#local-6989586621679362527"><span class="hs-identifier">delta</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><a name="local-6989586621679362528"><a href="#local-6989586621679362528"><span class="hs-identifier">bound</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362527"><span class="hs-identifier hs-var">delta</span></a><span> </span><a href="#local-6989586621679362528"><span class="hs-identifier hs-var">bound</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-identifier">shiftTime</span><span> </span><span class="hs-identifier">_</span><span>     </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-511"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><a name="local-6989586621679362523"><a href="#local-6989586621679362523"><span class="hs-identifier">delta</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-var">Bound</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-var">Bound</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-512"></a><span>      </span><span class="hs-identifier">boundTime</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier hs-var">shiftTime</span></a><span> </span><a href="#local-6989586621679362523"><span class="hs-identifier hs-var">delta</span></a><span> </span><a href="#local-6989586621679362524"><span class="hs-identifier hs-var">boundTime</span></a><span>
</span><a name="line-513"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundSlot</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362525"><span class="hs-identifier hs-var">boundSlot</span></a><span>
</span><a name="line-514"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362526"><span class="hs-identifier hs-var">boundEpoch</span></a><span>
</span><a name="line-515"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-keyword">instance</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#ShiftTime"><span class="hs-identifier hs-type">ShiftTime</span></a><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-518"></a><span>  </span><a name="local-8214565720324137339"><a href="Ouroboros.Consensus.HardFork.History.html#shiftTime"><span class="hs-identifier">shiftTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Invariants
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-comment">-- | Check 'Shape' invariants</span><span>
</span><a name="line-525"></a><span class="hs-comment">--</span><span>
</span><a name="line-526"></a><span class="hs-comment">-- The only part of the 'Shape' that must make sense is the 'safeBeforeEpoch'</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- values (they must be strictly increasing).</span><span>
</span><a name="line-528"></a><span class="hs-comment">--</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- NOTE: We assume eras cannot be empty. This will be satisfied by any ledger</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- we are interested in since transitions must be voted on (safe zones will</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- be non-empty).</span><span>
</span><a name="line-532"></a><span class="hs-identifier">invariantShape</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-type">Shape</span></a><span> </span><a href="#local-6989586621679362557"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Except</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><a name="invariantShape"><a href="Ouroboros.Consensus.HardFork.History.html#invariantShape"><span class="hs-identifier">invariantShape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-var">Shape</span></a><span> </span><a name="local-6989586621679362592"><a href="#local-6989586621679362592"><span class="hs-identifier">shape</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-534"></a><span>    </span><a href="#local-6989586621679362585"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679362592"><span class="hs-identifier hs-var">shape</span></a><span>
</span><a name="line-535"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-536"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-comment">-- Lower bound on the start of the era</span><span>
</span><a name="line-537"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#Exactly"><span class="hs-identifier hs-type">Exactly</span></a><span> </span><a href="#local-6989586621679362586"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Except</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>    </span><a name="local-6989586621679362585"><a href="#local-6989586621679362585"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>           </span><a href="Ouroboros.Consensus.Util.Counting.html#ExactlyNil"><span class="hs-identifier hs-var">ExactlyNil</span></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679362587"><a href="#local-6989586621679362587"><span class="hs-identifier">lowerBound</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#ExactlyCons"><span class="hs-identifier hs-var">ExactlyCons</span></a><span> </span><a name="local-6989586621679362588"><a href="#local-6989586621679362588"><span class="hs-identifier">curParams</span></a></a><span> </span><a name="local-6989586621679362589"><a href="#local-6989586621679362589"><span class="hs-identifier">shape'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-540"></a><span>        </span><a name="local-6989586621679362591"><a href="#local-6989586621679362591"><span class="hs-identifier">nextLowerBound</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-541"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">safeBeforeEpoch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eraSafeZone</span><span> </span><a href="#local-6989586621679362588"><span class="hs-identifier hs-var">curParams</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-542"></a><span>            </span><a href="Ouroboros.Consensus.HardFork.History.html#NoLowerBound"><span class="hs-identifier hs-var">NoLowerBound</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-543"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier hs-var">addEpochs</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679362587"><span class="hs-identifier hs-var">lowerBound</span></a><span>
</span><a name="line-544"></a><span>            </span><a href="Ouroboros.Consensus.HardFork.History.html#UnsafeUnbounded"><span class="hs-identifier hs-var">UnsafeUnbounded</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-545"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier hs-var">addEpochs</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679362587"><span class="hs-identifier hs-var">lowerBound</span></a><span>
</span><a name="line-546"></a><span>            </span><a href="Ouroboros.Consensus.HardFork.History.html#LowerBound"><span class="hs-identifier hs-var">LowerBound</span></a><span> </span><a name="local-6989586621679362590"><a href="#local-6989586621679362590"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-547"></a><span>              </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362590"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679362587"><span class="hs-identifier hs-var">lowerBound</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-548"></a><span>                </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-549"></a><span>                    </span><span class="hs-string">&quot;Invalid safeBeforeEpoch in &quot;</span><span>
</span><a name="line-550"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362588"><span class="hs-identifier hs-var">curParams</span></a><span>
</span><a name="line-551"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; (should be greater than &quot;</span><span>
</span><a name="line-552"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362587"><span class="hs-identifier hs-var">lowerBound</span></a><span>
</span><a name="line-553"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-554"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-555"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362590"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span>        </span><a href="#local-6989586621679362585"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679362591"><span class="hs-identifier hs-var">nextLowerBound</span></a><span> </span><a href="#local-6989586621679362589"><span class="hs-identifier hs-var">shape'</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span class="hs-comment">-- | Check 'Summary' invariants</span><span>
</span><a name="line-560"></a><span class="hs-identifier">invariantSummary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362556"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Except</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-561"></a><a name="invariantSummary"><a href="Ouroboros.Consensus.HardFork.History.html#invariantSummary"><span class="hs-identifier">invariantSummary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><a name="local-6989586621679362605"><a href="#local-6989586621679362605"><span class="hs-identifier">summary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-comment">-- Pretend the start of the first era is the &quot;end of the previous&quot; one</span><span>
</span><a name="line-563"></a><span>    </span><a href="#local-6989586621679362593"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eraStart</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#nonEmptyHead"><span class="hs-identifier hs-var">nonEmptyHead</span></a><span> </span><a href="#local-6989586621679362605"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679362605"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-565"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>   </span><span class="hs-comment">-- ^ End of the previous era</span><span>
</span><a name="line-566"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Except</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>    </span><a name="local-6989586621679362593"><a href="#local-6989586621679362593"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679362594"><a href="#local-6989586621679362594"><span class="hs-identifier">prevEnd</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679362595"><a href="#local-6989586621679362595"><span class="hs-identifier">curSummary</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679362596"><a href="#local-6989586621679362596"><span class="hs-identifier">next</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-569"></a><span>        </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679362594"><span class="hs-identifier hs-var">prevEnd</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-570"></a><span>          </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-571"></a><span>              </span><span class="hs-string">&quot;Bounds don't line up: end of previous era &quot;</span><span>
</span><a name="line-572"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362594"><span class="hs-identifier hs-var">prevEnd</span></a><span>
</span><a name="line-573"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; /= start of current era &quot;</span><span>
</span><a name="line-574"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span>
</span><a name="line-575"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679362598"><span class="hs-identifier hs-var">mCurEnd</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-578"></a><span>          </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-579"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679362596"><span class="hs-identifier hs-var">next</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-580"></a><span>              </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-string">&quot;Unbounded non-final era&quot;</span><span>
</span><a name="line-581"></a><span>          </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><a name="local-6989586621679362600"><a href="#local-6989586621679362600"><span class="hs-identifier">curEnd</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-582"></a><span>            </span><span class="hs-comment">-- Check the invariants mentioned at 'EraSummary'</span><span>
</span><a name="line-583"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-584"></a><span>            </span><span class="hs-comment">-- o @epochsInEra@ corresponds to @e' - e@</span><span>
</span><a name="line-585"></a><span>            </span><span class="hs-comment">-- o @slotsInEra@ corresponds to @(e' - e) * epochSize)@</span><span>
</span><a name="line-586"></a><span>            </span><span class="hs-comment">-- o @timeInEra@ corresponds to @((e' - e) * epochSize * slotLen@</span><span>
</span><a name="line-587"></a><span>            </span><span class="hs-comment">--   which, if INV-1b holds, equals @(s' - s) * slotLen@</span><span>
</span><a name="line-588"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">epochsInEra</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">slotsInEra</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-589"></a><span>                </span><a name="local-6989586621679362601"><a href="#local-6989586621679362601"><span class="hs-identifier">epochsInEra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#countEpochs"><span class="hs-identifier hs-var">countEpochs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>                </span><a name="local-6989586621679362602"><a href="#local-6989586621679362602"><span class="hs-identifier">slotsInEra</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362601"><span class="hs-identifier hs-var">epochsInEra</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">unEpochSize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eraEpochSize</span><span> </span><a href="#local-6989586621679362599"><span class="hs-identifier hs-var">curParams</span></a><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span>                </span><span class="hs-identifier">timeInEra</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span>
</span><a name="line-593"></a><span>                </span><a name="local-6989586621679362603"><a href="#local-6989586621679362603"><span class="hs-identifier">timeInEra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679362602"><span class="hs-identifier hs-var">slotsInEra</span></a><span>
</span><a name="line-594"></a><span>                          </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier">getSlotLength</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eraSlotLength</span><span> </span><a href="#local-6989586621679362599"><span class="hs-identifier hs-var">curParams</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-597"></a><span>              </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-string">&quot;Empty era&quot;</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">safeBeforeEpoch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eraSafeZone</span><span> </span><a href="#local-6989586621679362599"><span class="hs-identifier hs-var">curParams</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-600"></a><span>              </span><a href="Ouroboros.Consensus.HardFork.History.html#NoLowerBound"><span class="hs-identifier hs-var">NoLowerBound</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>              </span><a href="Ouroboros.Consensus.HardFork.History.html#UnsafeUnbounded"><span class="hs-identifier hs-var">UnsafeUnbounded</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>              </span><a href="Ouroboros.Consensus.HardFork.History.html#LowerBound"><span class="hs-identifier hs-var">LowerBound</span></a><span> </span><a name="local-6989586621679362604"><a href="#local-6989586621679362604"><span class="hs-identifier">e</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-603"></a><span>                </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679362604"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-604"></a><span>                  </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-605"></a><span>                      </span><span class="hs-string">&quot;Invalid upper epoch bound &quot;</span><span>
</span><a name="line-606"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; (should be greater than &quot;</span><span>
</span><a name="line-608"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362604"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-609"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-610"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier hs-var">addSlots</span></a><span> </span><a href="#local-6989586621679362602"><span class="hs-identifier hs-var">slotsInEra</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-613"></a><span>              </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-614"></a><span>                  </span><span class="hs-string">&quot;Invalid final boundSlot in &quot;</span><span>
</span><a name="line-615"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362595"><span class="hs-identifier hs-var">curSummary</span></a><span>
</span><a name="line-616"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; (INV-1b)&quot;</span><span>
</span><a name="line-617"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span> </span><a href="#local-6989586621679362603"><span class="hs-identifier hs-var">timeInEra</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362597"><span class="hs-identifier hs-var">curStart</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-620"></a><span>              </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-621"></a><span>                  </span><span class="hs-string">&quot;Invalid final boundTime in &quot;</span><span>
</span><a name="line-622"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679362595"><span class="hs-identifier hs-var">curSummary</span></a><span>
</span><a name="line-623"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; (INV-2b)&quot;</span><span>
</span><a name="line-624"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>            </span><a href="#local-6989586621679362593"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679362600"><span class="hs-identifier hs-var">curEnd</span></a><span> </span><a href="#local-6989586621679362596"><span class="hs-identifier hs-var">next</span></a><span>
</span><a name="line-627"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-628"></a><span>        </span><span class="hs-identifier">curStart</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>
</span><a name="line-629"></a><span>        </span><span class="hs-identifier">mCurEnd</span><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span>
</span><a name="line-630"></a><span>        </span><span class="hs-identifier">curParams</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span>
</span><a name="line-631"></a><span>        </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span> </span><a name="local-6989586621679362597"><a href="#local-6989586621679362597"><span class="hs-identifier">curStart</span></a></a><span> </span><a name="local-6989586621679362598"><a href="#local-6989586621679362598"><span class="hs-identifier">mCurEnd</span></a></a><span> </span><a name="local-6989586621679362599"><a href="#local-6989586621679362599"><span class="hs-identifier">curParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362595"><span class="hs-identifier hs-var">curSummary</span></a><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Constructing the summary
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-comment">-- | Construct hard fork 'Summary'</span><span>
</span><a name="line-638"></a><span class="hs-comment">--</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- NOTE (on epoch to slot translation). In order to translate 'SlotNo' to</span><span>
</span><a name="line-640"></a><span class="hs-comment">-- 'EpochNo', we simply &quot;line up&quot; all slots. For example, suppose we have</span><span>
</span><a name="line-641"></a><span class="hs-comment">-- an initial 'EpochSize' of 10, and then an 'EpochSize' of 20 from 'EpochNo'</span><span>
</span><a name="line-642"></a><span class="hs-comment">-- 3 onwards. We end up with something like</span><span>
</span><a name="line-643"></a><span class="hs-comment">--</span><span>
</span><a name="line-644"></a><span class="hs-comment">-- &gt; Epoch | 0      | 1        | 2        | 3        | 4        | ..</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- &gt; Slot  | 0 .. 9 | 10 .. 19 | 20 .. 29 | 30 .. 49 | 50 .. 69 | ..</span><span>
</span><a name="line-646"></a><span class="hs-comment">--</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- We do this translation /independent/ from the 'minimumPossibleSlotNo'</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- for a particular ledger. This means that for ledgers where the</span><span>
</span><a name="line-649"></a><span class="hs-comment">-- 'minimumPossibleSlotNo' is not zero (e.g., some ledgers might set it to 1),</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- the maximum number of blocks (aka filled slots) in an epoch is just 1 (or</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- more) less than the other epochs.</span><span>
</span><a name="line-652"></a><span class="hs-identifier">summarize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SystemStart"><span class="hs-identifier hs-type">SystemStart</span></a><span>
</span><a name="line-653"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#WithOrigin"><span class="hs-identifier hs-type">WithOrigin</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-comment">-- ^ Slot at the tip of the ledger</span><span>
</span><a name="line-654"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-type">Shape</span></a><span>       </span><a href="#local-6989586621679362555"><span class="hs-identifier hs-type">xs</span></a><span>
</span><a name="line-655"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-type">Transitions</span></a><span> </span><a href="#local-6989586621679362555"><span class="hs-identifier hs-type">xs</span></a><span>
</span><a name="line-656"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span>     </span><a href="#local-6989586621679362555"><span class="hs-identifier hs-type">xs</span></a><span>
</span><a name="line-657"></a><a name="summarize"><a href="Ouroboros.Consensus.HardFork.History.html#summarize"><span class="hs-identifier">summarize</span></a></a><span> </span><a name="local-6989586621679362606"><a href="#local-6989586621679362606"><span class="hs-identifier">systemStart</span></a></a><span> </span><a name="local-6989586621679362607"><a href="#local-6989586621679362607"><span class="hs-identifier">ledgerTip</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Shape"><span class="hs-identifier hs-var">Shape</span></a><span> </span><a name="local-6989586621679362625"><a href="#local-6989586621679362625"><span class="hs-identifier">shape</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Transitions"><span class="hs-identifier hs-var">Transitions</span></a><span> </span><a name="local-6989586621679362626"><a href="#local-6989586621679362626"><span class="hs-identifier">transitions</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-658"></a><span>    </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362608"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#initBound"><span class="hs-identifier hs-var">initBound</span></a><span> </span><a href="#local-6989586621679362606"><span class="hs-identifier hs-var">systemStart</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679362625"><span class="hs-identifier hs-var">shape</span></a><span> </span><a href="#local-6989586621679362626"><span class="hs-identifier hs-var">transitions</span></a><span>
</span><a name="line-659"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-660"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span>                          </span><span class="hs-comment">-- Lower bound for current era</span><span>
</span><a name="line-661"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#Exactly"><span class="hs-identifier hs-type">Exactly</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362611"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span>   </span><span class="hs-comment">-- params for all eras</span><span>
</span><a name="line-662"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#AtMost"><span class="hs-identifier hs-type">AtMost</span></a><span>         </span><a href="#local-6989586621679362611"><span class="hs-identifier hs-type">xs</span></a><span>  </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>     </span><span class="hs-comment">-- transitions</span><span>
</span><a name="line-663"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">x</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679362611"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span>
</span><a name="line-664"></a><span>    </span><span class="hs-comment">-- CASE (ii)</span><span>
</span><a name="line-665"></a><span>    </span><span class="hs-comment">-- NOTE: Ledger tip might be close to the end of this era (or indeed past</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-comment">-- it) but this doesn't matter for the summary of /this/ era.</span><span>
</span><a name="line-667"></a><span>    </span><a name="local-6989586621679362608"><a href="#local-6989586621679362608"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679362612"><a href="#local-6989586621679362612"><span class="hs-identifier">lo</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#ExactlyCons"><span class="hs-identifier hs-var">ExactlyCons</span></a><span> </span><a name="local-6989586621679362613"><a href="#local-6989586621679362613"><span class="hs-identifier">params</span></a></a><span> </span><a name="local-6989586621679362614"><a href="#local-6989586621679362614"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#AtMostCons"><span class="hs-identifier hs-var">AtMostCons</span></a><span> </span><a name="local-6989586621679362615"><a href="#local-6989586621679362615"><span class="hs-identifier">epoch</span></a></a><span> </span><a name="local-6989586621679362616"><a href="#local-6989586621679362616"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-668"></a><span>        </span><a href="Ouroboros.Consensus.Util.Counting.html#NonEmptyCons"><span class="hs-identifier hs-var">NonEmptyCons</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span> </span><a href="#local-6989586621679362612"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><a href="#local-6989586621679362617"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679362613"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679362617"><span class="hs-identifier hs-var">hi</span></a><span> </span><a href="#local-6989586621679362614"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621679362616"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-669"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-670"></a><span>        </span><a name="local-6989586621679362617"><a href="#local-6989586621679362617"><span class="hs-identifier">hi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#mkUpperBound"><span class="hs-identifier hs-var">mkUpperBound</span></a><span> </span><a href="#local-6989586621679362613"><span class="hs-identifier hs-var">params</span></a><span> </span><a href="#local-6989586621679362612"><span class="hs-identifier hs-var">lo</span></a><span> </span><a href="#local-6989586621679362615"><span class="hs-identifier hs-var">epoch</span></a><span>
</span><a name="line-671"></a><span>    </span><span class="hs-comment">-- CASE (i) or (iii)</span><span>
</span><a name="line-672"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679362618"><a href="#local-6989586621679362618"><span class="hs-identifier">lo</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.Util.Counting.html#ExactlyCons"><span class="hs-identifier hs-var">ExactlyCons</span></a><span> </span><a name="local-6989586621679362619"><a href="#local-6989586621679362619"><span class="hs-identifier">params</span></a></a><span class="hs-glyph">@</span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-var">EraParams</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a href="Ouroboros.Consensus.Util.Counting.html#AtMostNil"><span class="hs-identifier hs-var">AtMostNil</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-673"></a><span>        </span><a href="Ouroboros.Consensus.Util.Counting.html#NonEmptyOne"><span class="hs-identifier hs-var">NonEmptyOne</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span> </span><a href="#local-6989586621679362618"><span class="hs-identifier hs-var">lo</span></a><span> </span><a href="#local-6989586621679362623"><span class="hs-identifier hs-var">hi</span></a><span> </span><a href="#local-6989586621679362619"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-675"></a><span>        </span><span class="hs-identifier">hi</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-type">EraEnd</span></a><span>
</span><a name="line-676"></a><span>        </span><a name="local-6989586621679362623"><a href="#local-6989586621679362623"><span class="hs-identifier">hi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#mkEraEnd"><span class="hs-identifier hs-var">mkEraEnd</span></a><span> </span><a href="#local-6989586621679362619"><span class="hs-identifier hs-var">params</span></a><span> </span><a href="#local-6989586621679362618"><span class="hs-identifier hs-var">lo</span></a><span>
</span><a name="line-677"></a><span>           </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#maxMaybeEpoch"><span class="hs-identifier hs-var">maxMaybeEpoch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">safeBeforeEpoch</span><span> </span><a href="#local-6989586621679362622"><span class="hs-identifier hs-var">eraSafeZone</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>           </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpochBound"><span class="hs-identifier hs-var">slotToEpochBound</span></a><span> </span><a href="#local-6989586621679362619"><span class="hs-identifier hs-var">params</span></a><span> </span><a href="#local-6989586621679362618"><span class="hs-identifier hs-var">lo</span></a><span>
</span><a name="line-679"></a><span>           </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier hs-var">addSlots</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">safeFromTip</span><span> </span><a href="#local-6989586621679362622"><span class="hs-identifier hs-var">eraSafeZone</span></a><span class="hs-special">)</span><span>
</span><a name="line-680"></a><span>             </span><span class="hs-comment">-- If the tip is already in this era, safe zone applies from the</span><span>
</span><a name="line-681"></a><span>             </span><span class="hs-comment">-- ledger tip (CASE (i)). If the ledger tip is in the /previous/</span><span>
</span><a name="line-682"></a><span>             </span><span class="hs-comment">-- era, but the transition to /this/ era is already known, the safe</span><span>
</span><a name="line-683"></a><span>             </span><span class="hs-comment">-- zone applies from the start of this era (CASE (iii)).</span><span>
</span><a name="line-684"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-685"></a><span>             </span><span class="hs-comment">-- NOTE: The upper bound is /exclusive/:</span><span>
</span><a name="line-686"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-687"></a><span>             </span><span class="hs-comment">-- o Suppose the ledger tip is at slot 10, and 'safeFromTip' is 2.</span><span>
</span><a name="line-688"></a><span>             </span><span class="hs-comment">--   Then we should be able to make accurate predictions for slots</span><span>
</span><a name="line-689"></a><span>             </span><span class="hs-comment">--   10 (of course), as well as (the safe zone) slots 11 and 12.</span><span>
</span><a name="line-690"></a><span>             </span><span class="hs-comment">--   Since the upper bound is /exclusive/, this means that the</span><span>
</span><a name="line-691"></a><span>             </span><span class="hs-comment">--   upper bound becomes 13. (Case i)</span><span>
</span><a name="line-692"></a><span>             </span><span class="hs-comment">-- o If the ledger tip is in the previous era (case iii), and the</span><span>
</span><a name="line-693"></a><span>             </span><span class="hs-comment">--   start of this era is slot 100, then we should be able to</span><span>
</span><a name="line-694"></a><span>             </span><span class="hs-comment">--   give accurate predictions for the first two slots in this era</span><span>
</span><a name="line-695"></a><span>             </span><span class="hs-comment">--   (100 and 101), and the upper bound becomes 102.</span><span>
</span><a name="line-696"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-697"></a><span>             </span><span class="hs-comment">-- This explains the use of the extra addition ('next') for</span><span>
</span><a name="line-698"></a><span>             </span><span class="hs-comment">-- case (i) but not for case (iii).</span><span>
</span><a name="line-699"></a><span>           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362609"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621679362607"><span class="hs-identifier hs-var">ledgerTip</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362618"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>    </span><span class="hs-comment">-- Upper bound is exclusive, so we count from the /next/ ledger tip</span><span>
</span><a name="line-702"></a><span>    </span><span class="hs-identifier">next</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#WithOrigin"><span class="hs-identifier hs-type">WithOrigin</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-703"></a><span>    </span><a name="local-6989586621679362609"><a href="#local-6989586621679362609"><span class="hs-identifier">next</span></a></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#Origin"><span class="hs-identifier hs-var">Origin</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-704"></a><span>    </span><span class="hs-identifier">next</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#At"><span class="hs-identifier hs-var">At</span></a><span> </span><a name="local-6989586621679362624"><a href="#local-6989586621679362624"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span> </span><a href="#local-6989586621679362624"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-comment">-- Given the 'SlotNo' of the first /slot/ in which a transition could take</span><span>
</span><a name="line-707"></a><span class="hs-comment">-- place, compute the first /epoch/ in which this could happen (since</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- transitions only take place at epoch boundaries). If the 'SlotNo' happens</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- to be the first slot in an epoch, it will be that 'EpochNo'; if it isn't,</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- however, it will be the /next/ epoch.</span><span>
</span><a name="line-711"></a><span class="hs-identifier">slotToEpochBound</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-type">EraParams</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-712"></a><a name="slotToEpochBound"><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpochBound"><span class="hs-identifier">slotToEpochBound</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-var">EraParams</span></a><span class="hs-special">{</span><span class="hs-identifier">eraEpochSize</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-var">EpochSize</span></a><span> </span><a name="local-6989586621679362627"><a href="#local-6989586621679362627"><span class="hs-identifier">epochSize</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621679362628"><a href="#local-6989586621679362628"><span class="hs-identifier">lo</span></a></a><span> </span><a name="local-6989586621679362629"><a href="#local-6989586621679362629"><span class="hs-identifier">hiSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-713"></a><span>    </span><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier hs-var">addEpochs</span></a><span>
</span><a name="line-714"></a><span>      </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679362632"><span class="hs-identifier hs-var">inEpoch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679362631"><span class="hs-identifier hs-var">epochs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679362631"><span class="hs-identifier hs-var">epochs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362628"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-717"></a><span>    </span><a name="local-6989586621679362630"><a href="#local-6989586621679362630"><span class="hs-identifier">slots</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#countSlots"><span class="hs-identifier hs-var">countSlots</span></a><span> </span><a href="#local-6989586621679362629"><span class="hs-identifier hs-var">hiSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362628"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679362631"><a href="#local-6989586621679362631"><span class="hs-identifier">epochs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679362632"><a href="#local-6989586621679362632"><span class="hs-identifier">inEpoch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362630"><span class="hs-identifier hs-var">slots</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">divMod</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679362627"><span class="hs-identifier hs-var">epochSize</span></a><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-identifier">maxMaybeEpoch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SafeBeforeEpoch"><span class="hs-identifier hs-type">SafeBeforeEpoch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-721"></a><a name="maxMaybeEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#maxMaybeEpoch"><span class="hs-identifier">maxMaybeEpoch</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#NoLowerBound"><span class="hs-identifier hs-var">NoLowerBound</span></a><span>    </span><a name="local-6989586621679362633"><a href="#local-6989586621679362633"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362633"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-722"></a><span class="hs-identifier">maxMaybeEpoch</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#LowerBound"><span class="hs-identifier hs-var">LowerBound</span></a><span> </span><a name="local-6989586621679362634"><a href="#local-6989586621679362634"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679362635"><a href="#local-6989586621679362635"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621679362634"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621679362635"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-723"></a><span class="hs-identifier">maxMaybeEpoch</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#UnsafeUnbounded"><span class="hs-identifier hs-var">UnsafeUnbounded</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  PastHorizonException
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-comment">-- | We tried to convert something that is past the horizon</span><span>
</span><a name="line-730"></a><span class="hs-comment">--</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- That is, we tried to convert something that is past the point in time</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- beyond which we lack information due to uncertainty about the next</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- hard fork.</span><span>
</span><a name="line-734"></a><span class="hs-comment">--</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- We record the condition we were looking for and the bounds on the summary.</span><span>
</span><a name="line-736"></a><span class="hs-keyword">data</span><span> </span><a name="PastHorizonException"><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier">PastHorizonException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PastHorizon"><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizon"><span class="hs-identifier">PastHorizon</span></a></a><span> </span><span class="hs-identifier hs-type">CallStack</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">]</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span>
</span><a name="line-739"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: reified queries

  NOTE. The lower bound of every era is inclusive, while the upper bound is
  really exclusive, making the upper bound of every era equal to the lower
  bound of the next.

  &gt;         era A         era B         era C
  &gt;        [.....) [...............) [..........)
  &gt; epoch         e                 e'
  &gt; slot          s                 s'
  &gt; time          t                 t'

  Now let's consider what happens when we do translations of the values at
  the boundary.

   1. Slot-to-epoch translation. Using era C, we get

      &gt; e' + ((s' - s') / epochSizeC) == e'

      Using era B (technically the wrong era to be using, since the upper bound
      is exclusive), we get

      &gt; e + ((s' - s) / epochSizeB)

      These are equal by (INV-1a).

   2. Epoch-to-slot translation. Using era C, we get

      &gt; s' + ((e' - e') * epochSizeC) == s'

      Using era B, we'd get

      &gt; s + ((e' - e) * epochSizeB

      These are equal by (INV-1b).

   3. Slot to time translation. Using era C, we get

      &gt; t' + ((s' - s') * slotLenC) == t'

      Using era C, we get

      &gt; t + ((s' - s) * slotLenB)

      These are equal by (INV-2b)

   4. Time to slot translation. Using era C, we get

      &gt; s' + ((t' - t') / slotLenC) == s'

      Using era B, we get

      &gt; s + ((t' - t) / slotLenB)

      These are equal by (INV-2a).

  This means that for values at that boundary, it does not matter if we use
  this era or the next era for the translation. However, this is only true for
  these 4 translations. If we are returning the era parameters directly, then
  of course we can't use the era parameters from the wrong era.

  There is however a benefit to using the current era: there might not /be/
  a next era, and so if we use the current era, we extend the period for which
  we do calculations just that tiny bit more. This might be important for
  ledger implementations. For example, suppose we want to know if a particular
  slot @s@ is far enough away from the next epoch boundary (e.g., to determine
  if an update proposal should take effect in this epoch or the next). One
  natural way to write this would be to translate @s@ to the corresponding
  epoch @e@, then translate @e + 1@ back to a slot @s'@, and check the
  distance @s' - s@. However, it is conceivable that the safe zone stops at
  that epoch boundary; if it does, this computation would result in a
  'PastHorizonException', even if a different way to write the same computation
  (translating @s + delta@ to an epoch number, and then comparing that to @e@)
  might succeed. Rather than imposing an unnecessary limitation on the ledger,
  we therefore treat the upper bound as inclusive, so that both ways to do the
  check would succeed.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-keyword">newtype</span><span> </span><a name="TimeInEra"><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier">TimeInEra</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="TimeInEra"><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier">TimeInEra</span></a></a><span>   </span><span class="hs-special">{</span><span> </span><a name="getTimeInEra"><a href="Ouroboros.Consensus.HardFork.History.html#getTimeInEra"><span class="hs-identifier">getTimeInEra</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-821"></a><span class="hs-keyword">newtype</span><span> </span><a name="TimeInSlot"><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier">TimeInSlot</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TimeInSlot"><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier">TimeInSlot</span></a></a><span>  </span><span class="hs-special">{</span><span> </span><a name="getTimeInSlot"><a href="Ouroboros.Consensus.HardFork.History.html#getTimeInSlot"><span class="hs-identifier">getTimeInSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-822"></a><span class="hs-keyword">newtype</span><span> </span><a name="SlotInEra"><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier">SlotInEra</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="SlotInEra"><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier">SlotInEra</span></a></a><span>   </span><span class="hs-special">{</span><span> </span><a name="getSlotInEra"><a href="Ouroboros.Consensus.HardFork.History.html#getSlotInEra"><span class="hs-identifier">getSlotInEra</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-823"></a><span class="hs-keyword">newtype</span><span> </span><a name="SlotInEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEpoch"><span class="hs-identifier">SlotInEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SlotInEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEpoch"><span class="hs-identifier">SlotInEpoch</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="getSlotInEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#getSlotInEpoch"><span class="hs-identifier">getSlotInEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-824"></a><span class="hs-keyword">newtype</span><span> </span><a name="EpochInEra"><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier">EpochInEra</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EpochInEra"><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier">EpochInEra</span></a></a><span>  </span><span class="hs-special">{</span><span> </span><a name="getEpochInEra"><a href="Ouroboros.Consensus.HardFork.History.html#getEpochInEra"><span class="hs-identifier">getEpochInEra</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span class="hs-comment">-- | Query</span><span>
</span><a name="line-827"></a><span class="hs-keyword">data</span><span> </span><a name="Qry"><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier">Qry</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator">*</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-828"></a><span>  </span><a name="QPure"><a href="Ouroboros.Consensus.HardFork.History.html#QPure"><span class="hs-identifier">QPure</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679362498"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362498"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-829"></a><span>  </span><a name="QBind"><a href="Ouroboros.Consensus.HardFork.History.html#QBind"><span class="hs-identifier">QBind</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362499"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362499"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362500"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362500"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span>  </span><span class="hs-comment">-- Convert from absolute to era-relative</span><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span>  </span><a name="QAbsToRelTime"><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelTime"><span class="hs-identifier">QAbsToRelTime</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-type">TimeInEra</span></a><span>
</span><a name="line-834"></a><span>  </span><a name="QAbsToRelSlot"><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelSlot"><span class="hs-identifier">QAbsToRelSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span>
</span><a name="line-835"></a><span>  </span><a name="QAbsToRelEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelEpoch"><span class="hs-identifier">QAbsToRelEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-type">EpochInEra</span></a><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span>  </span><span class="hs-comment">-- Convert from era-relative to absolute</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span>  </span><a name="QRelToAbsTime"><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsTime"><span class="hs-identifier">QRelToAbsTime</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-type">TimeInEra</span></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-identifier hs-type">UTCTime</span><span>
</span><a name="line-840"></a><span>  </span><a name="QRelToAbsSlot"><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsSlot"><span class="hs-identifier">QRelToAbsSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier hs-type">TimeInSlot</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-841"></a><span>  </span><a name="QRelToAbsEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsEpoch"><span class="hs-identifier">QRelToAbsEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-type">EpochInEra</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEpoch"><span class="hs-identifier hs-type">SlotInEpoch</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span>  </span><span class="hs-comment">-- Convert between relative values</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>  </span><a name="QRelTimeToSlot"><a href="Ouroboros.Consensus.HardFork.History.html#QRelTimeToSlot"><span class="hs-identifier">QRelTimeToSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-type">TimeInEra</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier hs-type">TimeInSlot</span></a><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>  </span><a name="QRelSlotToTime"><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToTime"><span class="hs-identifier">QRelSlotToTime</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-type">TimeInEra</span></a><span>
</span><a name="line-847"></a><span>  </span><a name="QRelSlotToEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToEpoch"><span class="hs-identifier">QRelSlotToEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-type">EpochInEra</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEpoch"><span class="hs-identifier hs-type">SlotInEpoch</span></a><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>  </span><a name="QRelEpochToSlot"><a href="Ouroboros.Consensus.HardFork.History.html#QRelEpochToSlot"><span class="hs-identifier">QRelEpochToSlot</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-type">EpochInEra</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-type">SlotInEra</span></a><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-comment">-- Get era parameters</span><span>
</span><a name="line-851"></a><span>  </span><span class="hs-comment">-- The arguments are used for bound checks</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>  </span><a name="QSlotLength"><a href="Ouroboros.Consensus.HardFork.History.html#QSlotLength"><span class="hs-identifier">QSlotLength</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SlotLength"><span class="hs-identifier hs-type">SlotLength</span></a><span>
</span><a name="line-854"></a><span>  </span><a name="QEpochSize"><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier">QEpochSize</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-type">EpochSize</span></a><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-857"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-860"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QPure"><span class="hs-identifier hs-var">QPure</span></a><span>
</span><a name="line-861"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-864"></a><span>  </span><a name="local-3458764513820541102"><span class="hs-identifier">return</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-865"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QBind"><span class="hs-identifier hs-var">QBind</span></a><span>
</span><a name="line-866"></a><span>
</span><a name="line-867"></a><span class="hs-comment">-- | Evaluate a query in an era</span><span>
</span><a name="line-868"></a><span class="hs-comment">--</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- Returns 'Nothing' if the query is out of bounds in this era.</span><span>
</span><a name="line-870"></a><span class="hs-identifier">evalQryInEra</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362554"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679362554"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-871"></a><a name="evalQryInEra"><a href="Ouroboros.Consensus.HardFork.History.html#evalQryInEra"><span class="hs-identifier">evalQryInEra</span></a></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-var">EraSummary</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362645"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-872"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-873"></a><span>    </span><a href="Ouroboros.Consensus.HardFork.History.html#EraParams"><span class="hs-identifier hs-var">EraParams</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362638"><span class="hs-identifier hs-var">eraParams</span></a><span>
</span><a name="line-874"></a><span>    </span><a name="local-6989586621679362642"><a href="#local-6989586621679362642"><span class="hs-identifier">slotLen</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getSlotLength</span><span> </span><a href="#local-6989586621679362640"><span class="hs-identifier hs-var">eraSlotLength</span></a><span>
</span><a name="line-875"></a><span>    </span><a name="local-6989586621679362643"><a href="#local-6989586621679362643"><span class="hs-identifier">epochSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unEpochSize</span><span>   </span><a href="#local-6989586621679362639"><span class="hs-identifier hs-var">eraEpochSize</span></a><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span>    </span><span class="hs-identifier">guardEnd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Bound"><span class="hs-identifier hs-type">Bound</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>    </span><a name="local-6989586621679362644"><a href="#local-6989586621679362644"><span class="hs-identifier">guardEnd</span></a></a><span> </span><a name="local-6989586621679362647"><a href="#local-6989586621679362647"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679362637"><span class="hs-identifier hs-var">eraEnd</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-880"></a><span>          </span><a href="Ouroboros.Consensus.HardFork.History.html#EraUnbounded"><span class="hs-identifier hs-var">EraUnbounded</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span>          </span><a href="Ouroboros.Consensus.HardFork.History.html#EraEnd"><span class="hs-identifier hs-var">EraEnd</span></a><span> </span><a name="local-6989586621679362648"><a href="#local-6989586621679362648"><span class="hs-identifier">b</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362647"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679362648"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362646"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679362646"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-884"></a><span>    </span><a name="local-6989586621679362645"><a href="#local-6989586621679362645"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QPure"><span class="hs-identifier hs-var">QPure</span></a><span> </span><a name="local-6989586621679362649"><a href="#local-6989586621679362649"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-885"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362649"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-886"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QBind"><span class="hs-identifier hs-var">QBind</span></a><span> </span><a name="local-6989586621679362650"><a href="#local-6989586621679362650"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679362651"><a href="#local-6989586621679362651"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-887"></a><span>        </span><a href="#local-6989586621679362645"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679362650"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679362645"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679362651"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span>    </span><span class="hs-comment">-- Convert absolute to relative</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-comment">-- The guards here justify the subtractions.</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelTime"><span class="hs-identifier hs-var">QAbsToRelTime</span></a><span> </span><a name="local-6989586621679362652"><a href="#local-6989586621679362652"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-894"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362652"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-var">TimeInEra</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362652"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">diffUTCTime</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-896"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelSlot"><span class="hs-identifier hs-var">QAbsToRelSlot</span></a><span> </span><a name="local-6989586621679362653"><a href="#local-6989586621679362653"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-897"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362653"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-var">SlotInEra</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#countSlots"><span class="hs-identifier hs-var">countSlots</span></a><span> </span><a href="#local-6989586621679362653"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelEpoch"><span class="hs-identifier hs-var">QAbsToRelEpoch</span></a><span> </span><a name="local-6989586621679362654"><a href="#local-6989586621679362654"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-900"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362654"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-901"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-var">EpochInEra</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#countEpochs"><span class="hs-identifier hs-var">countEpochs</span></a><span> </span><a href="#local-6989586621679362654"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span>    </span><span class="hs-comment">-- Convert relative to absolute</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-905"></a><span>    </span><span class="hs-comment">-- As justified by the proof above, the guards treat the upper bound</span><span>
</span><a name="line-906"></a><span>    </span><span class="hs-comment">-- as inclusive.</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsTime"><span class="hs-identifier hs-var">QRelToAbsTime</span></a><span> </span><a name="local-6989586621679362655"><a href="#local-6989586621679362655"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-909"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679362656"><a href="#local-6989586621679362656"><span class="hs-identifier">absTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getTimeInEra</span><span> </span><a href="#local-6989586621679362655"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addUTCTime</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span>
</span><a name="line-910"></a><span>        </span><a href="#local-6989586621679362644"><span class="hs-identifier hs-var">guardEnd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362657"><a href="#local-6989586621679362657"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362656"><span class="hs-identifier hs-var">absTime</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier">boundTime</span><span> </span><a href="#local-6989586621679362657"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-911"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362656"><span class="hs-identifier hs-var">absTime</span></a><span>
</span><a name="line-912"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsSlot"><span class="hs-identifier hs-var">QRelToAbsSlot</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679362658"><a href="#local-6989586621679362658"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679362659"><a href="#local-6989586621679362659"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-913"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679362660"><a href="#local-6989586621679362660"><span class="hs-identifier">absSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier hs-var">addSlots</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getSlotInEra</span><span> </span><a href="#local-6989586621679362658"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>        </span><a href="#local-6989586621679362644"><span class="hs-identifier hs-var">guardEnd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362661"><a href="#local-6989586621679362661"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362660"><span class="hs-identifier hs-var">absSlot</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span>  </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362661"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-915"></a><span>                        </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679362660"><span class="hs-identifier hs-var">absSlot</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362661"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">getTimeInSlot</span><span> </span><a href="#local-6989586621679362659"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362660"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-917"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsEpoch"><span class="hs-identifier hs-var">QRelToAbsEpoch</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679362662"><a href="#local-6989586621679362662"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679362663"><a href="#local-6989586621679362663"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-918"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679362664"><a href="#local-6989586621679362664"><span class="hs-identifier">absEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier hs-var">addEpochs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getEpochInEra</span><span> </span><a href="#local-6989586621679362662"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>        </span><a href="#local-6989586621679362644"><span class="hs-identifier hs-var">guardEnd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362665"><a href="#local-6989586621679362665"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362664"><span class="hs-identifier hs-var">absEpoch</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span>  </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362665"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-920"></a><span>                        </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679362664"><span class="hs-identifier hs-var">absEpoch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362665"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">getSlotInEpoch</span><span> </span><a href="#local-6989586621679362663"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-921"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362664"><span class="hs-identifier hs-var">absEpoch</span></a><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span>    </span><span class="hs-comment">-- Convert between relative values</span><span>
</span><a name="line-924"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-925"></a><span>    </span><span class="hs-comment">-- No guards necessary</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelTimeToSlot"><span class="hs-identifier hs-var">QRelTimeToSlot</span></a><span> </span><a name="local-6989586621679362666"><a href="#local-6989586621679362666"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-928"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">bimap</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-var">SlotInEra</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier hs-var">TimeInSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getTimeInEra</span><span> </span><a href="#local-6989586621679362666"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">divMod'</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679362642"><span class="hs-identifier hs-var">slotLen</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToTime"><span class="hs-identifier hs-var">QRelSlotToTime</span></a><span> </span><a name="local-6989586621679362667"><a href="#local-6989586621679362667"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-930"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInEra"><span class="hs-identifier hs-var">TimeInEra</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getSlotInEra</span><span> </span><a href="#local-6989586621679362667"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679362642"><span class="hs-identifier hs-var">slotLen</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToEpoch"><span class="hs-identifier hs-var">QRelSlotToEpoch</span></a><span> </span><a name="local-6989586621679362668"><a href="#local-6989586621679362668"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-932"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">bimap</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#EpochInEra"><span class="hs-identifier hs-var">EpochInEra</span></a><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEpoch"><span class="hs-identifier hs-var">SlotInEpoch</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">getSlotInEra</span><span> </span><a href="#local-6989586621679362668"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">divMod</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679362643"><span class="hs-identifier hs-var">epochSize</span></a><span>
</span><a name="line-933"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QRelEpochToSlot"><span class="hs-identifier hs-var">QRelEpochToSlot</span></a><span> </span><a name="local-6989586621679362669"><a href="#local-6989586621679362669"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-934"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#SlotInEra"><span class="hs-identifier hs-var">SlotInEra</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getEpochInEra</span><span> </span><a href="#local-6989586621679362669"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679362643"><span class="hs-identifier hs-var">epochSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span>    </span><span class="hs-comment">-- Get era parameters</span><span>
</span><a name="line-937"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-938"></a><span>    </span><span class="hs-comment">-- Here the upper bound must definitely be exclusive, or we'd return the</span><span>
</span><a name="line-939"></a><span>    </span><span class="hs-comment">-- era parameters from the wrong era.</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QSlotLength"><span class="hs-identifier hs-var">QSlotLength</span></a><span> </span><a name="local-6989586621679362670"><a href="#local-6989586621679362670"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-942"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362670"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span>
</span><a name="line-943"></a><span>        </span><a href="#local-6989586621679362644"><span class="hs-identifier hs-var">guardEnd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362671"><a href="#local-6989586621679362671"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362670"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">boundSlot</span><span> </span><a href="#local-6989586621679362671"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-944"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362640"><span class="hs-identifier hs-var">eraSlotLength</span></a><span>
</span><a name="line-945"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier hs-var">QEpochSize</span></a><span> </span><a name="local-6989586621679362672"><a href="#local-6989586621679362672"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-946"></a><span>        </span><span class="hs-identifier hs-var">guard</span><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362672"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362636"><span class="hs-identifier hs-var">eraStart</span></a><span>
</span><a name="line-947"></a><span>        </span><a href="#local-6989586621679362644"><span class="hs-identifier hs-var">guardEnd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362673"><a href="#local-6989586621679362673"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362672"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">boundEpoch</span><span> </span><a href="#local-6989586621679362673"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-948"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362639"><span class="hs-identifier hs-var">eraEpochSize</span></a><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Very thin layer for dealing with Queries
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span class="hs-identifier">runQuery</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362552"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362553"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span> </span><a href="#local-6989586621679362552"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-955"></a><a name="runQuery"><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier">runQuery</span></a></a><span> </span><a name="local-6989586621679362674"><a href="#local-6989586621679362674"><span class="hs-identifier">qry</span></a></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-var">Summary</span></a><span> </span><a name="local-6989586621679362675"><a href="#local-6989586621679362675"><span class="hs-identifier">summary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-956"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">asum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#evalQryInEra"><span class="hs-identifier hs-var">evalQryInEra</span></a><span> </span><a href="#local-6989586621679362674"><span class="hs-identifier hs-var">qry</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679362676"><span class="hs-identifier hs-var">eras</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-957"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679362677"><a href="#local-6989586621679362677"><span class="hs-identifier">answer</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679362677"><span class="hs-identifier hs-var">answer</span></a><span>
</span><a name="line-958"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizon"><span class="hs-identifier hs-var">PastHorizon</span></a><span> </span><span class="hs-identifier hs-var">callStack</span><span> </span><a href="#local-6989586621679362676"><span class="hs-identifier hs-var">eras</span></a><span>
</span><a name="line-959"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-960"></a><span>    </span><span class="hs-identifier">eras</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Ouroboros.Consensus.HardFork.History.html#EraSummary"><span class="hs-identifier hs-type">EraSummary</span></a><span class="hs-special">]</span><span>
</span><a name="line-961"></a><span>    </span><a name="local-6989586621679362676"><a href="#local-6989586621679362676"><span class="hs-identifier">eras</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679362675"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-962"></a><span>
</span><a name="line-963"></a><span class="hs-identifier">runQueryThrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasCallStack</span><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><a href="#local-6989586621679362549"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">)</span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362550"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362551"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362549"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679362550"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-964"></a><a name="runQueryThrow"><a href="Ouroboros.Consensus.HardFork.History.html#runQueryThrow"><span class="hs-identifier">runQueryThrow</span></a></a><span> </span><a name="local-6989586621679362678"><a href="#local-6989586621679362678"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier hs-var">runQuery</span></a><span> </span><a href="#local-6989586621679362678"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span class="hs-identifier">runQueryPure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362547"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362548"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362547"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-967"></a><a name="runQueryPure"><a href="Ouroboros.Consensus.HardFork.History.html#runQueryPure"><span class="hs-identifier">runQueryPure</span></a></a><span> </span><a name="local-6989586621679362679"><a href="#local-6989586621679362679"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier hs-var">runQuery</span></a><span> </span><a href="#local-6989586621679362679"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Conversion between wallclock and slots
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span class="hs-comment">-- | Translate 'UTCTime' to 'SlotNo'</span><span>
</span><a name="line-974"></a><span class="hs-comment">--</span><span>
</span><a name="line-975"></a><span class="hs-comment">-- Additionally returns the time spent and time left in this slot.</span><span>
</span><a name="line-976"></a><span class="hs-identifier">wallclockToSlot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NominalDiffTime</span><span class="hs-special">)</span><span>
</span><a name="line-977"></a><a name="wallclockToSlot"><a href="Ouroboros.Consensus.HardFork.History.html#wallclockToSlot"><span class="hs-identifier">wallclockToSlot</span></a></a><span> </span><a name="local-6989586621679362680"><a href="#local-6989586621679362680"><span class="hs-identifier">absTime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-978"></a><span>    </span><a name="local-6989586621679362681"><a href="#local-6989586621679362681"><span class="hs-identifier">relTime</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelTime"><span class="hs-identifier hs-var">QAbsToRelTime</span></a><span>  </span><a href="#local-6989586621679362680"><span class="hs-identifier hs-var">absTime</span></a><span>
</span><a name="line-979"></a><span>    </span><a name="local-6989586621679362682"><a href="#local-6989586621679362682"><span class="hs-identifier">relSlot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelTimeToSlot"><span class="hs-identifier hs-var">QRelTimeToSlot</span></a><span> </span><a href="#local-6989586621679362681"><span class="hs-identifier hs-var">relTime</span></a><span>
</span><a name="line-980"></a><span>    </span><a name="local-6989586621679362683"><a href="#local-6989586621679362683"><span class="hs-identifier">absSlot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsSlot"><span class="hs-identifier hs-var">QRelToAbsSlot</span></a><span>  </span><a href="#local-6989586621679362682"><span class="hs-identifier hs-var">relSlot</span></a><span>
</span><a name="line-981"></a><span>    </span><a name="local-6989586621679362684"><a href="#local-6989586621679362684"><span class="hs-identifier">slotLen</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QSlotLength"><span class="hs-identifier hs-var">QSlotLength</span></a><span>    </span><a href="#local-6989586621679362683"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-982"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679362685"><a href="#local-6989586621679362685"><span class="hs-identifier">timeInSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getTimeInSlot</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679362682"><span class="hs-identifier hs-var">relSlot</span></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-984"></a><span>        </span><a href="#local-6989586621679362683"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-985"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679362685"><span class="hs-identifier hs-var">timeInSlot</span></a><span>
</span><a name="line-986"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getSlotLength</span><span> </span><a href="#local-6989586621679362684"><span class="hs-identifier hs-var">slotLen</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679362685"><span class="hs-identifier hs-var">timeInSlot</span></a><span>
</span><a name="line-987"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>
</span><a name="line-989"></a><span class="hs-comment">-- | Translate 'SlotNo' to the 'UTCTime' at the start of that slot</span><span>
</span><a name="line-990"></a><span class="hs-comment">--</span><span>
</span><a name="line-991"></a><span class="hs-comment">-- Additionally returns the length of the slot.</span><span>
</span><a name="line-992"></a><span class="hs-identifier">slotToWallclock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.BlockchainTime.WallClock.Types.html#SlotLength"><span class="hs-identifier hs-type">SlotLength</span></a><span class="hs-special">)</span><span>
</span><a name="line-993"></a><a name="slotToWallclock"><a href="Ouroboros.Consensus.HardFork.History.html#slotToWallclock"><span class="hs-identifier">slotToWallclock</span></a></a><span> </span><a name="local-6989586621679362686"><a href="#local-6989586621679362686"><span class="hs-identifier">absSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-994"></a><span>    </span><a name="local-6989586621679362687"><a href="#local-6989586621679362687"><span class="hs-identifier">relSlot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelSlot"><span class="hs-identifier hs-var">QAbsToRelSlot</span></a><span>  </span><a href="#local-6989586621679362686"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-995"></a><span>    </span><a name="local-6989586621679362688"><a href="#local-6989586621679362688"><span class="hs-identifier">relTime</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToTime"><span class="hs-identifier hs-var">QRelSlotToTime</span></a><span> </span><a href="#local-6989586621679362687"><span class="hs-identifier hs-var">relSlot</span></a><span>
</span><a name="line-996"></a><span>    </span><a name="local-6989586621679362689"><a href="#local-6989586621679362689"><span class="hs-identifier">absTime</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsTime"><span class="hs-identifier hs-var">QRelToAbsTime</span></a><span>  </span><a href="#local-6989586621679362688"><span class="hs-identifier hs-var">relTime</span></a><span>
</span><a name="line-997"></a><span>    </span><a name="local-6989586621679362690"><a href="#local-6989586621679362690"><span class="hs-identifier">slotLen</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QSlotLength"><span class="hs-identifier hs-var">QSlotLength</span></a><span>    </span><a href="#local-6989586621679362686"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-998"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362689"><span class="hs-identifier hs-var">absTime</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679362690"><span class="hs-identifier hs-var">slotLen</span></a><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Conversion between slots and epochs

  The primed forms are the ones used in the 'EpochInfo' construction.
  Critically, they do not ask for any of the era parameters. This means that
  their valid range /includes/ the end bound.
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span class="hs-comment">-- | Convert 'SlotNo' to 'EpochNo' and the relative slot within the epoch</span><span>
</span><a name="line-1009"></a><span class="hs-identifier">slotToEpoch'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><a name="slotToEpoch%27"><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch%27"><span class="hs-identifier">slotToEpoch'</span></a></a><span> </span><a name="local-6989586621679362691"><a href="#local-6989586621679362691"><span class="hs-identifier">absSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1011"></a><span>    </span><a name="local-6989586621679362692"><a href="#local-6989586621679362692"><span class="hs-identifier">relSlot</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelSlot"><span class="hs-identifier hs-var">QAbsToRelSlot</span></a><span>   </span><a href="#local-6989586621679362691"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-1012"></a><span>    </span><a name="local-6989586621679362693"><a href="#local-6989586621679362693"><span class="hs-identifier">epochSlot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelSlotToEpoch"><span class="hs-identifier hs-var">QRelSlotToEpoch</span></a><span> </span><a href="#local-6989586621679362692"><span class="hs-identifier hs-var">relSlot</span></a><span>
</span><a name="line-1013"></a><span>    </span><a name="local-6989586621679362694"><a href="#local-6989586621679362694"><span class="hs-identifier">absEpoch</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsEpoch"><span class="hs-identifier hs-var">QRelToAbsEpoch</span></a><span>  </span><a href="#local-6989586621679362693"><span class="hs-identifier hs-var">epochSlot</span></a><span>
</span><a name="line-1014"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362694"><span class="hs-identifier hs-var">absEpoch</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">getSlotInEpoch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679362693"><span class="hs-identifier hs-var">epochSlot</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span class="hs-comment">-- | Translate 'SlotNo' to its corresponding 'EpochNo'</span><span>
</span><a name="line-1017"></a><span class="hs-comment">--</span><span>
</span><a name="line-1018"></a><span class="hs-comment">-- Additionally returns the relative slot within this epoch and how many</span><span>
</span><a name="line-1019"></a><span class="hs-comment">-- slots are left in this slot.</span><span>
</span><a name="line-1020"></a><span class="hs-identifier">slotToEpoch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><a name="slotToEpoch"><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch"><span class="hs-identifier">slotToEpoch</span></a></a><span> </span><a name="local-6989586621679362695"><a href="#local-6989586621679362695"><span class="hs-identifier">absSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1022"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679362696"><a href="#local-6989586621679362696"><span class="hs-identifier">absEpoch</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679362697"><a href="#local-6989586621679362697"><span class="hs-identifier">slotInEpoch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch%27"><span class="hs-identifier hs-var">slotToEpoch'</span></a><span> </span><a href="#local-6989586621679362695"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-1023"></a><span>    </span><a name="local-6989586621679362698"><a href="#local-6989586621679362698"><span class="hs-identifier">epochSize</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier hs-var">QEpochSize</span></a><span> </span><a href="#local-6989586621679362696"><span class="hs-identifier hs-var">absEpoch</span></a><span>
</span><a name="line-1024"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362696"><span class="hs-identifier hs-var">absEpoch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679362697"><span class="hs-identifier hs-var">slotInEpoch</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">unEpochSize</span><span> </span><a href="#local-6989586621679362698"><span class="hs-identifier hs-var">epochSize</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679362697"><span class="hs-identifier hs-var">slotInEpoch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span class="hs-identifier">epochToSlot'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-1027"></a><a name="epochToSlot%27"><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot%27"><span class="hs-identifier">epochToSlot'</span></a></a><span> </span><a name="local-6989586621679362699"><a href="#local-6989586621679362699"><span class="hs-identifier">absEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1028"></a><span>    </span><a name="local-6989586621679362700"><a href="#local-6989586621679362700"><span class="hs-identifier">relEpoch</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QAbsToRelEpoch"><span class="hs-identifier hs-var">QAbsToRelEpoch</span></a><span>  </span><a href="#local-6989586621679362699"><span class="hs-identifier hs-var">absEpoch</span></a><span>
</span><a name="line-1029"></a><span>    </span><a name="local-6989586621679362701"><a href="#local-6989586621679362701"><span class="hs-identifier">slotInEra</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelEpochToSlot"><span class="hs-identifier hs-var">QRelEpochToSlot</span></a><span> </span><a href="#local-6989586621679362700"><span class="hs-identifier hs-var">relEpoch</span></a><span>
</span><a name="line-1030"></a><span>    </span><a name="local-6989586621679362702"><a href="#local-6989586621679362702"><span class="hs-identifier">absSlot</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QRelToAbsSlot"><span class="hs-identifier hs-var">QRelToAbsSlot</span></a><span>   </span><span class="hs-special">(</span><a href="#local-6989586621679362701"><span class="hs-identifier hs-var">slotInEra</span></a><span class="hs-special">,</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#TimeInSlot"><span class="hs-identifier hs-var">TimeInSlot</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679362702"><span class="hs-identifier hs-var">absSlot</span></a><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span class="hs-comment">-- | Translate 'EpochNo' to the 'SlotNo' of the first slot in that epoch</span><span>
</span><a name="line-1034"></a><span class="hs-comment">--</span><span>
</span><a name="line-1035"></a><span class="hs-comment">-- Additionally returns the size of the epoch.</span><span>
</span><a name="line-1036"></a><span class="hs-identifier">epochToSlot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochSize"><span class="hs-identifier hs-type">EpochSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-1037"></a><a name="epochToSlot"><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot"><span class="hs-identifier">epochToSlot</span></a></a><span> </span><a name="local-6989586621679362703"><a href="#local-6989586621679362703"><span class="hs-identifier">absEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot%27"><span class="hs-identifier hs-var">epochToSlot'</span></a><span> </span><a href="#local-6989586621679362703"><span class="hs-identifier hs-var">absEpoch</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier hs-var">QEpochSize</span></a><span> </span><a href="#local-6989586621679362703"><span class="hs-identifier hs-var">absEpoch</span></a><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Caching the summary
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-1042"></a><span>
</span><a name="line-1043"></a><span class="hs-comment">-- | Stateful abstraction to execute queries</span><span>
</span><a name="line-1044"></a><span class="hs-keyword">data</span><span> </span><a name="RunWithCachedSummary"><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier">RunWithCachedSummary</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679362495"><a href="#local-6989586621679362495"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-operator">*</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679362496"><a href="#local-6989586621679362496"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RunWithCachedSummary"><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier">RunWithCachedSummary</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1045"></a><span>      </span><span class="hs-comment">-- | Run the specified query</span><span>
</span><a name="line-1046"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1047"></a><span>      </span><span class="hs-comment">-- If the query fails with a 'PastHorizonException', it will update its</span><span>
</span><a name="line-1048"></a><span>      </span><span class="hs-comment">-- internal state (compute a new summary) and try again. If that /still/</span><span>
</span><a name="line-1049"></a><span>      </span><span class="hs-comment">-- fails, the 'PastHorizonException' is returned.</span><span>
</span><a name="line-1050"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1051"></a><span>      </span><span class="hs-comment">-- See also 'cachedRunQueryThrow'.</span><span>
</span><a name="line-1052"></a><span>      </span><a name="cachedRunQuery"><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQuery"><span class="hs-identifier">cachedRunQuery</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679362497"><a href="#local-6989586621679362497"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362497"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1053"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362496"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span> </span><a href="#local-6989586621679362497"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1054"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span class="hs-comment">-- | Wrapper around 'cachedRunQuery' which throws the 'PastHorizonException'</span><span>
</span><a name="line-1057"></a><span class="hs-comment">--</span><span>
</span><a name="line-1058"></a><span class="hs-comment">-- This is useful for callers who know that their queries should not be past</span><span>
</span><a name="line-1059"></a><span class="hs-comment">-- the horizon (and it would be a bug if they were).</span><span>
</span><a name="line-1060"></a><span class="hs-identifier">cachedRunQueryThrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679362544"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362544"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier hs-type">RunWithCachedSummary</span></a><span> </span><a href="#local-6989586621679362545"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="#local-6989586621679362544"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362546"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362544"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679362546"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1062"></a><a name="cachedRunQueryThrow"><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQueryThrow"><span class="hs-identifier">cachedRunQueryThrow</span></a></a><span> </span><a name="local-6989586621679362704"><a href="#local-6989586621679362704"><span class="hs-identifier">run</span></a></a><span> </span><a name="local-6989586621679362705"><a href="#local-6989586621679362705"><span class="hs-identifier">qry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#throwM"><span class="hs-identifier hs-var">throwM</span></a><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier">cachedRunQuery</span><span> </span><a href="#local-6989586621679362704"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679362705"><span class="hs-identifier hs-var">qry</span></a><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-comment">-- | Construct 'RunWithCachedSummary' given action that computes the summary</span><span>
</span><a name="line-1065"></a><span class="hs-comment">--</span><span>
</span><a name="line-1066"></a><span class="hs-comment">-- Most use cases will probably construct this action from an action that reads</span><span>
</span><a name="line-1067"></a><span class="hs-comment">-- the ledger state and then computes the summary from that.</span><span>
</span><a name="line-1068"></a><span class="hs-identifier">runWithCachedSummary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679362542"><a href="#local-6989586621679362542"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679362543"><a href="#local-6989586621679362543"><span class="hs-identifier">xs</span></a></a><span class="hs-operator">.</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1069"></a><span>                     </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362543"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1070"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier hs-type">RunWithCachedSummary</span></a><span> </span><a href="#local-6989586621679362543"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><a name="runWithCachedSummary"><a href="Ouroboros.Consensus.HardFork.History.html#runWithCachedSummary"><span class="hs-identifier">runWithCachedSummary</span></a></a><span> </span><a name="local-6989586621679362706"><a href="#local-6989586621679362706"><span class="hs-identifier">getSummary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1072"></a><span>    </span><a name="local-6989586621679362714"><a href="#local-6989586621679362714"><span class="hs-identifier">initSummary</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#atomically"><span class="hs-identifier hs-var">atomically</span></a><span> </span><a href="#local-6989586621679362706"><span class="hs-identifier hs-var">getSummary</span></a><span>
</span><a name="line-1073"></a><span>    </span><a name="local-6989586621679362715"><a href="#local-6989586621679362715"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ouroboros.Consensus.Util.MonadSTM.NormalForm.html#newTVarM"><span class="hs-identifier hs-var">newTVarM</span></a><span> </span><a href="#local-6989586621679362714"><span class="hs-identifier hs-var">initSummary</span></a><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier hs-var">RunWithCachedSummary</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cachedRunQuery</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679362707"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679362715"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#StrictTVar"><span class="hs-identifier hs-type">StrictTVar</span></a><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362543"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1077"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362708"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizonException"><span class="hs-identifier hs-type">PastHorizonException</span></a><span> </span><a href="#local-6989586621679362708"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1078"></a><span>    </span><a name="local-6989586621679362707"><a href="#local-6989586621679362707"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679362709"><a href="#local-6989586621679362709"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621679362710"><a href="#local-6989586621679362710"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1079"></a><span>        </span><a name="local-6989586621679362711"><a href="#local-6989586621679362711"><span class="hs-identifier">summary</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#readTVar"><span class="hs-identifier hs-var">readTVar</span></a><span> </span><a href="#local-6989586621679362709"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1080"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier hs-var">runQuery</span></a><span> </span><a href="#local-6989586621679362710"><span class="hs-identifier hs-var">q</span></a><span> </span><a href="#local-6989586621679362711"><span class="hs-identifier hs-var">summary</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1081"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679362712"><a href="#local-6989586621679362712"><span class="hs-identifier">a</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679362712"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span>  </span><a href="Ouroboros.Consensus.HardFork.History.html#PastHorizon"><span class="hs-identifier hs-var">PastHorizon</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1083"></a><span>            </span><a name="local-6989586621679362713"><a href="#local-6989586621679362713"><span class="hs-identifier">summary'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679362706"><span class="hs-identifier hs-var">getSummary</span></a><span>
</span><a name="line-1084"></a><span>            </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.Strict.html#writeTVar"><span class="hs-identifier hs-var">writeTVar</span></a><span> </span><a href="#local-6989586621679362709"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679362713"><span class="hs-identifier hs-var">summary'</span></a><span>
</span><a name="line-1085"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQuery"><span class="hs-identifier hs-var">runQuery</span></a><span> </span><a href="#local-6989586621679362710"><span class="hs-identifier hs-var">q</span></a><span> </span><a href="#local-6989586621679362713"><span class="hs-identifier hs-var">summary'</span></a><span>
</span><a name="line-1086"></a><span>
</span><a name="line-1087"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Translation to EpochInfo
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-1090"></a><span>
</span><a name="line-1091"></a><span class="hs-comment">-- | Construct 'EpochInfo' from a function that returns the hard fork summary</span><span>
</span><a name="line-1092"></a><span class="hs-comment">--</span><span>
</span><a name="line-1093"></a><span class="hs-comment">-- When a particular request fails with a 'PastHorizon' error, we ask for an</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- updated summary, in the hope that the ledger state has advanced. If the query</span><span>
</span><a name="line-1095"></a><span class="hs-comment">-- /still/ fails with that updated summary, the error is thrown as an exception.</span><span>
</span><a name="line-1096"></a><span class="hs-identifier">summaryToEpochInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679362540"><a href="#local-6989586621679362540"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679362541"><a href="#local-6989586621679362541"><span class="hs-identifier">xs</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#MonadSTM"><span class="hs-identifier hs-type">MonadSTM</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadThrow.html#MonadThrow"><span class="hs-identifier hs-type">MonadThrow</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362541"><span class="hs-identifier hs-type">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html#EpochInfo"><span class="hs-identifier hs-type">EpochInfo</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1098"></a><a name="summaryToEpochInfo"><a href="Ouroboros.Consensus.HardFork.History.html#summaryToEpochInfo"><span class="hs-identifier">summaryToEpochInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1099"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679362716"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runWithCachedSummary"><span class="hs-identifier hs-var">runWithCachedSummary</span></a><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1101"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#RunWithCachedSummary"><span class="hs-identifier hs-type">RunWithCachedSummary</span></a><span> </span><a href="#local-6989586621679362541"><span class="hs-identifier hs-type">xs</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html#EpochInfo"><span class="hs-identifier hs-type">EpochInfo</span></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/io-sim-classes-0.1.0.0/noopt/doc/html/io-sim-classes/src/Control.Monad.Class.MonadSTM.html#STM"><span class="hs-identifier hs-type">STM</span></a><span> </span><a href="#local-6989586621679362540"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1102"></a><span>    </span><a name="local-6989586621679362716"><a href="#local-6989586621679362716"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679362717"><a href="#local-6989586621679362717"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html#EpochInfo"><span class="hs-identifier hs-var">EpochInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1103"></a><span>          </span><span class="hs-identifier">epochInfoSize_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362723"><a href="#local-6989586621679362723"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQueryThrow"><span class="hs-identifier hs-var">cachedRunQueryThrow</span></a><span> </span><a href="#local-6989586621679362717"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier hs-var">QEpochSize</span></a><span>   </span><a href="#local-6989586621679362723"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1104"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">epochInfoFirst_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362724"><a href="#local-6989586621679362724"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQueryThrow"><span class="hs-identifier hs-var">cachedRunQueryThrow</span></a><span> </span><a href="#local-6989586621679362717"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot%27"><span class="hs-identifier hs-var">epochToSlot'</span></a><span> </span><a href="#local-6989586621679362724"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1105"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">epochInfoEpoch_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362725"><a href="#local-6989586621679362725"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#cachedRunQueryThrow"><span class="hs-identifier hs-var">cachedRunQueryThrow</span></a><span> </span><a href="#local-6989586621679362717"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch%27"><span class="hs-identifier hs-var">slotToEpoch'</span></a><span> </span><a href="#local-6989586621679362725"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1106"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1107"></a><span>
</span><a name="line-1108"></a><span class="hs-comment">-- | Construct an 'EpochInfo' for a /snapshot/ of the ledger state</span><span>
</span><a name="line-1109"></a><span class="hs-comment">--</span><span>
</span><a name="line-1110"></a><span class="hs-comment">-- When a particular request fails with a 'PastHorizon' error, we throw the</span><span>
</span><a name="line-1111"></a><span class="hs-comment">-- error as a /pure/ exception. Such an exception would indicate a bug.</span><span>
</span><a name="line-1112"></a><span class="hs-identifier">snapshotEpochInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679362539"><a href="#local-6989586621679362539"><span class="hs-identifier">xs</span></a></a><span class="hs-operator">.</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Summary"><span class="hs-identifier hs-type">Summary</span></a><span> </span><a href="#local-6989586621679362539"><span class="hs-identifier hs-type">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html#EpochInfo"><span class="hs-identifier hs-type">EpochInfo</span></a><span> </span><span class="hs-identifier hs-type">Identity</span><span>
</span><a name="line-1113"></a><a name="snapshotEpochInfo"><a href="Ouroboros.Consensus.HardFork.History.html#snapshotEpochInfo"><span class="hs-identifier">snapshotEpochInfo</span></a></a><span> </span><a name="local-6989586621679362726"><a href="#local-6989586621679362726"><span class="hs-identifier">summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.EpochInfo.API.html#EpochInfo"><span class="hs-identifier hs-var">EpochInfo</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1114"></a><span>      </span><span class="hs-identifier">epochInfoSize_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362729"><a href="#local-6989586621679362729"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362727"><span class="hs-identifier hs-var">runQueryPure'</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#QEpochSize"><span class="hs-identifier hs-var">QEpochSize</span></a><span>   </span><a href="#local-6989586621679362729"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">epochInfoFirst_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362730"><a href="#local-6989586621679362730"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362727"><span class="hs-identifier hs-var">runQueryPure'</span></a><span> </span><span class="hs-special">(</span><a href="Ouroboros.Consensus.HardFork.History.html#epochToSlot%27"><span class="hs-identifier hs-var">epochToSlot'</span></a><span> </span><a href="#local-6989586621679362730"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1116"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">epochInfoEpoch_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679362731"><a href="#local-6989586621679362731"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679362727"><span class="hs-identifier hs-var">runQueryPure'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#slotToEpoch%27"><span class="hs-identifier hs-var">slotToEpoch'</span></a><span> </span><a href="#local-6989586621679362731"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1117"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1118"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1119"></a><span>    </span><span class="hs-identifier">runQueryPure'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#Qry"><span class="hs-identifier hs-type">Qry</span></a><span> </span><a href="#local-6989586621679362728"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Identity</span><span> </span><a href="#local-6989586621679362728"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1120"></a><span>    </span><a name="local-6989586621679362727"><a href="#local-6989586621679362727"><span class="hs-identifier">runQueryPure'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Identity</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Ouroboros.Consensus.HardFork.History.html#runQueryPure"><span class="hs-identifier hs-var">runQueryPure</span></a><span> </span><a href="#local-6989586621679362726"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Auxiliary
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-1125"></a><span>
</span><a name="line-1126"></a><span class="hs-identifier">addSlots</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span>
</span><a name="line-1127"></a><a name="addSlots"><a href="Ouroboros.Consensus.HardFork.History.html#addSlots"><span class="hs-identifier">addSlots</span></a></a><span>  </span><a name="local-6989586621679362732"><a href="#local-6989586621679362732"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span>  </span><a name="local-6989586621679362733"><a href="#local-6989586621679362733"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621679362733"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679362732"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1128"></a><span>
</span><a name="line-1129"></a><span class="hs-identifier">addEpochs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span>
</span><a name="line-1130"></a><a name="addEpochs"><a href="Ouroboros.Consensus.HardFork.History.html#addEpochs"><span class="hs-identifier">addEpochs</span></a></a><span> </span><a name="local-6989586621679362734"><a href="#local-6989586621679362734"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><a name="local-6989586621679362735"><a href="#local-6989586621679362735"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362735"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679362734"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1131"></a><span>
</span><a name="line-1132"></a><span class="hs-comment">-- | @countSlots to fr@ counts the slots from @fr@ to @to@ (@to &gt;= fr@)</span><span>
</span><a name="line-1133"></a><span class="hs-identifier">countSlots</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-type">SlotNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-1134"></a><a name="countSlots"><a href="Ouroboros.Consensus.HardFork.History.html#countSlots"><span class="hs-identifier">countSlots</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span> </span><a name="local-6989586621679362736"><a href="#local-6989586621679362736"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#SlotNo"><span class="hs-identifier hs-var">SlotNo</span></a><span> </span><a name="local-6989586621679362737"><a href="#local-6989586621679362737"><span class="hs-identifier">fr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362736"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679362737"><span class="hs-identifier hs-var">fr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362736"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679362737"><span class="hs-identifier hs-var">fr</span></a><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span class="hs-comment">-- | @countEpochs to fr@ counts the epochs from @fr@ to @to@ (@to &gt;= fr@)</span><span>
</span><a name="line-1137"></a><span class="hs-identifier">countEpochs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-type">EpochNo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-1138"></a><a name="countEpochs"><a href="Ouroboros.Consensus.HardFork.History.html#countEpochs"><span class="hs-identifier">countEpochs</span></a></a><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><a name="local-6989586621679362738"><a href="#local-6989586621679362738"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/cardano-slotting-0.1.0.0/noopt/doc/html/cardano-slotting/src/Cardano.Slotting.Slot.html#EpochNo"><span class="hs-identifier hs-var">EpochNo</span></a><span> </span><a name="local-6989586621679362739"><a href="#local-6989586621679362739"><span class="hs-identifier">fr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679362738"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679362739"><span class="hs-identifier hs-var">fr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679362738"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679362739"><span class="hs-identifier hs-var">fr</span></a><span>
</span><a name="line-1139"></a></pre></body></html>